<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743774193></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="Subqueries let you form complex requests and allow you to process more data in with a single query"><meta property="og:url" content="http://localhost/3.12/aql/fundamentals/subqueries/"><meta property="og:title" content="Combining queries with subqueries in AQL"><meta property="og:type" content="website"><meta property="og:description" content="Subqueries let you form complex requests and allow you to process more data in with a single query"><meta name=docsearch:version content="3.12"><title>Combining queries with subqueries in AQL | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743774193 defer></script>
<script src=/js/featherlight.min.js?1743774193 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743774193 defer></script>
<script src=/js/theme.js?1743774193 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.12"><a itemprop=item class=link href=/3.12/><span itemprop=name class=breadcrumb-entry>3.12.4</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.12/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Fundamentals"><a itemprop=item class=link href=/3.12/aql/fundamentals/><span itemprop=name class=breadcrumb-entry>Fundamentals</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Subqueries"><a itemprop=item class=link href=/3.12/aql/fundamentals/subqueries/><span itemprop=name class=breadcrumb-entry>Subqueries</span></a></li></ol></nav><article class=default><hgroup><h1>Combining queries with subqueries in AQL</h1><p class=lead>Subqueries let you form complex requests and allow you to process more data in with a single query</p></hgroup><h2 id=how-to-use-subqueries>How to use subqueries <a href=/3.12/aql/fundamentals/subqueries/#how-to-use-subqueries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Wherever an expression is allowed in AQL, a subquery can be placed. A subquery
is a query part that can introduce its own local variables without affecting
variables and values in its outer scope(s).</p><p>It is required that subqueries be put inside parentheses <code>(</code> and <code>)</code> to
explicitly mark their start and end points:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>p</span> <span class=kr>IN</span> <span class=n>persons</span>
</span></span><span class=line><span class=cl>  <span class=kd>LET</span> <span class=n>recommendations</span> <span class=o>=</span> <span class=p>(</span> <span class=c1>// subquery start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>FOR</span> <span class=n>r</span> <span class=kr>IN</span> <span class=n>recommendations</span>
</span></span><span class=line><span class=cl>      <span class=kr>FILTER</span> <span class=n>p</span><span class=p>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>r</span><span class=p>.</span><span class=n>personId</span>
</span></span><span class=line><span class=cl>      <span class=kr>SORT</span> <span class=n>p</span><span class=p>.</span><span class=n>rank</span> <span class=kr>DESC</span>
</span></span><span class=line><span class=cl>      <span class=kr>LIMIT</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>      <span class=kr>RETURN</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=c1>// subquery end
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>RETURN</span> <span class=p>{</span> <span class=n>person</span> <span class=o>:</span> <span class=n>p</span><span class=p>,</span> <span class=n>recommendations</span> <span class=o>:</span> <span class=n>recommendations</span> <span class=p>}</span></span></span></code></pre></div><p>A subquery&rsquo;s result can be assigned to a variable with
<a href=/3.12/aql/high-level-operations/let/ class=link><code>LET</code></a> as shown above, so that it can be referenced
multiple times or just to improve the query readability.</p><p>Function calls also use parentheses and AQL allows you to omit an extra pair if
you want to use a subquery as sole argument for a function, e.g.
<code>MAX(&lt;subquery>)</code> instead of <code>MAX((&lt;subquery>))</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>p</span> <span class=kr>IN</span> <span class=n>persons</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>city</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=n>city</span> <span class=kr>INTO</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>city</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>numPersons</span> <span class=o>:</span> <span class=nf>LENGTH</span><span class=p>(</span><span class=n>g</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>maxRating</span><span class=o>:</span> <span class=nf>MAX</span><span class=p>(</span> <span class=c1>// subquery start
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>FOR</span> <span class=n>r</span> <span class=kr>IN</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>      <span class=kr>RETURN</span> <span class=n>r</span><span class=p>.</span><span class=n>p</span><span class=p>.</span><span class=n>rating</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=c1>// subquery end
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span></span></span></code></pre></div><p>The extra wrapping is required if there is more than one function argument,
however, e.g. <code>NOT_NULL((RETURN "ok"), "fallback")</code>.</p><p>Subqueries may also include other subqueries.</p><h2 id=subquery-results-and-unwinding>Subquery results and unwinding <a href=/3.12/aql/fundamentals/subqueries/#subquery-results-and-unwinding class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Subqueries always return a result <strong>array</strong>, even if there is only
a single return value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=p>(</span> <span class=kr>RETURN</span> <span class=mi>1</span> <span class=p>)</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span> <span class=p>[</span> <span class=mi>1</span> <span class=p>]</span> <span class=p>]</span>
</span></span></code></pre></div><p>To avoid such a nested data structure, <a href=/3.12/aql/functions/array/#first class=link><code>FIRST()</code></a>
can be used for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=nf>FIRST</span><span class=p>(</span> <span class=kr>RETURN</span> <span class=mi>1</span> <span class=p>)</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span> <span class=mi>1</span> <span class=p>]</span>
</span></span></code></pre></div><p>To unwind the result array of a subquery so that each element is returned as
top-level element in the overall query result, you can use a <code>FOR</code> loop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>elem</span> <span class=kr>IN</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>3</span><span class=p>)</span> <span class=c1>// [1,2,3]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>RETURN</span> <span class=n>elem</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>Without unwinding, the query would be <code>RETURN (RETURN 1..3)</code> and the result
a nested array <code>[ [ 1, 2, 3 ] ]</code> with a single top-level element.</p><h2 id=evaluation-of-subqueries>Evaluation of subqueries <a href=/3.12/aql/fundamentals/subqueries/#evaluation-of-subqueries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><div class=tab-panel><div class=tab-content><div class=tab-nav><button data-tab-group=short-circuiting-subqueries data-tab-item="From v3.12.1 onward" class="tab-nav-button selected" onclick='switchTab("short-circuiting-subqueries","From v3.12.1 onward",event)'>
<span>From v3.12.1 onward</span></button>
<button data-tab-group=short-circuiting-subqueries data-tab-item="Up to v3.12.0" class=tab-nav-button onclick='switchTab("short-circuiting-subqueries","Up to v3.12.0",event)'>
<span>Up to v3.12.0</span></button></div><div data-tab-item="From v3.12.1 onward" data-tab-group=short-circuiting-subqueries class="tab-item
selected"><p>Subqueries that are used inside expressions are pulled out of these
expressions and conditionally executed beforehand. The effective behavior is
short-circuiting evaluation. An example is the
<a href=/3.12/aql/operators/#ternary-operator class=link>ternary operator</a>.</p><p>Consider the following query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=nf>RAND</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=o>?</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=mi>1</span><span class=p>)</span> <span class=o>:</span> <span class=mi>0</span></span></span></code></pre></div><p>It get transformed into something more like this, with the calculation of the
subquery happening before the evaluation of the condition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>temp1</span> <span class=o>=</span> <span class=nf>RAND</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>temp2</span> <span class=o>=</span> <span class=p>(</span><span class=kr>FILTER</span> <span class=n>temp1</span> <span class=kr>RETURN</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>temp1</span> <span class=o>?</span> <span class=n>temp2</span> <span class=o>:</span> <span class=mi>0</span></span></span></code></pre></div><p>The condition is evaluated separately and stored in a variable, then the
subquery is executed conditionally using a <code>FILTER</code> operation. Finally, the
ternary operator reuses the result of the evaluated condition to determine which
value to return.</p><p>The short-circuiting behavior allows you to write queries like the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>maybe</span> <span class=o>=</span> <span class=nf>DOCUMENT</span><span class=p>(</span><span class=s2>&#34;coll/does_not_exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>dependent</span> <span class=o>=</span> <span class=n>maybe</span> <span class=o>?</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>FOR</span> <span class=n>attr</span> <span class=kr>IN</span> <span class=nf>ATTRIBUTES</span><span class=p>(</span><span class=n>maybe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>RETURN</span> <span class=n>attr</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>:</span> <span class=s2>&#34;document not found&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>dependent</span></span></span></code></pre></div><p>The <code>maybe</code> variable can be <code>null</code>, which cannot be iterated over with <code>FOR</code> and
calling <code>ATTRIBUTES()</code> with <code>null</code> as argument would raise a query warning.
However, the subquery is only executed if <code>DOCUMENT()</code> found a document, so this
query works without issues.</p><p>Similarly, when you use subqueries as sub-expressions that are combined with
logical <code>AND</code> or <code>OR</code>, the subqueries are only executed if the outcome is yet
to be determined:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=kc>false</span> <span class=kr>AND</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=nf>ASSERT</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;executed&#34;</span><span class=p>))</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=kc>true</span> <span class=kr>OR</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=nf>ASSERT</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;executed&#34;</span><span class=p>))</span></span></span></code></pre></div><p>If the first operand of a logical <code>AND</code> is <code>false</code>, the overall result is
<code>false</code> regardless of the second operand. If the first operand of a logical <code>OR</code>
is <code>true</code>, the overall result is <code>true</code> regardless of the second operand.
As the outcome is already determined, there is no need to execute the subqueries
in these cases.</p></div><div data-tab-item="Up to v3.12.0" data-tab-group=short-circuiting-subqueries class=tab-item><p>Subqueries that are used inside expressions are pulled out of these
expressions and executed beforehand. That means that subqueries do not
participate in lazy evaluation of operands, for example in the
<a href=/3.12/aql/operators/#ternary-operator class=link>ternary operator</a>.</p><p>Consider the following query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=nf>RAND</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=o>?</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=mi>1</span><span class=p>)</span> <span class=o>:</span> <span class=mi>0</span></span></span></code></pre></div><p>It get transformed into something more like this, with the calculation of the
subquery happening before the evaluation of the condition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>temp1</span> <span class=o>=</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>temp2</span> <span class=o>=</span> <span class=nf>RAND</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=o>?</span> <span class=n>temp1</span> <span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>temp2</span></span></span></code></pre></div><p>The subquery is executed regardless of the condition. In other words, there is
no short-circuiting that would avoid the subquery from running in the case that
the condition evaluates to <code>false</code>. You may need to take this into account to
avoid query errors like</p><blockquote><p>Query: AQL: collection or array expected as operand to FOR loop; you provided
a value of type &rsquo;null&rsquo; (while executing)</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>maybe</span> <span class=o>=</span> <span class=nf>DOCUMENT</span><span class=p>(</span><span class=s2>&#34;coll/does_not_exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>dependent</span> <span class=o>=</span> <span class=n>maybe</span> <span class=o>?</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>FOR</span> <span class=n>attr</span> <span class=kr>IN</span> <span class=nf>ATTRIBUTES</span><span class=p>(</span><span class=n>maybe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>RETURN</span> <span class=n>attr</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>:</span> <span class=s2>&#34;document not found&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>dependent</span></span></span></code></pre></div><p>The problem is that the subquery is executed under all circumstances, despite
the check whether <code>DOCUMENT()</code> found a document or not. It does not take into
account that <code>maybe</code> can be <code>null</code>, which cannot be iterated over with <code>FOR</code>.
A possible solution is to fall back to an empty array in the subquery to
effectively prevent the loop body from being run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>maybe</span> <span class=o>=</span> <span class=nf>DOCUMENT</span><span class=p>(</span><span class=s2>&#34;coll/does_not_exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>dependent</span> <span class=o>=</span> <span class=n>maybe</span> <span class=o>?</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>FOR</span> <span class=n>attr</span> <span class=kr>IN</span> <span class=nf>NOT_NULL</span><span class=p>(</span><span class=nf>ATTRIBUTES</span><span class=p>(</span><span class=n>maybe</span> <span class=o>||</span> <span class=p>{}),</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=kr>RETURN</span> <span class=n>attr</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>:</span> <span class=s2>&#34;document not found&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>dependent</span></span></span></code></pre></div><p>The additional fallback <code>maybe || {}</code> prevents a query warning</p><blockquote><p>invalid argument type in call to function &lsquo;ATTRIBUTES()&rsquo;</p></blockquote><p>that originates from a <code>null</code> value getting passed to the <code>ATTRIBUTES()</code>
function that expects an object.</p><p>Similarly, when you use subqueries as sub-expressions that are combined with
logical <code>AND</code> or <code>OR</code>, the subqueries are always executed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=kc>false</span> <span class=kr>AND</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=nf>ASSERT</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;executed&#34;</span><span class=p>))</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=kc>true</span> <span class=kr>OR</span> <span class=p>(</span><span class=kr>RETURN</span> <span class=nf>ASSERT</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;executed&#34;</span><span class=p>))</span></span></span></code></pre></div><p>If the first operand of a logical <code>AND</code> is <code>false</code>, the overall result is
<code>false</code> regardless of the second operand. If the first operand of a logical <code>OR</code>
is <code>true</code>, the overall result is <code>true</code> regardless of the second operand.
However, the subqueries are run nonetheless, causing both example queries to fail.</p><p>You can prevent the subqueries from executing by prepending a <code>FILTER</code> operation
with the value of the logical operator&rsquo;s first operand and negating it in case
of an <code>OR</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>cond</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>cond</span> <span class=kr>AND</span> <span class=p>(</span><span class=kr>FILTER</span> <span class=n>cond</span> <span class=kr>RETURN</span> <span class=nf>ASSERT</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;executed&#34;</span><span class=p>))</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>cond</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>cond</span> <span class=kr>OR</span> <span class=p>(</span><span class=kr>FILTER</span> <span class=o>!</span><span class=n>cond</span> <span class=kr>RETURN</span> <span class=nf>ASSERT</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;executed&#34;</span><span class=p>))</span></span></span></code></pre></div></div></div></div><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.12/aql/fundamentals/accessing-data-from-collections/><i class="fas fa-chevron-left fa-fw"></i><p>Accessing data from collections</p></a></span><span class=next><a class="nav nav-next link" href=/3.12/aql/fundamentals/query-results/><p>Query Results</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.12/aql/fundamentals/subqueries.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#how-to-use-subqueries>How to use subqueries</a></div><div class=level-2><a href=#subquery-results-and-unwinding>Subquery results and unwinding</a></div><div class=level-2><a href=#evaluation-of-subqueries>Evaluation of subqueries</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743775370></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="AQL provides an optional query results cache in single server deployments"><meta property="og:url" content="http://localhost/3.12/aql/execution-and-performance/caching-query-results/"><meta property="og:title" content="The AQL query results cache"><meta property="og:type" content="website"><meta property="og:description" content="AQL provides an optional query results cache in single server deployments"><meta name=docsearch:version content="3.12"><title>The AQL query results cache | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743775370 defer></script>
<script src=/js/featherlight.min.js?1743775370 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743775370 defer></script>
<script src=/js/theme.js?1743775370 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.12"><a itemprop=item class=link href=/3.12/><span itemprop=name class=breadcrumb-entry>3.12.4</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.12/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Execution and Performance"><a itemprop=item class=link href=/3.12/aql/execution-and-performance/><span itemprop=name class=breadcrumb-entry>Execution and Performance</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Caching query results"><a itemprop=item class=link href=/3.12/aql/execution-and-performance/caching-query-results/><span itemprop=name class=breadcrumb-entry>Caching query results</span></a></li></ol></nav><article class=default><hgroup><h1>The AQL query results cache</h1><p class=lead>AQL provides an optional query results cache in single server deployments</p></hgroup><p>The purpose of the query results cache is to avoid repeated calculation of the same
query results. It is useful if data-reading queries repeat a lot and there are
not many write queries.</p><p>The query results cache is transparent so users do not need to manually invalidate
results in it if underlying collection data are modified.</p><div class="box notices cstyle info"><div class=box-content-container><div class=box-content><i class="fas fa-info-circle"></i><div class=box-text>The AQL query results cache is only available for single servers, i.e. servers that
are not part of a cluster setup.</div></div></div></div><h2 id=modes>Modes <a href=/3.12/aql/execution-and-performance/caching-query-results/#modes class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The cache can be operated in the following modes:</p><ul><li><code>off</code>: The cache is disabled. No query results are stored.</li><li><code>on</code>: The cache stores the results of all AQL queries unless the <code>cache</code>
query option is set to <code>false</code>.</li><li><code>demand</code>: The cache stores the results of AQL queries that have the
<code>cache</code> query option set to <code>true</code> but ignores all others.</li></ul><p>The mode can be set at server startup as well as at runtime, see
<a href=#global-configuration class=link>Global configuration</a>.</p><h2 id=query-eligibility>Query eligibility <a href=/3.12/aql/execution-and-performance/caching-query-results/#query-eligibility class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The query results cache considers two queries identical if they have exactly the
same query string and the same bind variables. Any deviation in terms of whitespace,
capitalization etc. is considered a difference. The query string is hashed
and used as the cache lookup key. If a query uses bind parameters, these are also
hashed and used as part of the cache lookup key.</p><p>Even if the query strings of two queries are identical, the query results cache
treats them as different queries if they have different bind parameter
values. Other components that become part of a query&rsquo;s cache key are the
<code>count</code>, <code>fullCount</code>, and <code>optimizer</code> attributes.</p><p>If the cache is enabled, it is checked whether it has a result ready for a
particular query at the very start of processing the query request. If this is
the case, the query result is served directly from the cache, which is normally
very efficient. If the query cannot be found in the cache, it is executed
as usual.</p><p>If the query is eligible for caching and the cache is enabled, the query
result is stored in the query results cache so it can be used for subsequent
executions of the same query.</p><p>A query is eligible for caching only if all of the following conditions are met:</p><ul><li>The server the query executes on is a single server (i.e. not part of a cluster).</li><li>The query is a read-only query and does not modify data in any collection.</li><li>No warnings were produced while executing the query.</li><li>The query is deterministic and only uses deterministic functions whose results
are marked as cacheable.</li><li>The size of the query result does not exceed the cache&rsquo;s configured maximal
size for individual cache results or cumulated results.</li><li>The query is not executed using a streaming cursor (<code>"stream": true</code> query option).</li></ul><p>The usage of non-deterministic functions leads to a query not being cacheable.
This is intentional to avoid caching of function results which should rather
be calculated on each invocation of the query (e.g. <code>RAND()</code> or <code>DATE_NOW()</code>).</p><p>The query results cache considers all user-defined AQL functions to be non-deterministic
as it has no insight into these functions.</p><h2 id=cache-invalidation>Cache invalidation <a href=/3.12/aql/execution-and-performance/caching-query-results/#cache-invalidation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The cached results are fully or partially invalidated automatically if
queries modify the data of collections that were used during the computation of
the cached query results. This is to protect users from getting stale results
from the query results cache.</p><p>This also means that if the cache is turned on, then there is an additional
cache invalidation check for each data-modification operation (e.g. insert, update,
remove, truncate operations as well as AQL data-modification queries).</p><p><strong>Example</strong></p><p>If the result of the following query is present in the query results cache,
then either modifying data in the <code>users</code> or <code>organizations</code> collection
removes the already computed result from the cache:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>user</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FOR</span> <span class=n>organization</span> <span class=kr>IN</span> <span class=n>organizations</span>
</span></span><span class=line><span class=cl>    <span class=kr>FILTER</span> <span class=n>user</span><span class=p>.</span><span class=n>organization</span> <span class=o>==</span> <span class=n>organization</span><span class=p>.</span><span class=n>_key</span>
</span></span><span class=line><span class=cl>    <span class=kr>RETURN</span> <span class=p>{</span> <span class=n>user</span><span class=o>:</span> <span class=n>user</span><span class=p>,</span> <span class=n>organization</span><span class=o>:</span> <span class=n>organization</span> <span class=p>}</span></span></span></code></pre></div><p>Modifying data in other unrelated collections does not lead to this
query result being removed from the cache.</p><h2 id=performance-considerations>Performance considerations <a href=/3.12/aql/execution-and-performance/caching-query-results/#performance-considerations class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The query results cache is organized as a hash table, so looking up whether a query result
is present in the cache is fast. Still, the query string and the bind
parameter used in the query need to be hashed. This is a slight overhead that
is not present if the cache is disabled or a query is marked as not cacheable.</p><p>Additionally, storing query results in the cache and fetching results from the
cache requires locking via a read/write lock. While many thread can read in parallel from
the cache, there can only be a single modifying thread at any given time. Modifications
of the query cache contents are required when a query result is stored in the cache
or during cache invalidation after data-modification operations. Cache invalidation
requires time proportional to the number of cached items that need to be invalidated.</p><p>There may be workloads in which enabling the query results cache leads to a performance
degradation. It is not recommended to turn the query results cache on in workloads that only
modify data, or that modify data more often than reading it. Enabling the cache
also provides no benefit if queries are very diverse and do not repeat often.
In read-only or read-mostly workloads, the cache is beneficial if the same
queries are repeated lots of times.</p><p>In general, the query results cache provides the biggest improvements for queries with
small result sets that take long to calculate. If query results are very big and
most of the query time is spent on copying the result from the cache to the client,
then the cache does not provide much benefit.</p><h2 id=global-configuration>Global configuration <a href=/3.12/aql/execution-and-performance/caching-query-results/#global-configuration class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The query results cache can be configured at server start with the
<a href=/3.12/components/arangodb-server/options/#--querycache-mode class=link><code>--query.cache-mode</code></a>
startup option.</p><p>The cache mode can also be changed at runtime using the JavaScript API as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/aql/cache&#34;</span><span class=p>).</span><span class=nx>properties</span><span class=p>({</span> <span class=nx>mode</span><span class=o>:</span> <span class=s2>&#34;on&#34;</span> <span class=p>});</span> 
</span></span></code></pre></div><p>The maximum number of cached results in the cache for each database can be configured
at server start using the following configuration parameters:</p><ul><li><code>--query.cache-entries</code>: The maximum number of results in the query results cache per database</li><li><code>--query.cache-entries-max-size</code>: The maximum cumulated size of results in the query results cache per database</li><li><code>--query.cache-entry-max-size</code>: The maximum size of an individual result entry in query results cache</li><li><code>--query.cache-include-system-collections</code>: Whether to include system collection queries in the query results cache</li></ul><p>These parameters can be used to put an upper bound on the number and size of query
results in each database&rsquo;s query cache and thus restrict the cache&rsquo;s memory consumption.</p><p>These value can also be adjusted at runtime as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/aql/cache&#34;</span><span class=p>).</span><span class=nx>properties</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>  <span class=nx>maxResults</span><span class=o>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>maxResultsSize</span><span class=o>:</span> <span class=mi>8</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>maxEntrySize</span><span class=o>:</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>includeSystem</span><span class=o>:</span> <span class=kc>false</span> 
</span></span><span class=line><span class=cl><span class=p>});</span> 
</span></span></code></pre></div><p>The above settings limit the number of cached results in the query results cache to 200
results per database, and to 8 MiB cumulated query result size per database. The maximum
size of each query cache entry is restricted to 1 MiB. Queries that involve system
collections are excluded from caching.</p><p>You can also change the configuration at runtime with the
<a href=/3.12/develop/http-api/queries/aql-query-results-cache/ class=link>HTTP API</a>.</p><h2 id=per-query-configuration>Per-query configuration <a href=/3.12/aql/execution-and-performance/caching-query-results/#per-query-configuration class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>When a query is sent to the server for execution and the cache is set to <code>on</code> or <code>demand</code>,
the query executor checks the query&rsquo;s <code>cache</code> option. If the query cache mode is
<code>on</code>, then not setting this query option or setting it to anything but <code>false</code> makes the
query executor consult the query results cache. If the query cache mode is <code>demand</code>, then setting
the <code>cache</code> option to <code>true</code> makes the executor look for the query in the query results cache.
When the query cache mode is <code>off</code>, the executor does not look for the query in the cache.</p><p>The <code>cache</code> attribute can be set as follows via the <code>db._createStatement()</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>stmt</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_createStatement</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>  <span class=nx>query</span><span class=o>:</span> <span class=s2>&#34;FOR doc IN users LIMIT 5 RETURN doc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cache</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>    
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>stmt</span><span class=p>.</span><span class=nx>execute</span><span class=p>();</span></span></span></code></pre></div><p>When using the <code>db._query()</code> function, the <code>cache</code> attribute can be set as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=s2>&#34;FOR doc IN users LIMIT 5 RETURN doc&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>cache</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span> 
</span></span></code></pre></div><p>You can also set the <code>cache</code> query option in the
<a href=/3.12/develop/http-api/queries/aql-queries/#create-a-cursor class=link>HTTP API</a>.</p><p>Each query result returned contain a <code>cached</code> attribute. It is set to <code>true</code>
if the result was retrieved from the query results cache, and <code>false</code> otherwise. Clients can use
this attribute to check if a specific query was served from the cache or not.</p><h2 id=query-results-cache-inspection>Query results cache inspection <a href=/3.12/aql/execution-and-performance/caching-query-results/#query-results-cache-inspection class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The contents of the query results cache can be checked at runtime using the cache&rsquo;s
<code>toArray()</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/aql/cache&#34;</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>This returns a list of all query results stored in the current database&rsquo;s query
results cache.</p><p>The query results cache for the current database can be cleared at runtime using the
cache&rsquo;s <code>clear</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/aql/cache&#34;</span><span class=p>).</span><span class=nx>clear</span><span class=p>();</span></span></span></code></pre></div><h2 id=restrictions>Restrictions <a href=/3.12/aql/execution-and-performance/caching-query-results/#restrictions class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Query results that are returned from the query results cache may contain execution statistics
stemming from the initial, uncached query execution. This means for a cached query results,
the <code>extra.stats</code> attribute may contain stale data, especially in terms of the <code>executionTime</code>
and <code>profile</code> attribute values.</p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.12/aql/execution-and-performance/caching-query-plans/><i class="fas fa-chevron-left fa-fw"></i><p>Caching query plans</p></a></span><span class=next><a class="nav nav-next link" href=/3.12/aql/execution-and-performance/query-logging/><p>Query logging</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.12/aql/execution-and-performance/caching-query-results.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#modes>Modes</a></div><div class=level-2><a href=#query-eligibility>Query eligibility</a></div><div class=level-2><a href=#cache-invalidation>Cache invalidation</a></div><div class=level-2><a href=#performance-considerations>Performance considerations</a></div><div class=level-2><a href=#global-configuration>Global configuration</a></div><div class=level-2><a href=#per-query-configuration>Per-query configuration</a></div><div class=level-2><a href=#query-results-cache-inspection>Query results cache inspection</a></div><div class=level-2><a href=#restrictions>Restrictions</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
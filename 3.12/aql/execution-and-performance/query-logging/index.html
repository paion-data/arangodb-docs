<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743775370></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="You can optionally let ArangoDB write metadata of finished AQL queries to a collection for later analysis"><meta property="og:url" content="http://localhost/3.12/aql/execution-and-performance/query-logging/"><meta property="og:title" content="AQL query logging"><meta property="og:type" content="website"><meta property="og:description" content="You can optionally let ArangoDB write metadata of finished AQL queries to a collection for later analysis"><meta name=docsearch:version content="3.12"><title>AQL query logging | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743775370 defer></script>
<script src=/js/featherlight.min.js?1743775370 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743775370 defer></script>
<script src=/js/theme.js?1743775370 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.12"><a itemprop=item class=link href=/3.12/><span itemprop=name class=breadcrumb-entry>3.12.4</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.12/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Execution and Performance"><a itemprop=item class=link href=/3.12/aql/execution-and-performance/><span itemprop=name class=breadcrumb-entry>Execution and Performance</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Query logging"><a itemprop=item class=link href=/3.12/aql/execution-and-performance/query-logging/><span itemprop=name class=breadcrumb-entry>Query logging</span></a></li></ol></nav><article class=default><hgroup><h1>AQL query logging</h1><p class=lead>You can optionally let ArangoDB write metadata of finished AQL queries to a collection for later analysis</p></hgroup><p><small>Introduced in: v3.12.2</small></p><p>For debugging query issues and to understand usage patterns, it can be helpful
to have a persistent log of queries.</p><p>ArangoDB lets you store information about past queries to a system collection
with a configurable sampling probability and retention period. This allows you
to analyze the metadata such as run time, memory usage, and failure reasons
directly in the database system.</p><p>ArangoDB also supports event logging to a file, syslog, or the attached terminal.
See <a href=/3.12/components/arangodb-server/options/#--loglevel class=link><code>--log.level</code></a> for
details. The relevant log topics are <code>aql</code> and <code>queries</code>.</p><h2 id=enable-query-logging>Enable query logging <a href=/3.12/aql/execution-and-performance/query-logging/#enable-query-logging class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>To activate the logging of AQL queries to the <code>_queries</code> collection, you need to
enable the <code>--query.collection-logger-enabled</code> startup option for <em>arangod</em>.</p><p>If you want queries that run in the <code>_system</code> database to be logged, you
additionally need to enable the <code>--query.collection-logger-include-system-database</code>
startup option.</p><p>As logging all queries can have a high overhead on busy systems, only a random
sample of the total queries is typically logged. You can control the probability
with the <code>--query.collection-logger-probability</code> startup option. A value of <code>100</code>
logs all queries, whereas a value of <code>1</code> approximately logs every 100th query
and ignores the rest. Which queries are logged is based on randomness.</p><p>You can enable the <code>--query.collection-logger-all-slow-queries</code> startup option
to always log slow queries regardless of whether they are selected for sampling
or not. You can configure the time threshold for what is considered a slow query
with the <code>--query.slow-threshold</code> and <code>--query.slow-streaming-threshold</code>
startup options.</p><h2 id=use-the-logged-metadata>Use the logged metadata <a href=/3.12/aql/execution-and-performance/query-logging/#use-the-logged-metadata class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Query metadata is stored in the <code>_queries</code> collection in the <code>_system</code> database.
This collection is created automatically if needed.</p><div class="box notices cstyle security"><div class=box-content-container><div class=box-content><i class="fas fa-shield-alt"></i><div class=box-text>The <code>_queries</code> collection is a normal system collection, so it can be queried by
every user with at least read access to the <code>_system</code> database and the <code>_queries</code>
collection. Keep this in mind when enabling the query logging as the data may
include sensitive information such as user names, query strings, and bind parameters.</div></div></div></div><p>Only finished queries are logged to the <code>_queries</code> collection. Queries are
considered finished when they have executed completely or failed with an error.
In-flight queries are not logged but should eventually become finished queries.</p><p>Each document in the <code>_queries</code> collection represents a past query that has been
sampled and includes the following attributes:</p><ul><li><code>id</code>: The internal ID of the query.</li><li><code>database</code>: The name of the database the query ran in.</li><li><code>user</code>: The name of the user that executed the query.</li><li><code>query</code>: The query string, if the <code>--query.tracking-with-querystring</code>
startup option is enabled (the default is <code>true</code>). Otherwise, the value is
<code>"&lt;hidden>"</code>. The query string is cut off after
<code>--query.max-artifact-log-length</code> characters.</li><li><code>bindVars</code>: The bind parameter values used by the query, if the
<code>--query.tracking-with-bindvars</code> startup option is enabled (the default is
<code>true</code>). If it is disabled or no bind parameters were used, the value is <code>{}</code>.</li><li><code>dataSources</code>: An array of collection and View names that were used in the
query. Only present if <code>--query.tracking-with-datasources</code> startup option is
enabled (the default is <code>false</code>).</li><li><code>started</code>: An ISO 8601 date time strings with the point in time the query
started executing.</li><li><code>runTime</code>: The total duration of the query in seconds.</li><li><code>state</code>: The state of the query (always <code>"finished"</code>).</li><li><code>stream</code>: Whether the query was a streaming AQL query (<code>stream</code> option).</li><li><code>modificationQuery</code>: Whether the query created, modified, or deleted any documents.</li><li><code>warnings</code>: The number of warnings issued by the query.</li><li><code>exitCode</code>: The exit code of the query (<code>0</code> = success, any other exit code
indicates a specific <a href=/3.12/develop/error-codes-and-meanings/ class=link>error</a>).</li></ul><p>You can retrieve and analyze the stored query metadata by running AQL queries on
the <code>_queries</code> collection in the <code>_system</code> database. You can use arbitrary
filtering, sorting, and aggregation.</p><p><strong>Examples</strong></p><p>Return the logged queries issued by a specific user and that ran for at least
10 seconds, sorted by start time:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>_queries</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>runTime</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=mf>0.0</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>user</span> <span class=o>==</span> <span class=nv>@user</span>
</span></span><span class=line><span class=cl>  <span class=kr>SORT</span> <span class=n>doc</span><span class=p>.</span><span class=n>started</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>Group the logged queries from a specified time range by database and user and
return the count, database name, and user name for each group.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>_queries</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>started</span> <span class=o>&gt;=</span> <span class=nv>@start</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>started</span> <span class=o>&lt;</span> <span class=nv>@end</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>db</span> <span class=o>=</span> <span class=n>doc</span><span class=p>.</span><span class=n>database</span><span class=p>,</span> <span class=n>user</span> <span class=o>=</span> <span class=n>doc</span><span class=p>.</span><span class=n>user</span> <span class=kr>WITH</span> <span class=kp>COUNT</span> <span class=kr>INTO</span> <span class=n>count</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> <span class=n>db</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=n>count</span> <span class=p>}</span></span></span></code></pre></div><h2 id=log-retention>Log retention <a href=/3.12/aql/execution-and-performance/query-logging/#log-retention class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>When query logging is enabled, obsolete entries from the <code>_queries</code> collection
are purged with a configurable schedule. The <code>--query.collection-logger-retention-time</code>
startup option determines for how long after a query&rsquo;s start time an entry is
approximately retained in the system collection. For example, a value of <code>86400</code>
keeps the document around for approximately one day (86400 seconds).
The default retention time is <code>28800</code> seconds (8 hours).</p><p>The actual cleanup of the system collection runs in configurable intervals.
This ensures that the cleanup process imposes minimal load.
You can configure it with the <code>--query.collection-logger-cleanup-interval</code>
startup option (in milliseconds).</p><h2 id=log-buffering>Log buffering <a href=/3.12/aql/execution-and-performance/query-logging/#log-buffering class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>You can use the <code>--query.collection-logger-push-interval</code> startup option to set
a maximum wait time after which queries are logged to the system collection.
This is a performance optimization that helps to reduce the overhead of the
query logging. For example, a value of <code>10000</code> buffers query log entries in
memory for at most 10,000 milliseconds before they are actually written to the
system collection. When additional queries complete within this interval, their
log entries are batched together into a single write operation to the
system collection. This can amortize the cost of writing the query metadata to
the system collection across multiple user queries.</p><p>The <code>--query.collection-logger-max-buffered-queries</code> startup option limits the
number of query log entries to buffer in memory before they are flushed to the
system collection. Once this limit has been reached, no further query metadata
is buffered in memory and it is lost. To make this relatively unlikely, a flush
is triggered automatically once 25% of the limit is reached. However, it is
still possible that the single-thread flush operation cannot keep up with the
rate of incoming queries so that the limit is reached and some query metadata is
not logged.</p><p>Any queries that are buffered in memory and are not yet flushed out to the
system collection is lost in case the <em>arangod</em> process shuts down or crashes.
The query logging functionality should therefore not be used for auditing but
rather for debugging and troubleshooting query issues, such as finding
long-running queries, queries that produced warnings or errors, users that
overuse the database, and so on.</p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.12/aql/execution-and-performance/caching-query-results/><i class="fas fa-chevron-left fa-fw"></i><p>Caching query results</p></a></span><span class=next><a class="nav nav-next link" href=/3.12/aql/common-errors/><p>Common Errors</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.12/aql/execution-and-performance/query-logging.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#enable-query-logging>Enable query logging</a></div><div class=level-2><a href=#use-the-logged-metadata>Use the logged metadata</a></div><div class=level-2><a href=#log-retention>Log retention</a></div><div class=level-2><a href=#log-buffering>Log buffering</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
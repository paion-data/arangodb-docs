<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743775370></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="With AQL queries, you can read and write data in the form of documents"><meta property="og:url" content="http://localhost/3.12/aql/data-queries/"><meta property="og:title" content="AQL Data Queries"><meta property="og:type" content="website"><meta property="og:description" content="With AQL queries, you can read and write data in the form of documents"><meta name=docsearch:version content="3.12"><title>AQL Data Queries | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743775370 defer></script>
<script src=/js/featherlight.min.js?1743775370 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743775370 defer></script>
<script src=/js/theme.js?1743775370 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.12"><a itemprop=item class=link href=/3.12/><span itemprop=name class=breadcrumb-entry>3.12.4</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.12/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Data Queries"><a itemprop=item class=link href=/3.12/aql/data-queries/><span itemprop=name class=breadcrumb-entry>Data Queries</span></a></li></ol></nav><article class=default><hgroup><h1>AQL Data Queries</h1><p class=lead>With AQL queries, you can read and write data in the form of documents</p></hgroup><p>There are two fundamental types of AQL queries:</p><ul><li>queries which access data (read documents)</li><li>queries which modify data (create, update, replace, delete documents)</li></ul><h2 id=data-access-queries>Data Access Queries <a href=/3.12/aql/data-queries/#data-access-queries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Retrieving data from the database with AQL does always include a <strong>RETURN</strong>
operation. It can be used to return a static value, such as a string:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=s2>&#34;Hello ArangoDB!&#34;</span></span></span></code></pre></div><p>The query result is always an array of elements, even if a single element was
returned and contains a single element in that case: <code>["Hello ArangoDB!"]</code></p><p>The function <code>DOCUMENT()</code> can be called to retrieve a single document via
its document identifier, for instance:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=nf>DOCUMENT</span><span class=p>(</span><span class=s2>&#34;users/phil&#34;</span><span class=p>)</span></span></span></code></pre></div><p><code>RETURN</code> is usually accompanied by a <strong>FOR</strong> loop to iterate over the
documents of a collection. The following query executes the loop body for all
documents of a collection called <code>users</code>. Each document is returned unchanged
in this example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>Instead of returning the raw <code>doc</code>, one can easily create a projection:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> <span class=n>user</span><span class=o>:</span> <span class=n>doc</span><span class=p>,</span> <span class=n>newAttribute</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span></span></span></code></pre></div><p>For every user document, an object with two attributes is returned. The value
of the attribute <code>user</code> is set to the content of the user document, and
<code>newAttribute</code> is a static attribute with the boolean value <code>true</code>.</p><p>Operations like <strong>FILTER</strong>, <strong>SORT</strong> and <strong>LIMIT</strong> can be added to the loop body
to narrow and order the result. Instead of above shown call to <code>DOCUMENT()</code>,
one can also retrieve the document that describes user <code>phil</code> like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>_key</span> <span class=o>==</span> <span class=s2>&#34;phil&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>The document key is used in this example, but any other attribute could equally
be used for filtering. Since the document key is guaranteed to be unique, no
more than a single document can match this filter. For other attributes this
may not be the case. To return a subset of active users (determined by an
attribute called <code>status</code>), sorted by name in ascending order, you can do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;active&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>SORT</span> <span class=n>doc</span><span class=p>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>  <span class=kr>LIMIT</span> <span class=mi>10</span></span></span></code></pre></div><p>Note that operations do not have to occur in a fixed order and that their order
can influence the result significantly. Limiting the number of documents
before a filter is usually not what you want, because it easily misses a lot
of documents that would fulfill the filter criterion, but are ignored because
of a premature <code>LIMIT</code> clause. Because of the aforementioned reasons, <code>LIMIT</code>
is usually put at the very end, after <code>FILTER</code>, <code>SORT</code> and other operations.</p><p>See the <a href=/3.12/aql/high-level-operations/ class=link>High Level Operations</a> chapter for more details.</p><h2 id=data-modification-queries>Data Modification Queries <a href=/3.12/aql/data-queries/#data-modification-queries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>AQL supports the following data modification operations:</p><ul><li><strong>INSERT</strong>: insert new documents into a collection</li><li><strong>UPDATE</strong>: partially update existing documents in a collection</li><li><strong>REPLACE</strong>: completely replace existing documents in a collection</li><li><strong>REMOVE</strong>: remove existing documents from a collection</li><li><strong>UPSERT</strong>: conditionally insert or update documents in a collection</li></ul><p>You can use them to modify the data of one or multiple documents with a single
query. This is superior to fetching and updating the documents individually with
multiple queries. However, if only a single document needs to be modified,
ArangoDB&rsquo;s specialized data modification operations for single documents might
execute faster.</p><p>Below you find some simple example queries that use these operations.
The operations are detailed in the chapter <a href=/3.12/aql/high-level-operations/ class=link>High Level Operations</a>.</p><h3 id=modifying-a-single-document>Modifying a single document <a href=/3.12/aql/data-queries/#modifying-a-single-document class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>Let&rsquo;s start with the basics: <code>INSERT</code>, <code>UPDATE</code> and <code>REMOVE</code> operations on single documents.
Here is an example that inserts a document into a collection called <code>users</code> with
the <a href=/3.12/aql/high-level-operations/insert/ class=link><code>INSERT</code> operation</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>firstName</span><span class=o>:</span> <span class=s2>&#34;Anna&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;Pavlova&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>profession</span><span class=o>:</span> <span class=s2>&#34;artist&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>INTO</span> <span class=n>users</span></span></span></code></pre></div><p>The collection needs to exist before executing the query. AQL queries cannot
create collections.</p><p>If you run the above query, the result is an empty array because we did
not specify what to return using a <code>RETURN</code> keyword. It is optional in
modification queries, but mandatory in data access queries. Despite the empty
result, the above query still creates a new user document.</p><p>You may provide a key for the new document; if not provided, ArangoDB creates one for you.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;GilbertoGil&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>firstName</span><span class=o>:</span> <span class=s2>&#34;Gilberto&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;Gil&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>city</span><span class=o>:</span> <span class=s2>&#34;Fortalezza&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>INTO</span> <span class=n>users</span></span></span></code></pre></div><p>As ArangoDB is schema-free, attributes of the documents may vary:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;PhilCarpenter&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>firstName</span><span class=o>:</span> <span class=s2>&#34;Phil&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;Carpenter&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>middleName</span><span class=o>:</span> <span class=s2>&#34;G.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inactive&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>INTO</span> <span class=n>users</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;NatachaDeclerck&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>firstName</span><span class=o>:</span> <span class=s2>&#34;Natacha&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;Declerck&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>location</span><span class=o>:</span> <span class=s2>&#34;Antwerp&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>INTO</span> <span class=n>users</span> 
</span></span></code></pre></div><p>The <a href=/3.12/aql/high-level-operations/update/ class=link><code>UPDATE</code> operation</a> lets you add or change
attributes of existing documents. The following query modifies a previously
created user, changing the <code>status</code> attribute and adding a <code>location</code> attribute:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=s2>&#34;PhilCarpenter&#34;</span> <span class=kr>WITH</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;active&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>location</span><span class=o>:</span> <span class=s2>&#34;Beijing&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>The <a href=/3.12/aql/high-level-operations/replace/ class=link><code>REPLACE</code> operation</a> is an alternative to the
<code>UPDATE</code> operation that lets you replace all attributes of a document
(except for attributes that cannot be changed, like <code>_key</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>REPLACE</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;NatachaDeclerck&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>firstName</span><span class=o>:</span> <span class=s2>&#34;Natacha&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;Leclerc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;active&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>level</span><span class=o>:</span> <span class=s2>&#34;premium&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>You can delete a document with the <a href=/3.12/aql/high-level-operations/remove/ class=link><code>REMOVE</code> operation</a>,
only requiring the document key to identify it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>REMOVE</span> <span class=s2>&#34;GilbertoGil&#34;</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><h3 id=modifying-multiple-documents>Modifying multiple documents <a href=/3.12/aql/data-queries/#modifying-multiple-documents class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>Data modification operations are normally combined with <code>FOR</code> loops to
iterate over a given list of documents. They can optionally be combined with
<code>FILTER</code> statements and the like.</p><p>To create multiple new documents, use the <code>INSERT</code> operation together with <code>FOR</code>.
You can also use <code>INSERT</code> to generate copies of existing documents from other
collections, or to create synthetic documents (e.g. for testing purposes).
The following query creates 1000 test users with some attributes and stores
them in the <code>users</code> collection:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>i</span> <span class=kr>IN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>1000</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>id</span><span class=o>:</span> <span class=mi>100000</span> <span class=o>+</span> <span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>age</span><span class=o>:</span> <span class=mi>18</span> <span class=o>+</span> <span class=nf>FLOOR</span><span class=p>(</span><span class=nf>RAND</span><span class=p>()</span> <span class=o>*</span> <span class=mi>25</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>:</span> <span class=nf>CONCAT</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=nf>TO_STRING</span><span class=p>(</span><span class=n>i</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=o>:</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>?</span> <span class=s2>&#34;active&#34;</span> <span class=o>:</span> <span class=s2>&#34;not active&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>active</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>gender</span><span class=o>:</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>3</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>?</span> <span class=s2>&#34;male&#34;</span> <span class=o>:</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>3</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=s2>&#34;female&#34;</span> <span class=o>:</span> <span class=s2>&#34;diverse&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>Let&rsquo;s modify existing documents that match some condition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;not active&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>u</span> <span class=kr>WITH</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inactive&#34;</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>You can also update existing attributes based on their previous value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>active</span> <span class=o>==</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>u</span> <span class=kr>WITH</span> <span class=p>{</span> <span class=n>numberOfLogins</span><span class=o>:</span> <span class=n>u</span><span class=p>.</span><span class=n>numberOfLogins</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>The above query only works if there is already a <code>numberOfLogins</code> attribute
present in the document. If it is unclear whether there is a <code>numberOfLogins</code>
attribute in the document, the increase must be made conditional:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>active</span> <span class=o>==</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>u</span> <span class=kr>WITH</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>numberOfLogins</span><span class=o>:</span> <span class=nf>HAS</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=s2>&#34;numberOfLogins&#34;</span><span class=p>)</span> <span class=o>?</span> <span class=n>u</span><span class=p>.</span><span class=n>numberOfLogins</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>Updates of multiple attributes can be combined in a single query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>active</span> <span class=o>==</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>u</span> <span class=kr>WITH</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lastLogin</span><span class=o>:</span> <span class=nf>DATE_NOW</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>numberOfLogins</span><span class=o>:</span> <span class=nf>HAS</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=s2>&#34;numberOfLogins&#34;</span><span class=p>)</span> <span class=o>?</span> <span class=n>u</span><span class=p>.</span><span class=n>numberOfLogins</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>Note than an update query might fail during execution, for example, because a
document to be updated does not exist. In this case, the query aborts at
the first error. In single server mode, all modifications done by the query
are rolled back as if they never happened.</p><p>You can copy documents from one collection to another by reading from one
collection but write to another.
Let&rsquo;s copy the contents of the <code>users</code> collection into the <code>backup</code> collection:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>backup</span></span></span></code></pre></div><p>Note that both collections must already exist when the query is executed.
The query might fail if the <code>backup</code> collection already contains documents,
as executing the insert might attempt to insert the same document (identified
by the <code>_key</code> attribute) again. This triggers a unique key constraint violation
and aborts the query. In single server mode, all changes made by the query
are also rolled back.
To make such a copy operation work in all cases, the target collection can
be emptied beforehand, using a <code>REMOVE</code> query or by truncating it by other means.</p><p>To not just partially update, but completely replace existing documents, use
the <code>REPLACE</code> operation.
The following query replaces all documents in the <code>backup</code> collection with
the documents found in the <code>users</code> collection. Documents common to both
collections are replaced. All other documents remain unchanged.
Documents are compared using their <code>_key</code> attributes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>REPLACE</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>backup</span></span></span></code></pre></div><p>The above query fails if there are documents in the <code>users</code> collection that are
not in the <code>backup</code> collection yet. In this case, the query would attempt to replace
documents that do not exist. If such case is detected while executing the query,
the query is aborted. In single server mode, all changes made by the query are
rolled back.</p><p>To make the query succeed regardless of the errors, use the <code>ignoreErrors</code>
query option:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>REPLACE</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>backup</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>ignoreErrors</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span></span></span></code></pre></div><p>This continues the query execution if errors occur during a <code>REPLACE</code>, <code>UPDATE</code>,
<code>INSERT</code>, or <code>REMOVE</code> operation.</p><p>Finally, let&rsquo;s find some documents in collection <code>users</code> and remove them
from collection <code>backup</code>. The link between the documents in both collections is
established via the documents&rsquo; keys:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;deleted&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>REMOVE</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>backup</span></span></span></code></pre></div><p>The following example removes all documents from both <code>users</code> and <code>backup</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>r1</span> <span class=o>=</span> <span class=p>(</span><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>  <span class=kr>REMOVE</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>r2</span> <span class=o>=</span> <span class=p>(</span><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>backup</span> <span class=kr>REMOVE</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>backup</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=kc>true</span></span></span></code></pre></div><h3 id=altering-substructures>Altering substructures <a href=/3.12/aql/data-queries/#altering-substructures class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>To modify lists in documents, for example, to update specific attributes of
objects in an array, you can compute a new array and then update the document
attribute in question. This may involve the use of subqueries and temporary
variables.</p><p>Create a collection named <code>complexCollection</code> and run the following query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;topLevelAttribute&#34;</span><span class=o>:</span> <span class=s2>&#34;a&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;subList&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;attributeToAlter&#34;</span><span class=o>:</span> <span class=s2>&#34;value to change&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterByMe&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;attributeToAlter&#34;</span><span class=o>:</span> <span class=s2>&#34;another value to change&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterByMe&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;attributeToAlter&#34;</span><span class=o>:</span> <span class=s2>&#34;keep this value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterByMe&#34;</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;topLevelAttribute&#34;</span><span class=o>:</span> <span class=s2>&#34;b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;subList&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;attributeToAlter&#34;</span><span class=o>:</span> <span class=s2>&#34;keep this value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filterByMe&#34;</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span> <span class=kr>INSERT</span> <span class=n>doc</span> <span class=kr>INTO</span> <span class=n>complexCollection</span></span></span></code></pre></div><p>The following query updates the <code>subList</code> top-level attribute of documents.
The <code>attributeToAlter</code> values in the nested object are changed if the adjacent
<code>filterByMe</code> attribute is <code>true</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>in</span> <span class=n>complexCollection</span>
</span></span><span class=line><span class=cl>  <span class=kd>LET</span> <span class=n>alteredList</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kr>FOR</span> <span class=n>element</span> <span class=kr>IN</span> <span class=n>doc</span><span class=p>.</span><span class=n>subList</span>
</span></span><span class=line><span class=cl>       <span class=kr>RETURN</span> <span class=n>element</span><span class=p>.</span><span class=n>filterByMe</span>
</span></span><span class=line><span class=cl>              <span class=o>?</span> <span class=nf>MERGE</span><span class=p>(</span><span class=n>element</span><span class=p>,</span> <span class=p>{</span> <span class=n>attributeToAlter</span><span class=o>:</span> <span class=s2>&#34;new value&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>              <span class=o>:</span> <span class=n>element</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>doc</span> <span class=kr>WITH</span> <span class=p>{</span> <span class=n>subList</span><span class=o>:</span> <span class=n>alteredList</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>complexCollection</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=bp>NEW</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_key&#34;</span><span class=p>:</span> <span class=s2>&#34;2607&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_id&#34;</span><span class=p>:</span> <span class=s2>&#34;complexCollection/2607&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_rev&#34;</span><span class=p>:</span> <span class=s2>&#34;_fWb_iOO---&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;topLevelAttribute&#34;</span><span class=p>:</span> <span class=s2>&#34;a&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;subList&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributeToAlter&#34;</span><span class=p>:</span> <span class=s2>&#34;new value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;filterByMe&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributeToAlter&#34;</span><span class=p>:</span> <span class=s2>&#34;new value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;filterByMe&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributeToAlter&#34;</span><span class=p>:</span> <span class=s2>&#34;keep this value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;filterByMe&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_key&#34;</span><span class=p>:</span> <span class=s2>&#34;2608&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_id&#34;</span><span class=p>:</span> <span class=s2>&#34;complexCollection/2608&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_rev&#34;</span><span class=p>:</span> <span class=s2>&#34;_fWb_iOO--_&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;topLevelAttribute&#34;</span><span class=p>:</span> <span class=s2>&#34;b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;subList&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributeToAlter&#34;</span><span class=p>:</span> <span class=s2>&#34;keep this value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;filterByMe&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>To improve the query&rsquo;s performance, you can only update documents if there is
a change to the <code>subList</code> to be saved. Instead of comparing the current and the
altered list directly, you may compare their hash values using the
<a href=/3.12/aql/functions/miscellaneous/#hash class=link><code>HASH()</code> function</a>, which is faster for
larger objects and arrays. You can also replace the subquery with an
<a href=/3.12/aql/operators/#inline-expressions class=link>inline expression</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>in</span> <span class=n>complexCollection</span>
</span></span><span class=line><span class=cl>  <span class=kd>LET</span> <span class=n>alteredList</span> <span class=o>=</span> <span class=n>doc</span><span class=p>.</span><span class=n>subList</span><span class=p>[</span><span class=o>*</span>
</span></span><span class=line><span class=cl>    <span class=kr>RETURN</span> <span class=bp>CURRENT</span><span class=p>.</span><span class=n>filterByMe</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nf>MERGE</span><span class=p>(</span><span class=bp>CURRENT</span><span class=p>,</span> <span class=p>{</span> <span class=n>attributeToAlter</span><span class=o>:</span> <span class=s2>&#34;new value&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=bp>CURRENT</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=nf>HASH</span><span class=p>(</span><span class=n>doc</span><span class=p>.</span><span class=n>subList</span><span class=p>)</span> <span class=o>!=</span> <span class=nf>HASH</span><span class=p>(</span><span class=n>alteredList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>doc</span> <span class=kr>WITH</span> <span class=p>{</span> <span class=n>subList</span><span class=o>:</span> <span class=n>alteredList</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>complexCollection</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=bp>NEW</span></span></span></code></pre></div><h3 id=returning-documents>Returning documents <a href=/3.12/aql/data-queries/#returning-documents class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>Data modification queries can optionally return documents. In order to reference
the inserted, removed or modified documents in a <code>RETURN</code> statement, data modification
statements introduce the <code>OLD</code> and/or <code>NEW</code> pseudo-values:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>i</span> <span class=kr>IN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span> <span class=n>value</span><span class=o>:</span> <span class=n>i</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>test</span> 
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=bp>NEW</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;deleted&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>REMOVE</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span> 
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=bp>OLD</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;not active&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>u</span> <span class=kr>WITH</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inactive&#34;</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span> 
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=bp>NEW</span></span></span></code></pre></div><p><code>NEW</code> refers to the inserted or modified document revision, and <code>OLD</code> refers
to the document revision before update or removal. <code>INSERT</code> statements can
only refer to the <code>NEW</code> pseudo-value, and <code>REMOVE</code> operations only to <code>OLD</code>.
<code>UPDATE</code>, <code>REPLACE</code> and <code>UPSERT</code> can refer to either.</p><p>In all cases, the full documents are returned with all their attributes,
including the potentially auto-generated attributes, such as <code>_id</code>, <code>_key</code>, and <code>_rev</code>,
and the attributes not specified in the update expression of a partial update.</p><h4 id=projections-of-old-and-new>Projections of OLD and NEW <a href=/3.12/aql/data-queries/#projections-of-old-and-new class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>It is possible to return a projection of the documents with <code>OLD</code> or <code>NEW</code> instead of
returning the entire documents. This can be used to reduce the amount of data returned
by queries.</p><p>For example, the following query returns only the keys of the inserted documents:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>i</span> <span class=kr>IN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span> <span class=n>value</span><span class=o>:</span> <span class=n>i</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>test</span> 
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=bp>NEW</span><span class=p>.</span><span class=n>_key</span></span></span></code></pre></div><h4 id=using-old-and-new-in-the-same-query>Using OLD and NEW in the same query <a href=/3.12/aql/data-queries/#using-old-and-new-in-the-same-query class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>For <code>UPDATE</code>, <code>REPLACE</code>, and <code>UPSERT</code> operations, both <code>OLD</code> and <code>NEW</code> can be used
to return the previous revision of a document together with the updated revision:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>u</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;not active&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=n>u</span> <span class=kr>WITH</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inactive&#34;</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span> 
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> <span class=n>old</span><span class=o>:</span> <span class=bp>OLD</span><span class=p>,</span> <span class=n>new</span><span class=o>:</span> <span class=bp>NEW</span> <span class=p>}</span></span></span></code></pre></div><h4 id=calculations-with-old-or-new>Calculations with OLD or NEW <a href=/3.12/aql/data-queries/#calculations-with-old-or-new class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>It is also possible to run additional calculations with <code>LET</code> statements between the
data modification part and the final <code>RETURN</code> of an AQL query. For example, the following
query performs an upsert operation and returns whether an existing document was
updated, or a new document was inserted. It does so by checking the <code>OLD</code> variable
after the <code>UPSERT</code> and using a <code>LET</code> statement to store a temporary string for
the operation type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=p>{</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl><span class=kd>LET</span> <span class=n>opType</span> <span class=o>=</span> <span class=nf>IS_NULL</span><span class=p>(</span><span class=bp>OLD</span><span class=p>)</span> <span class=o>?</span> <span class=s2>&#34;insert&#34;</span> <span class=o>:</span> <span class=s2>&#34;update&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=bp>NEW</span><span class=p>.</span><span class=n>_key</span><span class=p>,</span> <span class=n>type</span><span class=o>:</span> <span class=n>opType</span> <span class=p>}</span></span></span></code></pre></div><h3 id=restrictions>Restrictions <a href=/3.12/aql/data-queries/#restrictions class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The name of the modified collection (<code>users</code> and <code>backup</code> in the above cases)
must be known to the AQL executor at query-compile time and cannot change at
runtime. Using a bind parameter to specify the
<a href=/3.12/concepts/data-structure/collections/#collection-names class=link>collection name</a> is allowed.</p><p>It is not possible to use multiple data modification operations for the same
collection in the same query, or follow up a data modification operation for a
specific collection with a read operation for the same collection. Neither is
it possible to follow up any data modification operation with a traversal query
(which may read from arbitrary collections not necessarily known at the start of
the traversal).</p><p>That means you may not place several <code>REMOVE</code> or <code>UPDATE</code> statements for the same
collection into the same query. It is however possible to modify different collections
by using multiple data modification operations for different collections in the
same query.
In case you have a query with several places that need to remove documents from the
same collection, it is recommended to collect these documents or their keys in an array
and have the documents from that array removed using a single <code>REMOVE</code> operation.</p><p>Data modification operations can optionally be followed by <code>LET</code> operations to
perform further calculations and a <code>RETURN</code> operation to return data.</p><h3 id=transactional-execution>Transactional Execution <a href=/3.12/aql/data-queries/#transactional-execution class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>On a single server, data modification operations are executed transactionally.
If a data modification operation fails, any changes made by it are rolled
back automatically as if they never happened.</p><p>A query may execute intermediate transaction commits in case the running
transaction (AQL query) hits the specified size thresholds. In this case, the
query&rsquo;s operations carried out so far are committed and not rolled back in case
of a later abort/rollback. This behavior can be controlled by adjusting the
intermediate commit settings for the RocksDB engine. See
<a href=/3.12/aql/fundamentals/limitations/#storage-engine-properties class=link>Known limitations for AQL queries</a>.</p><p>In a cluster, AQL data modification queries are not executed transactionally.
Additionally, AQL queries with <code>UPDATE</code>, <code>REPLACE</code>, <code>UPSERT</code>, or <code>REMOVE</code>
operations require the <code>_key</code> attribute to be specified for all documents that
should be modified or removed, even if a shard key attribute other than <code>_key</code>
is chosen for the collection.</p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.12/aql/operators/><i class="fas fa-chevron-left fa-fw"></i><p>Operators</p></a></span><span class=next><a class="nav nav-next link" href=/3.12/aql/high-level-operations/><p>High-level Operations</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.12/aql/data-queries.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#data-access-queries>Data Access Queries</a></div><div class=level-2><a href=#data-modification-queries>Data Modification Queries</a></div><div class=level-3><a href=#modifying-a-single-document>Modifying a single document</a></div><div class=level-3><a href=#modifying-multiple-documents>Modifying multiple documents</a></div><div class=level-3><a href=#altering-substructures>Altering substructures</a></div><div class=level-3><a href=#returning-documents>Returning documents</a></div><div class=level-4><a href=#projections-of-old-and-new>Projections of OLD and NEW</a></div><div class=level-4><a href=#using-old-and-new-in-the-same-query>Using OLD and NEW in the same query</a></div><div class=level-4><a href=#calculations-with-old-or-new>Calculations with OLD or NEW</a></div><div class=level-3><a href=#restrictions>Restrictions</a></div><div class=level-3><a href=#transactional-execution>Transactional Execution</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
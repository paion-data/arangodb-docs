<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743775370></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="SmartJoins allow to execute co-located join operations among identically sharded collections"><meta property="og:url" content="http://localhost/3.13/develop/smartjoins/"><meta property="og:title" content="SmartJoins"><meta property="og:type" content="website"><meta property="og:description" content="SmartJoins allow to execute co-located join operations among identically sharded collections"><meta name=docsearch:version content="3.13"><title>SmartJoins | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743775370 defer></script>
<script src=/js/featherlight.min.js?1743775370 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743775370 defer></script>
<script src=/js/theme.js?1743775370 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.13"><a itemprop=item class=link href=/3.13/><span itemprop=name class=breadcrumb-entry>3.13.0</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Develop"><a itemprop=item class=link href=/3.13/develop/><span itemprop=name class=breadcrumb-entry>Develop</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="SmartJoins"><a itemprop=item class=link href=/3.13/develop/smartjoins/><span itemprop=name class=breadcrumb-entry>SmartJoins</span></a></li></ol></nav><article class=default><div class="box notices cstyle warning"><div class=box-content-container><div class=box-content><i class="fas fa-exclamation-triangle"></i><div class=box-text><p>ArangoDB v3.13 is under development and not released yet.
This documentation is not final and potentially incomplete.</p></div></div></div></div><hgroup><h1>SmartJoins</h1><p class=lead>SmartJoins allow to execute co-located join operations among identically sharded collections</p></hgroup><p class=labels><span class=label>ArangoDB Enterprise Edition</span>
<span class=label>ArangoGraph</span></p><h2 id=cluster-joins-without-being-smart>Cluster joins without being smart <a href=/3.13/develop/smartjoins/#cluster-joins-without-being-smart class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>When doing joins in an ArangoDB cluster, data has to be exchanged between different servers.
Joins between different collections in a cluster normally require roundtrips between the
shards of these collections for fetching the data. Requests are routed through an extra
Coordinator hop.</p><p>For example, with two collections <code>c1</code> and <code>c2</code> with 4 shards each, the Coordinator
initially contacts the 4 shards of <code>c1</code>. In order to perform the join, the DB-Server nodes
which manage the actual data of <code>c1</code> need to pull the data from the other collection, <code>c2</code>.
This causes extra roundtrips via the Coordinator, which then pulls the data for <code>c2</code>
from the responsible shards:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=s2>&#34;FOR doc1 IN c1 FOR doc2 IN c2 FILTER doc1._key == doc2._key RETURN doc1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span> <span class=nx>FILTER</span> <span class=nx>doc1</span><span class=p>.</span><span class=nx>_key</span> <span class=o>==</span> <span class=nx>doc2</span><span class=p>.</span><span class=nx>_key</span> <span class=nx>RETURN</span> <span class=nx>doc1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Site</span>  <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>   <span class=mi>1</span>   <span class=nx>SingletonNode</span>             <span class=nx>DBS</span>      <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>   <span class=nx>EnumerateCollectionNode</span>   <span class=nx>DBS</span>      <span class=mi>0</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span>   <span class=cm>/* full collection scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>  <span class=mi>14</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>       <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl>  <span class=mi>15</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>       <span class=o>-</span> <span class=nx>GATHER</span>
</span></span><span class=line><span class=cl>   <span class=mi>8</span>   <span class=nx>ScatterNode</span>               <span class=nx>COOR</span>     <span class=mi>0</span>       <span class=o>-</span> <span class=nx>SCATTER</span>
</span></span><span class=line><span class=cl>   <span class=mi>9</span>   <span class=nx>RemoteNode</span>                <span class=nx>DBS</span>      <span class=mi>0</span>       <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>   <span class=nx>IndexNode</span>                 <span class=nx>DBS</span>      <span class=mi>0</span>       <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span>   <span class=cm>/* primary index scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>         <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>         <span class=o>-</span> <span class=nx>GATHER</span>
</span></span><span class=line><span class=cl>   <span class=mi>6</span>   <span class=nx>ReturnNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>         <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc1</span></span></span></code></pre></div><p>This is the general query execution, and it makes sense if there is no further
information available about how the data is actually distributed to the individual
shards. It works in case <code>c1</code> and <code>c2</code> have a different amount of shards, or use
different shard keys or strategies. However, it comes with the additional cost of
having to do 4 x 4 requests to perform the join.</p><h2 id=sharding-two-collections-identically-using-distributeshardslike>Sharding two collections identically using distributeShardsLike <a href=/3.13/develop/smartjoins/#sharding-two-collections-identically-using-distributeshardslike class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In the specific case that the two collections have the same number of shards, the
data of the two collections can be co-located on the same server for the same shard
key values. In this case, the extra hop via the Coordinator is not necessary.</p><p>The query optimizer removes the extra hop for the join in case it can prove
that data for the two collections is co-located.</p><p>The first step is thus to make the two collections shard their data alike. This can
be achieved by making the <code>distributeShardsLike</code> attribute of one of the collections
refer to the other collection.</p><p>Here is an example setup for this, using arangosh:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;c1&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>numberOfShards</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>shardKeys</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;_key&#34;</span><span class=p>]});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;c2&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>shardKeys</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;_key&#34;</span><span class=p>],</span> <span class=nx>distributeShardsLike</span><span class=o>:</span> <span class=s2>&#34;c1&#34;</span><span class=p>});</span></span></span></code></pre></div><p>Now the collections <code>c1</code> and <code>c2</code> not only have the same shard keys, but they
also locate their data for the same shard keys values on the same server.</p><p>Let&rsquo;s check how the data actually gets distributed now. We first confirm that the
two collections have 4 shards each, which in this example are evenly distributed
across two servers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>shards</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011661&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-64d19f43-3aa0-4abb-81f6-4b9966d32175&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>],</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011662&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-5f30caa0-4c93-4fdd-98f3-a2130c1447df&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>],</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011663&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-64d19f43-3aa0-4abb-81f6-4b9966d32175&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>],</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011664&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-5f30caa0-4c93-4fdd-98f3-a2130c1447df&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>shards</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011666&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-64d19f43-3aa0-4abb-81f6-4b9966d32175&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>],</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011667&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-5f30caa0-4c93-4fdd-98f3-a2130c1447df&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>],</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011668&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-64d19f43-3aa0-4abb-81f6-4b9966d32175&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>],</span> 
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011669&#34;</span> <span class=o>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PRMR-5f30caa0-4c93-4fdd-98f3-a2130c1447df&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Because we have told both collections that distribute their data alike, their
shards are now also populated alike:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>_key</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=p>});</span> 
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>_key</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=p>});</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>count</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011664&#34;</span> <span class=o>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011661&#34;</span> <span class=o>:</span> <span class=mi>21</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011663&#34;</span> <span class=o>:</span> <span class=mi>27</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011662&#34;</span> <span class=o>:</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>count</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011669&#34;</span> <span class=o>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011666&#34;</span> <span class=o>:</span> <span class=mi>21</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011668&#34;</span> <span class=o>:</span> <span class=mi>27</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;s2011667&#34;</span> <span class=o>:</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can see that shard 1 of <code>c1</code> (&ldquo;s2011664&rdquo;) has the same number of documents as
shard 1 of <code>c2</code> (&ldquo;s20116692), that shard 2 of <code>c1</code> (&ldquo;s2011661&rdquo;) has the same
number of documents as shard2 of <code>c2</code> (&ldquo;s2011666&rdquo;) etc.
Additionally, we can see from the shard-to-server distribution above that the
corresponding shards from <code>c1</code> and <code>c2</code> always reside on the same node.
This is a precondition for running joins locally, and thanks to the effects of
<code>distributeShardsLike</code> it is now satisfied!</p><h2 id=smartjoins-using-distributeshardslike>SmartJoins using distributeShardsLike <a href=/3.13/develop/smartjoins/#smartjoins-using-distributeshardslike class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>With the two collections in place like this, an AQL query that uses a FILTER condition
that refers from the shard key of the one collection to the shard key of the other collection
and compares the two shard key values by equality is eligible for the query
optimizer&rsquo;s &ldquo;smart-joins&rdquo; optimization:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=s2>&#34;FOR doc1 IN c1 FOR doc2 IN c2 FILTER doc1._key == doc2._key RETURN doc1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span> <span class=nx>FILTER</span> <span class=nx>doc1</span><span class=p>.</span><span class=nx>_key</span> <span class=o>==</span> <span class=nx>doc2</span><span class=p>.</span><span class=nx>_key</span> <span class=nx>RETURN</span> <span class=nx>doc1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Site</span>  <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>   <span class=mi>1</span>   <span class=nx>SingletonNode</span>             <span class=nx>DBS</span>      <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>   <span class=nx>EnumerateCollectionNode</span>   <span class=nx>DBS</span>      <span class=mi>0</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span>   <span class=cm>/* full collection scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>   <span class=nx>IndexNode</span>                 <span class=nx>DBS</span>      <span class=mi>0</span>       <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span>   <span class=cm>/* primary index scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>         <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>         <span class=o>-</span> <span class=nx>GATHER</span> 
</span></span><span class=line><span class=cl>   <span class=mi>6</span>   <span class=nx>ReturnNode</span>                <span class=nx>COOR</span>     <span class=mi>0</span>         <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc1</span></span></span></code></pre></div><p>As can be seen above, the extra hop via the Coordinator is gone here, which means
less cluster-internal traffic and a faster response time.</p><p>SmartJoins also work if the shard key of the second collection is not <code>_key</code>,
and even for non-unique shard key values, e.g.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;c1&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>numberOfShards</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>shardKeys</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;_key&#34;</span><span class=p>]});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;c2&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>shardKeys</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;parent&#34;</span><span class=p>],</span> <span class=nx>distributeShardsLike</span><span class=o>:</span> <span class=s2>&#34;c1&#34;</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>ensureIndex</span><span class=p>({</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;hash&#34;</span><span class=p>,</span> <span class=nx>fields</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;parent&#34;</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>_key</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=p>});</span> 
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=nx>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>j</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=o>++</span><span class=nx>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>parent</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=s2>&#34;FOR doc1 IN c1 FOR doc2 IN c2 FILTER doc1._key == doc2.parent RETURN doc1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span> <span class=nx>FILTER</span> <span class=nx>doc1</span><span class=p>.</span><span class=nx>_key</span> <span class=o>==</span> <span class=nx>doc2</span><span class=p>.</span><span class=nx>parent</span> <span class=nx>RETURN</span> <span class=nx>doc1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Site</span>  <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>   <span class=mi>1</span>   <span class=nx>SingletonNode</span>             <span class=nx>DBS</span>      <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>   <span class=nx>EnumerateCollectionNode</span>   <span class=nx>DBS</span>   <span class=mi>2000</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span>   <span class=cm>/* full collection scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>   <span class=nx>IndexNode</span>                 <span class=nx>DBS</span>   <span class=mi>2000</span>       <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span>   <span class=cm>/* primary index scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>  <span class=mi>2000</span>         <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>  <span class=mi>2000</span>         <span class=o>-</span> <span class=nx>GATHER</span> 
</span></span><span class=line><span class=cl>   <span class=mi>6</span>   <span class=nx>ReturnNode</span>                <span class=nx>COOR</span>  <span class=mi>2000</span>         <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc1</span></span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-content-container><div class=box-content><i class="fas fa-check"></i><div class=box-text>All above examples used two collections only. SmartJoins also work when joining
more than two collections/Views which have the same data distribution enforced via their
<code>distributeShardsLike</code> attribute and using the shard keys as the join criteria as shown above.</div></div></div></div><h2 id=smartjoins-using-smartjoinattribute>SmartJoins using smartJoinAttribute <a href=/3.13/develop/smartjoins/#smartjoins-using-smartjoinattribute class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In case the join on the second collection must be performed on a non-shard key
attribute, there is the option to specify a <code>smartJoinAttribute</code> for the collection.
Note that for this case, setting <code>distributeShardsLike</code> is still required here, and that
only a single <code>shardKeys</code> attribute can be used.
The single attribute name specified in the <code>shardKeys</code> attribute for the collection must end
with a colon character then.</p><p>This <code>smartJoinAttribute</code> must be populated for all documents in the collection,
and must always contain a string value. The value of the <code>_key</code> attribute for each
document must consist of the value of the <code>smartJoinAttribute</code>, a colon character
and then some other user-defined key component.</p><p>The setup thus becomes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;c1&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>numberOfShards</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>shardKeys</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;_key&#34;</span><span class=p>]});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;c2&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>shardKeys</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;_key:&#34;</span><span class=p>],</span> <span class=nx>smartJoinAttribute</span><span class=o>:</span> <span class=s2>&#34;parent&#34;</span><span class=p>,</span> <span class=nx>distributeShardsLike</span><span class=o>:</span> <span class=s2>&#34;c1&#34;</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>ensureIndex</span><span class=p>({</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;hash&#34;</span><span class=p>,</span> <span class=nx>fields</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;parent&#34;</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>_key</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=p>});</span> 
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>_key</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=o>+</span> <span class=s2>&#34;:&#34;</span> <span class=o>+</span> <span class=s2>&#34;ownKey&#34;</span> <span class=o>+</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>parent</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span> <span class=o>+</span> <span class=nx>i</span> <span class=p>});</span> 
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Failure to populate the <code>smartJoinAttribute</code> with a string or not at all leads
to a document being rejected on insert, update or replace. Similarly, failure to
prefix a document&rsquo;s <code>_key</code> attribute value with the value of the <code>smartJoinAttribute</code>
also leads to the document being rejected:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>parent</span><span class=o>:</span> <span class=mi>123</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>JavaScript</span> <span class=nx>exception</span> <span class=k>in</span> <span class=nx>file</span> <span class=s1>&#39;./js/client/modules/@arangodb/arangosh.js&#39;</span> <span class=nx>at</span> <span class=mi>99</span><span class=p>,</span><span class=mi>7</span><span class=o>:</span> <span class=nx>ArangoError</span> <span class=mi>4008</span><span class=o>:</span> <span class=nx>SmartJoin</span> <span class=nx>attribute</span> <span class=nx>not</span> <span class=nx>given</span> <span class=nx>or</span> <span class=nx>invalid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>_key</span><span class=o>:</span> <span class=s2>&#34;123:test1&#34;</span><span class=p>,</span> <span class=nx>parent</span><span class=o>:</span> <span class=s2>&#34;124&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>JavaScript</span> <span class=nx>exception</span> <span class=k>in</span> <span class=nx>file</span> <span class=s1>&#39;./js/client/modules/@arangodb/arangosh.js&#39;</span> <span class=nx>at</span> <span class=mi>99</span><span class=p>,</span><span class=mi>7</span><span class=o>:</span> <span class=nx>ArangoError</span> <span class=mi>4007</span><span class=o>:</span> <span class=nx>shard</span> <span class=nx>key</span> <span class=nx>value</span> <span class=nx>must</span> <span class=nx>be</span> <span class=nx>prefixed</span> <span class=kd>with</span> <span class=nx>the</span> <span class=nx>value</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>SmartJoin</span> <span class=nx>attribute</span></span></span></code></pre></div><p>The join can now be performed via the collection&rsquo;s <code>smartJoinAttribute</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=s2>&#34;FOR doc1 IN c1 FOR doc2 IN c2 FILTER doc1._key == doc2.parent RETURN doc1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span> <span class=nx>FILTER</span> <span class=nx>doc1</span><span class=p>.</span><span class=nx>_key</span> <span class=o>==</span> <span class=nx>doc2</span><span class=p>.</span><span class=nx>parent</span> <span class=nx>RETURN</span> <span class=nx>doc1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Site</span>  <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>   <span class=mi>1</span>   <span class=nx>SingletonNode</span>             <span class=nx>DBS</span>      <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>   <span class=nx>EnumerateCollectionNode</span>   <span class=nx>DBS</span>    <span class=mi>101</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span>   <span class=cm>/* full collection scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>   <span class=nx>IndexNode</span>                 <span class=nx>DBS</span>    <span class=mi>101</span>       <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span>   <span class=cm>/* primary index scan, 4 shard(s) */</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>   <span class=mi>101</span>         <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>   <span class=mi>101</span>         <span class=o>-</span> <span class=nx>GATHER</span> 
</span></span><span class=line><span class=cl>   <span class=mi>6</span>   <span class=nx>ReturnNode</span>                <span class=nx>COOR</span>   <span class=mi>101</span>         <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc1</span></span></span></code></pre></div><h2 id=restricting-smartjoins-to-a-single-shard>Restricting SmartJoins to a single shard <a href=/3.13/develop/smartjoins/#restricting-smartjoins-to-a-single-shard class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>If a FILTER condition is used on one of the shard keys, the optimizer also tries
to restrict the queries to just the required shards:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=s2>&#34;FOR doc1 IN c1 FOR doc2 IN c2 FILTER doc1._key == &#39;test&#39; &amp;&amp; doc1._key == doc2.value RETURN doc1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span> <span class=nx>FILTER</span> <span class=nx>doc1</span><span class=p>.</span><span class=nx>_key</span> <span class=o>==</span> <span class=s1>&#39;test&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>doc1</span><span class=p>.</span><span class=nx>_key</span> <span class=o>==</span> <span class=nx>doc2</span><span class=p>.</span><span class=nx>value</span> 
</span></span><span class=line><span class=cl><span class=nx>RETURN</span> <span class=nx>doc1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nx>Id</span>   <span class=nx>NodeType</span>        <span class=nx>Site</span>  <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl> <span class=mi>1</span>   <span class=nx>SingletonNode</span>   <span class=nx>DBS</span>      <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl> <span class=mi>8</span>   <span class=nx>IndexNode</span>       <span class=nx>DBS</span>      <span class=mi>1</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc1</span> <span class=nx>IN</span> <span class=nx>c1</span>   <span class=cm>/* primary index scan, shard: s2010246 */</span>
</span></span><span class=line><span class=cl> <span class=mi>7</span>   <span class=nx>IndexNode</span>       <span class=nx>DBS</span>      <span class=mi>1</span>       <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc2</span> <span class=nx>IN</span> <span class=nx>c2</span>   <span class=cm>/* primary index scan, scan only, shard: s2010253 */</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>   <span class=nx>RemoteNode</span>      <span class=nx>COOR</span>     <span class=mi>1</span>         <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>   <span class=nx>GatherNode</span>      <span class=nx>COOR</span>     <span class=mi>1</span>         <span class=o>-</span> <span class=nx>GATHER</span> 
</span></span><span class=line><span class=cl> <span class=mi>6</span>   <span class=nx>ReturnNode</span>      <span class=nx>COOR</span>     <span class=mi>1</span>         <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc1</span></span></span></code></pre></div><h2 id=limitations>Limitations <a href=/3.13/develop/smartjoins/#limitations class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The SmartJoins optimization is currently triggered only for data selection queries,
but not for any data-manipulation operations such as INSERT, UPDATE, REPLACE, REMOVE
or UPSERT, neither traversals or subqueries.</p><p>It is only applied when joining two collections with an identical
sharding setup. This requires all involved but one collection to be created
with its <code>distributeShardsLike</code> attribute pointing to the collection that is
the exception. All collections forming a View must be sharded in the same way,
otherwise the View is not eligible.</p><p>It is restricted to be used with simple shard key attributes (such as <code>_key</code>, <code>productId</code>),
but not with nested attributes (e.g. <code>name.first</code>). There should be exactly one shard
key attribute defined for each collection.</p><p>Finally, the SmartJoins optimization requires that the involved collections are
joined on their shard key attributes (or <code>smartJoinAttribute</code>) using an equality
comparison.</p><h2 id=smartjoins-with-views>SmartJoins with Views <a href=/3.13/develop/smartjoins/#smartjoins-with-views class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Views of the <code>arangosearch</code> type are eligible for SmartJoins, provided that
their underlying collections are eligible too.</p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.13/develop/satellitecollections/><i class="fas fa-chevron-left fa-fw"></i><p>SatelliteCollections</p></a></span><span class=next><a class="nav nav-next link" href=/3.13/develop/transactions/><p>Transactions</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.13/develop/smartjoins.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#cluster-joins-without-being-smart>Cluster joins without being smart</a></div><div class=level-2><a href=#sharding-two-collections-identically-using-distributeshardslike>Sharding two collections identically using distributeShardsLike</a></div><div class=level-2><a href=#smartjoins-using-distributeshardslike>SmartJoins using distributeShardsLike</a></div><div class=level-2><a href=#smartjoins-using-smartjoinattribute>SmartJoins using smartJoinAttribute</a></div><div class=level-2><a href=#restricting-smartjoins-to-a-single-shard>Restricting SmartJoins to a single shard</a></div><div class=level-2><a href=#limitations>Limitations</a></div><div class=level-2><a href=#smartjoins-with-views>SmartJoins with Views</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
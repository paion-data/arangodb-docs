<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1747031427></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="The COLLECT operation can group data by one or multiple grouping criteria, retrieve all distinct values, count how often values occur, and calculate statistical properties efficiently"><meta property="og:url" content="http://localhost/3.13/aql/high-level-operations/collect/"><meta property="og:title" content="COLLECT operation in AQL"><meta property="og:type" content="website"><meta property="og:description" content="The COLLECT operation can group data by one or multiple grouping criteria, retrieve all distinct values, count how often values occur, and calculate statistical properties efficiently"><meta name=docsearch:version content="3.13"><title>COLLECT operation in AQL | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1747031427 defer></script>
<script src=/js/featherlight.min.js?1747031427 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1747031427 defer></script>
<script src=/js/theme.js?1747031427 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.13"><a itemprop=item class=link href=/3.13/><span itemprop=name class=breadcrumb-entry>3.13.0</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.13/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="High-level Operations"><a itemprop=item class=link href=/3.13/aql/high-level-operations/><span itemprop=name class=breadcrumb-entry>High-level Operations</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="COLLECT"><a itemprop=item class=link href=/3.13/aql/high-level-operations/collect/><span itemprop=name class=breadcrumb-entry>COLLECT</span></a></li></ol></nav><article class=default><div class="box notices cstyle warning"><div class=box-content-container><div class=box-content><i class="fas fa-exclamation-triangle"></i><div class=box-text><p>ArangoDB v3.13 is under development and not released yet.
This documentation is not final and potentially incomplete.</p></div></div></div></div><hgroup><h1><code>COLLECT</code> operation in AQL</h1><p class=lead>The <code>COLLECT</code> operation can group data by one or multiple grouping criteria, retrieve all distinct values, count how often values occur, and calculate statistical properties efficiently</p></hgroup><p>The different variants of <code>COLLECT</code> cover most needs for grouping and aggregating
data. For aggregation using a sliding window, see the <a href=/3.13/aql/high-level-operations/window/ class=link><code>WINDOW</code> operation</a>.</p><h2 id=syntax>Syntax <a href=/3.13/aql/high-level-operations/collect/#syntax class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>There are several syntax variants for <code>COLLECT</code> operations:</p><pre><code>COLLECT <em>variableName</em> = <em>expression</em>
COLLECT <em>variableName</em> = <em>expression</em> INTO <em>groupsVariable</em>
COLLECT <em>variableName</em> = <em>expression</em> INTO <em>groupsVariable</em> = <em>projectionExpression</em>
COLLECT <em>variableName</em> = <em>expression</em> INTO <em>groupsVariable</em> KEEP <em>keepVariable</em>
COLLECT <em>variableName</em> = <em>expression</em> WITH COUNT INTO <em>countVariable</em>
COLLECT <em>variableName</em> = <em>expression</em> AGGREGATE variableName = <em>aggregateExpression</em>
COLLECT <em>variableName</em> = <em>expression</em> AGGREGATE variableName = <em>aggregateExpression</em> INTO <em>groupsVariable</em>
COLLECT AGGREGATE <em>variableName</em> = <em>aggregateExpression</em>
COLLECT AGGREGATE <em>variableName</em> = <em>aggregateExpression</em> INTO <em>groupsVariable</em>
COLLECT WITH COUNT INTO <em>countVariable</em></code></pre><p>All variants can optionally end with an <code>OPTIONS { … }</code> clause.</p><div class="box notices cstyle info"><div class=box-content-container><div class=box-content><i class="fas fa-info-circle"></i><div class=box-text>The <code>COLLECT</code> operation eliminates all local variables in the current scope.
After a <code>COLLECT</code>, only the variables introduced by <code>COLLECT</code> itself are available.</div></div></div></div><h2 id=grouping-syntaxes>Grouping syntaxes <a href=/3.13/aql/high-level-operations/collect/#grouping-syntaxes class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The first syntax form of <code>COLLECT</code> only groups the result by the defined group
criteria specified in <em>expression</em>. In order to further process the results
produced by <code>COLLECT</code>, a new variable (specified by <em>variableName</em>) is introduced.
This variable contains the group value.</p><p>Here&rsquo;s an example query that find the distinct values in <code>u.city</code> and makes
them available in variable <code>city</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>The second form does the same as the first form, but additionally introduces a
variable (specified by <em>groupsVariable</em>) that contains all elements that fell into the
group. This works as follows: The <em>groupsVariable</em> variable is an array containing
as many elements as there are in the group. Each member of that array is
a JSON object in which the value of every variable that is defined in the
AQL query is bound to the corresponding attribute. Note that this considers
all variables that are defined before the <code>COLLECT</code> statement, but not those on
the top level (outside of any <code>FOR</code>), unless the <code>COLLECT</code> statement is itself
on the top level, in which case all variables are taken. Furthermore note
that it is possible that the optimizer moves <code>LET</code> statements out of <code>FOR</code>
statements to improve performance.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span> <span class=kr>INTO</span> <span class=n>groups</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;usersInCity&#34;</span> <span class=o>:</span> <span class=n>groups</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>In the above example, the array <code>users</code> will be grouped by the attribute
<code>city</code>. The result is a new array of documents, with one element per distinct
<code>u.city</code> value. The elements from the original array (here: <code>users</code>) per city are
made available in the variable <code>groups</code>. This is due to the <code>INTO</code> clause.</p><p><code>COLLECT</code> also allows specifying multiple group criteria. Individual group
criteria can be separated by commas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>country</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>country</span><span class=p>,</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span> <span class=kr>INTO</span> <span class=n>groups</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;country&#34;</span> <span class=o>:</span> <span class=n>country</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;usersInCity&#34;</span> <span class=o>:</span> <span class=n>groups</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>In the above example, the array <code>users</code> is grouped by country first and then
by city, and for each distinct combination of country and city, the users
will be returned.</p><h2 id=discarding-obsolete-variables>Discarding obsolete variables <a href=/3.13/aql/high-level-operations/collect/#discarding-obsolete-variables class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The third form of <code>COLLECT</code> allows rewriting the contents of the <em>groupsVariable</em>
using an arbitrary <em>projectionExpression</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>country</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>country</span><span class=p>,</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span> <span class=kr>INTO</span> <span class=n>groups</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;country&#34;</span> <span class=o>:</span> <span class=n>country</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;userNames&#34;</span> <span class=o>:</span> <span class=n>groups</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>In the above example, only the <em>projectionExpression</em> is <code>u.name</code>. Therefore,
only this attribute is copied into the <em>groupsVariable</em> for each document.
This is probably much more efficient than copying all variables from the scope into
the <em>groupsVariable</em> as it would happen without a <em>projectionExpression</em>.</p><div class="box notices cstyle tip"><div class=box-content-container><div class=box-content><i class="fas fa-check"></i><div class=box-text><p>You can also express such projections using an <a href=#aggregation class=link>Aggregation</a> with
the <code>PUSH()</code> function (introduced in v3.12.4):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>country</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>country</span><span class=p>,</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span> <span class=kr>AGGREGATE</span> <span class=n>groups</span> <span class=o>=</span> <span class=nf>PUSH</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;country&#34;</span> <span class=o>:</span> <span class=n>country</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;userNames&#34;</span> <span class=o>:</span> <span class=n>groups</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>The expression following <code>INTO</code> can also be used for arbitrary computations:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>country</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>country</span><span class=p>,</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span> <span class=kr>INTO</span> <span class=n>groups</span> <span class=o>=</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;name&#34;</span> <span class=o>:</span> <span class=n>u</span><span class=p>.</span><span class=n>name</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;isActive&#34;</span> <span class=o>:</span> <span class=n>u</span><span class=p>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;active&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;country&#34;</span> <span class=o>:</span> <span class=n>country</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;usersInCity&#34;</span> <span class=o>:</span> <span class=n>groups</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p><code>COLLECT</code> also provides an optional <code>KEEP</code> clause that can be used to control
which variables will be copied into the variable created by <code>INTO</code>. If no
<code>KEEP</code> clause is specified, all variables from the scope will be copied as
sub-attributes into the <em>groupsVariable</em>.
This is safe but can have a negative impact on performance if there
are many variables in scope or the variables contain massive amounts of data.</p><p>The following example limits the variables that are copied into the <em>groupsVariable</em>
to just <code>name</code>. The variables <code>u</code> and <code>someCalculation</code> also present in the scope
will not be copied into <em>groupsVariable</em> because they are not listed in the <code>KEEP</code> clause:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kd>LET</span> <span class=n>name</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>  <span class=kd>LET</span> <span class=n>someCalculation</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>value1</span> <span class=o>+</span> <span class=n>u</span><span class=p>.</span><span class=n>value2</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>city</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>city</span> <span class=kr>INTO</span> <span class=n>groups</span> <span class=kp>KEEP</span> <span class=n>name</span> 
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;city&#34;</span> <span class=o>:</span> <span class=n>city</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;userNames&#34;</span> <span class=o>:</span> <span class=n>groups</span><span class=p>[</span><span class=o>*</span><span class=p>].</span><span class=n>name</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p><code>KEEP</code> is only valid in combination with <code>INTO</code>. Only valid variable names can
be used in the <code>KEEP</code> clause. <code>KEEP</code> supports the specification of multiple
variable names.</p><h2 id=group-length-calculation>Group length calculation <a href=/3.13/aql/high-level-operations/collect/#group-length-calculation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p><code>COLLECT</code> also provides a special <code>WITH COUNT</code> clause that can be used to
determine the number of group members efficiently.</p><p>The simplest form just returns the number of items that made it into the
<code>COLLECT</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=kr>WITH</span> <span class=kp>COUNT</span> <span class=kr>INTO</span> <span class=n>length</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>length</span></span></span></code></pre></div><p>The above is equivalent to, but less efficient than:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=nf>LENGTH</span><span class=p>(</span><span class=n>users</span><span class=p>)</span></span></span></code></pre></div><p>The <code>WITH COUNT</code> clause can also be used to efficiently count the number
of items in each group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>age</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>age</span> <span class=kr>WITH</span> <span class=kp>COUNT</span> <span class=kr>INTO</span> <span class=n>length</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;age&#34;</span> <span class=o>:</span> <span class=n>age</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;count&#34;</span> <span class=o>:</span> <span class=n>length</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-content-container><div class=box-content><i class="fas fa-info-circle"></i><div class=box-text>The <code>WITH COUNT</code> clause can only be used together with an <code>INTO</code> clause.</div></div></div></div><h2 id=aggregation>Aggregation <a href=/3.13/aql/high-level-operations/collect/#aggregation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>You can use <code>COLLECT</code> operations with an <code>AGGREGATE</code> clause to aggregate the
data per group, such as determining the minimum, maximum, and average values,
the sums, and more.</p><p>To only determine the group lengths, you can use the <code>WITH COUNT INTO</code> variant of
<code>COLLECT</code> as described above. However, you can also express the same as an aggregation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>age</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>age</span> <span class=kr>AGGREGATE</span> <span class=n>length</span> <span class=o>=</span> <span class=nf>COUNT</span><span class=p>()</span>  <span class=c1>// or SUM(1)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>RETURN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;age&#34;</span> <span class=o>:</span> <span class=n>age</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;count&#34;</span> <span class=o>:</span> <span class=n>length</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>If you perform calculations on the results of a <code>COLLECT</code> operation, you may be
able rewrite them to <code>COLLECT ... AGGREGATE</code>. The following example shows a
post-aggregation where the calculation happens after grouping:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>ageGroup</span> <span class=o>=</span> <span class=nf>FLOOR</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>age</span> <span class=o>/</span> <span class=mi>5</span><span class=p>)</span> <span class=o>*</span> <span class=mi>5</span> <span class=kr>INTO</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ageGroup&#34;</span> <span class=o>:</span> <span class=n>ageGroup</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;minAge&#34;</span> <span class=o>:</span> <span class=nf>MIN</span><span class=p>(</span><span class=n>g</span><span class=p>[</span><span class=o>*</span><span class=p>].</span><span class=n>u</span><span class=p>.</span><span class=n>age</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;maxAge&#34;</span> <span class=o>:</span> <span class=nf>MAX</span><span class=p>(</span><span class=n>g</span><span class=p>[</span><span class=o>*</span><span class=p>].</span><span class=n>u</span><span class=p>.</span><span class=n>age</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>The above however requires storing all group values during the collect operation for
all groups, which can be inefficient.</p><p>The special <code>AGGREGATE</code> variant of <code>COLLECT</code> allows building the aggregate values
incrementally during the collect operation, and is therefore often more efficient.</p><p>With the <code>AGGREGATE</code> variant, the above query becomes the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>ageGroup</span> <span class=o>=</span> <span class=nf>FLOOR</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>age</span> <span class=o>/</span> <span class=mi>5</span><span class=p>)</span> <span class=o>*</span> <span class=mi>5</span> 
</span></span><span class=line><span class=cl>  <span class=kr>AGGREGATE</span> <span class=n>minAge</span> <span class=o>=</span> <span class=nf>MIN</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>age</span><span class=p>),</span> <span class=n>maxAge</span> <span class=o>=</span> <span class=nf>MAX</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>age</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ageGroup</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>minAge</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>maxAge</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>The <code>AGGREGATE</code> keyword can only be used after the <code>COLLECT</code> keyword. If used, it
must directly follow the declaration of the grouping keys. If no grouping keys
are used, it must follow the <code>COLLECT</code> keyword directly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=kr>AGGREGATE</span> <span class=n>minAge</span> <span class=o>=</span> <span class=nf>MIN</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>age</span><span class=p>),</span> <span class=n>maxAge</span> <span class=o>=</span> <span class=nf>MAX</span><span class=p>(</span><span class=n>u</span><span class=p>.</span><span class=n>age</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>minAge</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>maxAge</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div><p>Only specific expressions are allowed on the right-hand side of each <code>AGGREGATE</code>
assignment:</p><ul><li><p>On the top level, an aggregate expression must be a call to one of the
supported aggregation functions:</p><ul><li><code>LENGTH()</code> / <code>COUNT()</code></li><li><code>MIN()</code></li><li><code>MAX()</code></li><li><code>SUM()</code></li><li><code>AVERAGE()</code> / <code>AVG()</code></li><li><code>STDDEV_POPULATION()</code> / <code>STDDEV()</code></li><li><code>STDDEV_SAMPLE()</code></li><li><code>VARIANCE_POPULATION()</code> / <code>VARIANCE()</code></li><li><code>VARIANCE_SAMPLE()</code></li><li><code>UNIQUE()</code></li><li><code>SORTED_UNIQUE()</code></li><li><code>COUNT_DISTINCT()</code> / <code>COUNT_UNIQUE()</code></li><li><code>BIT_AND()</code></li><li><code>BIT_OR()</code></li><li><code>BIT_XOR()</code></li><li><code>PUSH()</code> (introduced in v3.12.4)</li></ul></li><li><p>An aggregate expression must not refer to variables introduced by the <code>COLLECT</code> itself.</p></li></ul><h2 id=collect-vs-return-distinct><code>COLLECT</code> vs. <code>RETURN DISTINCT</code> <a href=/3.13/aql/high-level-operations/collect/#collect-vs-return-distinct class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In order to make a result set unique, one can either use <code>COLLECT</code> or
<code>RETURN DISTINCT</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=kr>DISTINCT</span> <span class=n>u</span><span class=p>.</span><span class=n>age</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>age</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>age</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>age</span></span></span></code></pre></div><p>Behind the scenes, both variants create a <em>CollectNode</em>. However, they use
different implementations of <code>COLLECT</code> that have different properties:</p><ul><li><p><code>RETURN DISTINCT</code> <strong>maintains the order of results</strong>, but it is limited to
a single value.</p></li><li><p><code>COLLECT</code> <strong>changes the order of results</strong> (sorted or undefined), but it
supports multiple values and is more flexible than <code>RETURN DISTINCT</code>.</p></li></ul><p>Aside from <code>COLLECT</code>s sophisticated grouping and aggregation capabilities, it
allows you to place a <code>LIMIT</code> operation before <code>RETURN</code> to potentially stop the
<code>COLLECT</code> operation early.</p><h2 id=collect-options><code>COLLECT</code> options <a href=/3.13/aql/high-level-operations/collect/#collect-options class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><h3 id=disableindex><code>disableIndex</code> <a href=/3.13/aql/high-level-operations/collect/#disableindex class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p><small>Introduced in: v3.12.4</small></p><p>You can disable the <code>use-index-for-collect</code> optimization for individual
<code>COLLECT</code> operations by setting this option to <code>true</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>COLLECT</span> <span class=o>..</span><span class=p>.</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>disableIndex</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span></span></span></code></pre></div><p>The optimization improves the scanning for distinct values using <code>COLLECT</code> if a
usable persistent index is present. It is automatically disabled if the
selectivity is high, i.e. there are many different values, or if there is
filtering or an <code>INTO</code> or <code>AGGREGATE</code> clause.</p><h3 id=method><code>method</code> <a href=/3.13/aql/high-level-operations/collect/#method class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>There are two variants of <code>COLLECT</code> that the optimizer can choose from:
the <em>sorted</em> and the <em>hash</em> variant. The <code>method</code> option can be used in a
<code>COLLECT</code> statement to inform the optimizer about the preferred method,
<code>"sorted"</code> or <code>"hash"</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>COLLECT</span> <span class=o>..</span><span class=p>.</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>method</span><span class=o>:</span> <span class=s2>&#34;sorted&#34;</span> <span class=p>}</span></span></span></code></pre></div><p>If no method is specified by the user, then the optimizer will create a plan
that uses the <em>sorted</em> method, and an additional plan using the <em>hash</em> method
if the <code>COLLECT</code> statement qualifies for it.</p><p>If the method is explicitly set to <em>sorted</em>, then the optimizer will always use
the <em>sorted</em> variant of <code>COLLECT</code> and not even create a plan using the <em>hash</em>
variant. If it is explicitly set to <em>hash</em>, then the optimizer will create a
plan using the <em>hash</em> method <strong>only if the <code>COLLECT</code> statement qualifies</strong>.
Not all <code>COLLECT</code> statements can use the <em>hash</em> method, in particular ones that
do not perform any grouping. In case the <code>COLLECT</code> statement qualifies,
there will only be one plan that uses the <em>hash</em> method. Otherwise, the
optimizer will default to the <em>sorted</em> method.</p><p>The <em>sorted</em> method requires its input to be sorted by the group criteria
specified in the <code>COLLECT</code> clause. To ensure correctness of the result, the
optimizer will automatically insert a <code>SORT</code> operation into the query in front
of the <code>COLLECT</code> statement. The optimizer may be able to optimize away that
<code>SORT</code> operation later if a sorted index is present on the group criteria.</p><p>In case a <code>COLLECT</code> statement qualifies for using the <em>hash</em> variant, the
optimizer will create an extra plan for it at the beginning of the planning
phase. In this plan, no extra <code>SORT</code> statement will be added in front of the
<code>COLLECT</code>. This is because the <em>hash</em> variant of <code>COLLECT</code> does not require
sorted input. Instead, a <code>SORT</code> statement will be added after the <code>COLLECT</code> to
sort its output. This <code>SORT</code> statement may be optimized away again in later
stages.</p><p>If the sort order of the <code>COLLECT</code> is irrelevant to the user, adding the extra
instruction <code>SORT null</code> after the <code>COLLECT</code> will allow the optimizer to remove
the sorts altogether:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>u</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>  <span class=kr>COLLECT</span> <span class=n>age</span> <span class=o>=</span> <span class=n>u</span><span class=p>.</span><span class=n>age</span>
</span></span><span class=line><span class=cl>  <span class=kr>SORT</span> <span class=kc>null</span>  <span class=cm>/* note: will be optimized away */</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>age</span></span></span></code></pre></div><p>Which <code>COLLECT</code> variant is used by the optimizer if no preferred method is set
explicitly depends on the optimizer&rsquo;s cost estimations. The created plans with
the different <code>COLLECT</code> variants will be shipped through the regular
optimization pipeline. In the end, the optimizer will pick the plan with the
lowest estimated total cost as usual.</p><p>In general, the <em>sorted</em> variant of <code>COLLECT</code> should be preferred in cases when
there is a sorted index present on the group criteria. In this case the
optimizer can eliminate the <code>SORT</code> operation in front of the <code>COLLECT</code>, so that
no <code>SORT</code> will be left.</p><p>If there is no sorted index available on the group criteria, the up-front sort
required by the <em>sorted</em> variant can be expensive. In this case it is likely
that the optimizer will prefer the <em>hash</em> variant of <code>COLLECT</code>, which does not
require its input to be sorted.</p><p>Which variant of <code>COLLECT</code> will actually be used can be figured out by looking
at the execution plan of a query, specifically the comment of the <em>CollectNode</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=n>Execution</span> <span class=n>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=n>Id</span>   <span class=n>NodeType</span>                  <span class=n>Est</span><span class=p>.</span>   <span class=n>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=n>SingletonNode</span>                <span class=mi>1</span>   <span class=o>*</span> <span class=n>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=n>EnumerateCollectionNode</span>      <span class=mi>5</span>     <span class=o>-</span> <span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>coll</span>   <span class=cm>/* full collection scan, projections: `name` */</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=n>CalculationNode</span>              <span class=mi>5</span>       <span class=o>-</span> <span class=kd>LET</span> <span class=nl>#2</span> <span class=o>=</span> <span class=n>doc</span><span class=p>.</span><span class=n>`name`</span>   <span class=cm>/* attribute expression */</span>   <span class=cm>/* collections used: doc : coll */</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=n>CollectNode</span>                  <span class=mi>5</span>       <span class=o>-</span> <span class=kr>COLLECT</span> <span class=n>name</span> <span class=o>=</span> <span class=nl>#2</span>   <span class=cm>/* hash */</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=n>SortNode</span>                     <span class=mi>5</span>       <span class=o>-</span> <span class=kr>SORT</span> <span class=n>name</span> <span class=kr>ASC</span>   <span class=cm>/* sorting strategy: standard */</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=n>ReturnNode</span>                   <span class=mi>5</span>       <span class=o>-</span> <span class=kr>RETURN</span> <span class=n>name</span></span></span></code></pre></div><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.13/aql/high-level-operations/let/><i class="fas fa-chevron-left fa-fw"></i><p>LET</p></a></span><span class=next><a class="nav nav-next link" href=/3.13/aql/high-level-operations/window/><p>WINDOW</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.13/aql/high-level-operations/collect.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#syntax>Syntax</a></div><div class=level-2><a href=#grouping-syntaxes>Grouping syntaxes</a></div><div class=level-2><a href=#discarding-obsolete-variables>Discarding obsolete variables</a></div><div class=level-2><a href=#group-length-calculation>Group length calculation</a></div><div class=level-2><a href=#aggregation>Aggregation</a></div><div class=level-2><a href=#collect-vs-return-distinct><code>COLLECT</code> vs. <code>RETURN DISTINCT</code></a></div><div class=level-2><a href=#collect-options><code>COLLECT</code> options</a></div><div class=level-3><a href=#disableindex><code>disableIndex</code></a></div><div class=level-3><a href=#method><code>method</code></a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
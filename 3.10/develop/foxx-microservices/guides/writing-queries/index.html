<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743774193></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="ArangoDB is a scalable graph database system with native support for other data models and a built-in search engine, for the cloud and on-premises"><meta property="og:url" content="http://localhost/3.10/develop/foxx-microservices/guides/writing-queries/"><meta property="og:title" content="Writing queries in Foxx services"><meta property="og:type" content="website"><meta property="og:description" content="ArangoDB is a scalable graph database system with native support for other data models and a built-in search engine, for the cloud and on-premises"><meta name=docsearch:version content="3.10"><title>Writing queries in Foxx services | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743774193 defer></script>
<script src=/js/featherlight.min.js?1743774193 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743774193 defer></script>
<script src=/js/theme.js?1743774193 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.10"><a itemprop=item class=link href=/3.10/><span itemprop=name class=breadcrumb-entry>3.10.14</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Develop"><a itemprop=item class=link href=/3.10/develop/><span itemprop=name class=breadcrumb-entry>Develop</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Foxx Microservices"><a itemprop=item class=link href=/3.10/develop/foxx-microservices/><span itemprop=name class=breadcrumb-entry>Foxx Microservices</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Guides"><a itemprop=item class=link href=/3.10/develop/foxx-microservices/guides/><span itemprop=name class=breadcrumb-entry>Guides</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Writing queries"><a itemprop=item class=link href=/3.10/develop/foxx-microservices/guides/writing-queries/><span itemprop=name class=breadcrumb-entry>Writing queries</span></a></li></ol></nav><article class=default><div class="box notices cstyle warning"><div class=box-content-container><div class=box-content><i class="fas fa-exclamation-triangle"></i><div class=box-text><p>ArangoDB v3.10 reached End of Life (EOL) and is no longer supported.</p><p>This documentation is outdated. Please see the most recent <a href=/3.12/develop/foxx-microservices/guides/writing-queries/ class=link>stable version</a>.</p></div></div></div></div><hgroup><h1>Writing queries in Foxx services</h1></hgroup><p>ArangoDB provides the <code>query</code> template string handler
(or <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals target=_blank rel="noopener noreferrer" class=link>template tag</a>&nbsp;<i class="fas fa-external-link-alt"></i>)
to make it easy to write and execute <a href=/3.10/aql/ class=link>AQL queries</a>
in your Foxx services:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>query</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>max</span> <span class=o>=</span> <span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>oddNumbers</span> <span class=o>=</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR i IN 1..</span><span class=si>${</span><span class=nx>max</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  FILTER i % 2 == 1
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN i
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>oddNumbers</span><span class=p>);</span> <span class=c1>// 1,3,5,7,9,11,13
</span></span></span></code></pre></div><p>Any values passed via interpolation (i.e. using the <code>${expression}</code> syntax)
are passed to ArangoDB as
<a href=/3.10/aql/fundamentals/bind-parameters/ class=link>AQL bind parameters</a>,
so you don&rsquo;t have to worry about escaping them in order to protect against
injection attacks in user-supplied data.</p><p>The result of the executed query is
<a href=/3.10/aql/how-to-invoke-aql/with-arangosh/#cursors class=link>an ArangoDB array cursor</a>.
You can extract all query results using the <code>toArray()</code> method or
step through the result set using the <code>next()</code> method.</p><p>You can also consume a cursor with a for-loop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR i IN 1..5
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN i
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>item</span> <span class=k>of</span> <span class=nx>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>item</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>It is also possible to pass options to the query helper:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>query</span><span class=p>({</span> <span class=nx>fullCount</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR i IN 1..1000
</span></span></span><span class=line><span class=cl><span class=sb>  LIMIT 0, 100
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN i
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>fullCount</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>cursor</span><span class=p>.</span><span class=nx>getExtra</span><span class=p>().</span><span class=nx>stats</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>fullCount</span><span class=si>}</span><span class=sb> total`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>cursor</span><span class=p>.</span><span class=nx>toArray</span><span class=p>());</span></span></span></code></pre></div><h2 id=using-collections>Using collections <a href=/3.10/develop/foxx-microservices/guides/writing-queries/#using-collections class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>When <a href=/3.10/develop/foxx-microservices/guides/working-with-collections/ class=link>working with collections in your service</a> you generally
want to avoid hardcoding exact collection names. But if you pass a
collection name directly to a query it will be treated as a string:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// THIS DOES NOT WORK
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collectionName</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// e.g. &#34;myfoxx_users&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>admins</span> <span class=o>=</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR user IN </span><span class=si>${</span><span class=nx>users</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  FILTER user.isAdmin
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN user
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span> <span class=c1>// ERROR
</span></span></span></code></pre></div><p>Instead you need to pass an ArangoDB collection object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// users is now a collection, not a string
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>admins</span> <span class=o>=</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR user IN </span><span class=si>${</span><span class=nx>users</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  FILTER user.isAdmin
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN user
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>Note that you don&rsquo;t need to use any different syntax to use
a collection in a query, but you do need to make sure the collection is
an actual ArangoDB collection object rather than a plain string.</p><h2 id=low-level-access>Low-level access <a href=/3.10/develop/foxx-microservices/guides/writing-queries/#low-level-access class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In addition to the <code>query</code> template tag, ArangoDB also provides
the <code>aql</code> template tag, which only generates a query object
but doesn&rsquo;t execute it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>db</span><span class=p>,</span> <span class=nx>aql</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>max</span> <span class=o>=</span> <span class=mi>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>query</span> <span class=o>=</span> <span class=nx>aql</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR i IN 1..</span><span class=si>${</span><span class=nx>max</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN i
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>numbers</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>You can also use the <code>db._query</code> method to execute queries using
plain strings and passing the bind parameters as an object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Note the lack of a tag, this is a normal string
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>query</span> <span class=o>=</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR user IN @@users
</span></span></span><span class=line><span class=cl><span class=sb>  FILTER user.isAdmin
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN user
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>admins</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We&#39;re passing a string instead of a collection
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// because this is an explicit collection bind parameter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// using the AQL double-at notation
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=s2>&#34;@users&#34;</span><span class=o>:</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collectionName</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>Note that when using plain strings as queries ArangoDB provides
no safeguards to prevent accidental AQL injections:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Malicious user input where you might expect a number
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>evil</span> <span class=o>=</span> <span class=s2>&#34;1 FOR u IN myfoxx_users REMOVE u IN myfoxx_users&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// DO NOT DO THIS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>numbers</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR i IN 1..</span><span class=si>${</span><span class=nx>evil</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN i
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// Actual query executed by the code:
</span></span></span><span class=line><span class=cl><span class=c1>// FOR i IN 1..1
</span></span></span><span class=line><span class=cl><span class=c1>// FOR u IN myfoxx_users
</span></span></span><span class=line><span class=cl><span class=c1>// REMOVE u IN myfoxx_users
</span></span></span><span class=line><span class=cl><span class=c1>// RETURN i
</span></span></span></code></pre></div><p>If possible, you should always use the <code>query</code> or <code>aql</code> template tags
rather than passing raw query strings to <code>db._query</code> directly.</p><h2 id=aql-fragments>AQL fragments <a href=/3.10/develop/foxx-microservices/guides/writing-queries/#aql-fragments class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>If you need to insert AQL snippets dynamically, you can still use
the <code>query</code> template tag by using the <code>aql.literal</code> helper function to
mark the snippet as a raw AQL fragment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>filter</span> <span class=o>=</span> <span class=nx>aql</span><span class=p>.</span><span class=nx>literal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>adminsOnly</span> <span class=o>?</span> <span class=s1>&#39;FILTER user.isAdmin&#39;</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR user IN </span><span class=si>${</span><span class=nx>users</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  </span><span class=si>${</span><span class=nx>filter</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN user
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>Both the <code>query</code> and <code>aql</code> template tags understand fragments marked
with the <code>aql.literal</code> helper and inline them directly into the query
instead of converting them to bind parameters.</p><p>Note that because the <code>aql.literal</code> helper takes a raw string as argument
the same security implications apply to it as when writing raw AQL queries
using plain strings:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Malicious user input where you might expect a condition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>evil</span> <span class=o>=</span> <span class=s2>&#34;true REMOVE u IN myfoxx_users&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// DO NOT DO THIS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>filter</span> <span class=o>=</span> <span class=nx>aql</span><span class=p>.</span><span class=nx>literal</span><span class=p>(</span><span class=sb>`FILTER </span><span class=si>${</span><span class=nx>evil</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR user IN </span><span class=si>${</span><span class=nx>users</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  </span><span class=si>${</span><span class=nx>filter</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN user
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// Actual query executed by the code:
</span></span></span><span class=line><span class=cl><span class=c1>// FOR user IN myfoxx_users
</span></span></span><span class=line><span class=cl><span class=c1>// FILTER true
</span></span></span><span class=line><span class=cl><span class=c1>// REMOVE user IN myfoxx_users
</span></span></span><span class=line><span class=cl><span class=c1>// RETURN user
</span></span></span></code></pre></div><p>A typical scenario that might result in an exploit like this is taking
arbitrary strings from a search UI to filter or sort results by a field name.
Make sure to restrict what values you accept.</p><h2 id=managing-queries-in-your-service>Managing queries in your service <a href=/3.10/develop/foxx-microservices/guides/writing-queries/#managing-queries-in-your-service class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In many cases it may be initially more convenient to perform queries
right where you use their results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/emails&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>    FOR u IN </span><span class=si>${</span><span class=nx>users</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>    FILTER u.active
</span></span></span><span class=line><span class=cl><span class=sb>    RETURN u.email
</span></span></span><span class=line><span class=cl><span class=sb>  `</span><span class=p>.</span><span class=nx>toArray</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>However to <a href=/3.10/develop/foxx-microservices/guides/testing-foxx-services/ class=link>help testability</a> and make the queries more reusable,
it&rsquo;s often a good idea to move them out of your request handlers
into separate functions, e.g.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// in queries/get-user-emails.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s2>&#34;use strict&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>aql</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>(</span><span class=nx>activeOnly</span> <span class=o>=</span> <span class=kc>true</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>query</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR user IN </span><span class=si>${</span><span class=nx>users</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  </span><span class=si>${</span><span class=nx>aql</span><span class=p>.</span><span class=nx>literal</span><span class=p>(</span><span class=nx>activeOnly</span> <span class=o>?</span> <span class=s2>&#34;FILTER user.active&#34;</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN user.email
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// in your router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>getUserEmails</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;../queries/get-user-emails&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/active-emails&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>getUserEmails</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/all-emails&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>getUserEmails</span><span class=p>(</span><span class=kc>false</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.10/develop/foxx-microservices/guides/working-with-collections/><i class="fas fa-chevron-left fa-fw"></i><p>Working with collections</p></a></span><span class=next><a class="nav nav-next link" href=/3.10/develop/foxx-microservices/guides/development-mode/><p>Development mode</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.10/develop/foxx-microservices/guides/writing-queries.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#using-collections>Using collections</a></div><div class=level-2><a href=#low-level-access>Low-level access</a></div><div class=level-2><a href=#aql-fragments>AQL fragments</a></div><div class=level-2><a href=#managing-queries-in-your-service>Managing queries in your service</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1747031427></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="ArangoDB is a scalable graph database system with native support for other data models and a built-in search engine, for the cloud and on-premises"><meta property="og:url" content="http://localhost/3.10/develop/transactions/locking-and-isolation/"><meta property="og:title" content="Locking and isolation of transactions"><meta property="og:type" content="website"><meta property="og:description" content="ArangoDB is a scalable graph database system with native support for other data models and a built-in search engine, for the cloud and on-premises"><meta name=docsearch:version content="3.10"><title>Locking and isolation of transactions | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1747031427 defer></script>
<script src=/js/featherlight.min.js?1747031427 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1747031427 defer></script>
<script src=/js/theme.js?1747031427 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.10"><a itemprop=item class=link href=/3.10/><span itemprop=name class=breadcrumb-entry>3.10.14</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Develop"><a itemprop=item class=link href=/3.10/develop/><span itemprop=name class=breadcrumb-entry>Develop</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Transactions"><a itemprop=item class=link href=/3.10/develop/transactions/><span itemprop=name class=breadcrumb-entry>Transactions</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Locking and isolation"><a itemprop=item class=link href=/3.10/develop/transactions/locking-and-isolation/><span itemprop=name class=breadcrumb-entry>Locking and isolation</span></a></li></ol></nav><article class=default><div class="box notices cstyle warning"><div class=box-content-container><div class=box-content><i class="fas fa-exclamation-triangle"></i><div class=box-text><p>ArangoDB v3.10 reached End of Life (EOL) and is no longer supported.</p><p>This documentation is outdated. Please see the most recent <a href=/3.12/develop/transactions/locking-and-isolation/ class=link>stable version</a>.</p></div></div></div></div><hgroup><h1>Locking and isolation of transactions</h1></hgroup><p>Transactions need to specify from which collections they will read data and which
collections they intend to modify. This can be done by setting the <code>read</code>, <code>write</code>,
or <code>exclusive</code> attributes in the <code>collections</code> attribute of the transaction:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_executeTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>collections</span><span class=o>:</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>read</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>write</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;test&#34;</span><span class=p>,</span> <span class=s2>&#34;log&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>action</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>).</span><span class=nx>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>users</span><span class=p>.</span><span class=nx>toArray</span><span class=p>().</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>doc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>db</span><span class=p>.</span><span class=nx>log</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>value</span><span class=o>:</span> <span class=s2>&#34;removed user: &#34;</span> <span class=o>+</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>name</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=nx>doc</span><span class=p>.</span><span class=nx>_key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p><em>write</em> here means write access to the collection, and also includes any read accesses.</p><p><em>exclusive</em> means exclusive write access to the collection, and <em>write</em> means (shared)
write access to the collection, which can be interleaved with write accesses by other
concurrent transactions.</p><h2 id=storage-engine>Storage engine <a href=/3.10/develop/transactions/locking-and-isolation/#storage-engine class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The RocksDB storage engine does not lock any collections participating in a transaction
for read. Read operations can run in parallel to other read or write operations on the
same collections.</p><h3 id=locking>Locking <a href=/3.10/develop/transactions/locking-and-isolation/#locking class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>For all collections that are used in write mode, the RocksDB engine will internally
acquire a (shared) read lock. This means that many writers can modify data in the same
collection in parallel (and also run in parallel to ongoing reads). However, if two
concurrent transactions attempt to modify the same document or index entry, there will
be a write-write conflict, and one of the transactions will abort with error 1200
(&ldquo;conflict&rdquo;). It is then up to client applications to retry the failed transaction or
accept the failure.</p><p>In order to guard long-running or complex transactions against concurrent operations
on the same data, the RocksDB engine allows to access collections in exclusive mode.
Exclusive accesses will internally acquire a write-lock on the collections, so they
are not executed in parallel with any other write operations. Read operations can still
be carried out by other concurrent transactions.</p><h3 id=isolation>Isolation <a href=/3.10/develop/transactions/locking-and-isolation/#isolation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The RocksDB storage-engine provides <em>snapshot isolation</em>. This means that all operations
and queries in the transactions will see the same version, or snapshot, of the database.
This snapshot is based on the state of the database at the moment in time when the transaction
begins. No locks are acquired on the underlying data to keep this snapshot, which permits
other transactions to execute without being blocked by an older uncompleted transaction
(so long as they do not try to modify the same documents or unique index-entries concurrently).
In the cluster a snapshot is acquired on each DB-Server individually.</p><h2 id=lazily-adding-collections>Lazily adding collections <a href=/3.10/develop/transactions/locking-and-isolation/#lazily-adding-collections class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>There might be situations when declaring all collections a priori is not possible,
for example, because further collections are determined by a dynamic AQL query
inside the transaction, for example a query using AQL graph traversal.</p><p>In this case, it would be impossible to know beforehand which collection to lock, and
thus it is legal to not declare collections that will be accessed in the transaction in
read-only mode. Accessing a non-declared collection in read-only mode during a
transaction will add the collection to the transaction lazily, and fetch data
from the collection as usual. However, as the collection is added lazily, there is no
isolation from other concurrent operations or transactions. Reads from such
collections are potentially non-repeatable.</p><p><strong>Examples:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_executeTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>collections</span><span class=o>:</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>read</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>action</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>).</span><span class=nx>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Execute an AQL query that traverses a graph starting at a &#34;users&#34; vertex.
</span></span></span><span class=line><span class=cl><span class=cm>       It is yet unknown into which other collections the query might traverse */</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>_createStatement</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>      <span class=nx>query</span><span class=o>:</span> <span class=sb>`FOR v IN ANY &#34;users/1234&#34; connections RETURN v`</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nx>execute</span><span class=p>().</span><span class=nx>toArray</span><span class=p>().</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>d</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>This automatic lazy addition of collections to a transaction also introduces the
possibility of deadlocks. Deadlocks may occur if there are concurrent transactions
that try to acquire locks on the same collections lazily.</p><p>In order to make a transaction fail when a non-declared collection is used inside
a transaction for reading, the optional <em>allowImplicit</em> sub-attribute of <em>collections</em>
can be set to <em>false</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_executeTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>collections</span><span class=o>:</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>read</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowImplicit</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>action</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* The below query will now fail because the collection &#34;connections&#34; has not
</span></span></span><span class=line><span class=cl><span class=cm>       been specified in the list of collections used by the transaction */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>).</span><span class=nx>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>_createStatement</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>      <span class=nx>query</span><span class=o>:</span> <span class=sb>`FOR v IN ANY &#34;users/1234&#34; connections RETURN v`</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nx>execute</span><span class=p>().</span><span class=nx>toArray</span><span class=p>().</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>d</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>The default value for <em>allowImplicit</em> is <em>true</em>. Write-accessing collections that
have not been declared in the <em>collections</em> array is never possible, regardless of
the value of <em>allowImplicit</em>.</p><p>If <em>users/1234</em> has an edge in <em>connections</em>, linking it to another document in
the <em>users</em> collection, then the following explicit declaration will work:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_executeTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>collections</span><span class=o>:</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>read</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;users&#34;</span><span class=p>,</span> <span class=s2>&#34;connections&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowImplicit</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* ... */</span></span></span></code></pre></div><p>If the edge points to a document in another collection however, then the query
will fail, unless that other collection is added to the declaration as well.</p><p>Note that if a document handle is used as starting point for a traversal, e.g.
<code>FOR v IN ANY "users/not_linked" ...</code> or <code>FOR v IN ANY {_id: "users/not_linked"} ...</code>,
then no error is raised in the case of the start vertex not having any edges to
follow, with <code>allowImplicit: false</code> and <em>users</em> not being declared for read access.
AQL only sees a string and does not consider it a read access, unless there are
edges connected to it. <code>FOR v IN ANY DOCUMENT("users/not_linked") ...</code> will fail
even without edges, as it is always considered to be a read access to the <em>users</em>
collection.</p><h2 id=deadlocks-and-deadlock-detection>Deadlocks and Deadlock detection <a href=/3.10/develop/transactions/locking-and-isolation/#deadlocks-and-deadlock-detection class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>A deadlock is a situation in which two or more concurrent operations (user transactions
or AQL queries) try to access the same resources (collections, documents) and need to
wait for the others to finish, but none of them can make any progress.</p><p>A good example for a deadlock is two concurrently executing transactions T1 and T2 that
try to access the same collections but that need to wait for each other. In this example,
transaction T1 will write to collection <code>c1</code>, but will also read documents from
collection <code>c2</code> without announcing it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_executeTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>collections</span><span class=o>:</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>write</span><span class=o>:</span> <span class=s2>&#34;c1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>action</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>).</span><span class=nx>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write into c1 (announced) */</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>foo</span><span class=o>:</span> <span class=s2>&#34;bar&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* some operation here that takes long to execute... */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read from c2 (unannounced) */</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Transaction T2 announces to write into collection <code>c2</code>, but will also read
documents from collection <code>c1</code> without announcing it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_executeTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>collections</span><span class=o>:</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>write</span><span class=o>:</span> <span class=s2>&#34;c2&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>action</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>).</span><span class=nx>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write into c2 (announced) */</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>c2</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=nx>bar</span><span class=o>:</span> <span class=s2>&#34;baz&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* some operation here that takes long to execute... */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read from c1 (unannounced) */</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>.</span><span class=nx>c1</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>In the above example, a deadlock will occur if transaction T1 and T2 have both
acquired their write locks (T1 for collection <code>c1</code> and T2 for collection <code>c2</code>) and
are then trying to read from the other other (T1 will read from <code>c2</code>, T2 will read
from <code>c1</code>). T1 will then try to acquire the read lock on collection <code>c2</code>, which
is prevented by transaction T2. T2 however will wait for the read lock on
collection <code>c1</code>, which is prevented by transaction T1.</p><p>In case of such deadlock, there would be no progress for any of the involved
transactions, and none of the involved transactions could ever complete. This is
completely undesirable, so the automatic deadlock detection mechanism in ArangoDB
will automatically abort one of the transactions involved in such deadlock. Aborting
means that all changes done by the transaction will be rolled back and error 29
(<code>deadlock detected</code>) will be thrown.</p><p>Client code (AQL queries, user transactions) that accesses more than one collection
should be aware of the potential of deadlocks and should handle the error 29
(<code>deadlock detected</code>) properly, either by passing the exception to the caller or
retrying the operation.</p><p>To avoid both deadlocks and non-repeatable reads, all collections used in a
transaction should be specified in the <code>collections</code> attribute when known in advance.
In case this is not possible because collections are added dynamically inside the
transaction, deadlocks may occur and the deadlock detection may kick in and abort
the transaction.</p><p>The RocksDB storage engine uses document-level locks and therefore will not have a deadlock
problem on collection level. If two concurrent transactions however modify the same
documents or index entries, the RocksDB engine will signal a write-write conflict
and abort one of the transactions with error 1200 (&ldquo;conflict&rdquo;) automatically.</p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.10/develop/transactions/stream-transactions/><i class="fas fa-chevron-left fa-fw"></i><p>Stream Transactions</p></a></span><span class=next><a class="nav nav-next link" href=/3.10/develop/transactions/durability/><p>Durability</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.10/develop/transactions/locking-and-isolation.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#storage-engine>Storage engine</a></div><div class=level-3><a href=#locking>Locking</a></div><div class=level-3><a href=#isolation>Isolation</a></div><div class=level-2><a href=#lazily-adding-collections>Lazily adding collections</a></div><div class=level-2><a href=#deadlocks-and-deadlock-detection>Deadlocks and Deadlock detection</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
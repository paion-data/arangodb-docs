<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743775370></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="AQL offers an UPSERT operation and an INSERT operation with different overwrite modes, and you can alternatively use the Document API, each having different features and performance characteristics"><meta property="og:url" content="http://localhost/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/"><meta property="og:title" content="Conditionally Inserting and Modifying Documents"><meta property="og:type" content="website"><meta property="og:description" content="AQL offers an UPSERT operation and an INSERT operation with different overwrite modes, and you can alternatively use the Document API, each having different features and performance characteristics"><meta name=docsearch:version content="3.10"><title>Conditionally Inserting and Modifying Documents | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743775370 defer></script>
<script src=/js/featherlight.min.js?1743775370 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743775370 defer></script>
<script src=/js/theme.js?1743775370 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.10"><a itemprop=item class=link href=/3.10/><span itemprop=name class=breadcrumb-entry>3.10.14</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.10/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Examples & Query Patterns"><a itemprop=item class=link href=/3.10/aql/examples-and-query-patterns/><span itemprop=name class=breadcrumb-entry>Examples & Query Patterns</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Upsert / Repsert Guide"><a itemprop=item class=link href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/><span itemprop=name class=breadcrumb-entry>Upsert / Repsert Guide</span></a></li></ol></nav><article class=default><div class="box notices cstyle warning"><div class=box-content-container><div class=box-content><i class="fas fa-exclamation-triangle"></i><div class=box-text><p>ArangoDB v3.10 reached End of Life (EOL) and is no longer supported.</p><p>This documentation is outdated. Please see the most recent <a href=/3.12/aql/examples-and-query-patterns/upsert-repsert-guide/ class=link>stable version</a>.</p></div></div></div></div><hgroup><h1>Conditionally Inserting and Modifying Documents</h1><p class=lead>AQL offers an <code>UPSERT</code> operation and an <code>INSERT</code> operation with different overwrite modes, and you can alternatively use the Document API, each having different features and performance characteristics</p></hgroup><p>A common requirement when ingesting data is to ensure that certain documents
exist in a collection. Oftentimes when running a command it is unclear whether
the target documents are already present in the collection or need to be
inserted first.</p><p>Unconditional <code>INSERT</code> operations will not work here, because they may run
into errors if the target documents already exist. This will trigger a
&ldquo;unique constraint violation&rdquo; error. Unconditional <code>UPDATE</code> or <code>REPLACE</code>
operations will also fail, because they require that the target documents are
already present. If this is not the case, the operations would run into
&ldquo;document not found&rdquo; errors.</p><p>So what needs to be run instead are conditional inserts/updates/replaces, also
called <em>upserts</em> or <em>repserts</em>. The behavior of such operations is:</p><ul><li>Check if a document exists, based on some criteria</li><li>If it does not exist, create the document</li><li>If it exists, update or replace it with a new version</li></ul><p>ArangoDB provides the following options in AQL to achieve this:</p><ul><li><code>UPSERT</code> AQL operation</li><li><code>INSERT</code> AQL operation with <code>overwriteMode</code></li><li>Insert operation not using AQL, but the Document REST API</li></ul><p>These alternatives have different capabilities and performance characteristics.</p><h2 id=upsert-aql-operation><code>UPSERT</code> AQL Operation <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#upsert-aql-operation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Let us start with the <a href=/3.10/aql/high-level-operations/upsert/ class=link><code>UPSERT</code> AQL operation</a>,
which is very generic and flexible.</p><p>The purpose of the <code>UPSERT</code> AQL operation is to ensure that a specific document
exists after the operation has finished.</p><p><code>UPSERT</code> will look for a specific document, based on user-configurable
attributes/values, and create the document if it does not yet exist.
If <code>UPSERT</code> finds such document, it can partially adjust it (<code>UPDATE</code>) or fully
replace it (<code>REPLACE</code>).</p><p>To recap, the syntaxes of AQL <code>UPSERT</code> are, depending on whether you want to
update replace a document:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=o>&lt;</span><span class=kp>search</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=o>&lt;</span><span class=kr>insert</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=o>&lt;</span><span class=kr>update</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=o>&lt;</span><span class=n>collection</span><span class=o>&gt;</span> <span class=n>OPTIONS</span> <span class=o>&lt;</span><span class=n>options</span><span class=o>&gt;</span></span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=o>&lt;</span><span class=kp>search</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=o>&lt;</span><span class=kr>insert</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>REPLACE</span> <span class=o>&lt;</span><span class=kr>replace</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=o>&lt;</span><span class=n>collection</span><span class=o>&gt;</span> <span class=n>OPTIONS</span> <span class=o>&lt;</span><span class=n>options</span><span class=o>&gt;</span></span></span></code></pre></div><p>The <code>OPTIONS</code> part is optional.</p><p>An example <code>UPSERT</code> operation looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inserted&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;updated&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span></span></span></code></pre></div><p>This will look for a document in the <code>pages</code> collection with the <code>page</code>
attribute having a value of <code>index.html</code>. If such document cannot be found, the
<code>INSERT</code> part will be executed, which will create a document with the <code>page</code> and
<code>status</code> attributes. If the operation finds an existing document with <code>page</code>
being <code>index.html</code>, it will execute the <code>UPDATE</code> part, which will set the
document&rsquo;s <code>status</code> attribute to <code>updated</code>.</p><h3 id=tracking-modification-dates>Tracking Modification Dates <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#tracking-modification-dates class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The <code>UPSERT</code> AQL operation is sometimes used in combination with
date/time-keeping. For example, the following query keeps track of when a
document was first created, and when it was last updated:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>created</span><span class=o>:</span> <span class=nf>DATE_NOW</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>updated</span><span class=o>:</span> <span class=nf>DATE_NOW</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span></span></span></code></pre></div><h3 id=old-variable><code>OLD</code> variable <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#old-variable class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The <code>UPSERT</code> AQL operation also provides a pseudo-variable named <code>OLD</code> to refer
to the existing document and its values in the <code>UPDATE</code>/<code>REPLACE</code> part.
Following is an example that increments a counter on a document whenever the
<code>UPSERT</code> operation is executed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>hits</span><span class=o>:</span> <span class=mi>1</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>hits</span><span class=o>:</span> <span class=bp>OLD</span><span class=p>.</span><span class=n>value</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span></span></span></code></pre></div><h3 id=upsert-caveats><code>UPSERT</code> Caveats <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#upsert-caveats class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p><code>UPSERT</code> is a very flexible operation, so some things should be kept in mind to
use it effectively and efficiently.</p><h4 id=repeat-the-search-attributes>Repeat the Search Attributes <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#repeat-the-search-attributes class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>First of all, the <code>INSERT</code> part of an <code>UPSERT</code> operation should contain all
attributes that are used in the search expression. Consider the following
counter-example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inserted&#34;</span> <span class=p>}</span> <span class=cm>/* page attribute missing here! */</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;updated&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span></span></span></code></pre></div><p>Forgetting to specify the search attributes in the <code>INSERT</code> part introduces a
problem: The first time the <code>UPSERT</code> is executed and does not find a document
with <code>page</code> being <code>index.html</code>, it will branch into the <code>INSERT</code> part as
expected. However, the <code>INSERT</code> part will create a document with only the
<code>status</code> attribute set. The <code>page</code> attribute is missing here, so when the
<code>INSERT</code> completes, there is still no document with <code>page</code> being <code>index.html</code>.
That means whenever this <code>UPSERT</code> statement executes, it will branch into the
<code>INSERT</code> part, and the <code>UPDATE</code> part will never be reached. This is likely
unintentional.</p><p>The problem can easily be avoided by adding the search attributes to the
<code>INSERT</code> part:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inserted&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;updated&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span></span></span></code></pre></div><p>Note that it is not necessary to repeat the search attributes in the <code>UPDATE</code>
part, because <code>UPDATE</code> is a partial update. It will only set the attributes that
are specified in the <code>UPDATE</code> part, and leave all other existing attributes
alone. However, it is necessary to repeat the search attributes in the <code>REPLACE</code>
part, because <code>REPLACE</code> will completely overwrite the existing document with
what is specified in the <code>REPLACE</code> part.</p><p>That means when using the <code>REPLACE</code> operation, the query should look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;inserted&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>REPLACE</span> <span class=p>{</span> <span class=n>page</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;updated&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span></span></span></code></pre></div><h4 id=use-indexes-for-search-attributes>Use Indexes for Search Attributes <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#use-indexes-for-search-attributes class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>A downside of <code>UPSERT</code>&rsquo;s flexibility is that it can be used on arbitrary
collection attributes, even if those are not indexed.</p><p>When the <code>UPSERT</code> looks for an existing document, it <em>will</em> use an index if an
index exists, but will also continue if no index exists. In the latter case,
the <code>UPSERT</code> will execute a full collection scan, which can be expensive for
large collections. So it is advised to create an index on the search
attribute(s) used in an <code>UPSERT</code>.</p><h4 id=upsert-is-non-atomic><code>UPSERT</code> is Non-Atomic <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#upsert-is-non-atomic class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>The overall <code>UPSERT</code> operation does not execute atomically for a single document.
It is basically a document lookup followed by either a document insert, update
or replace operation.</p><p>That means if multiple <code>UPSERT</code> operations run concurrently with the same search
values, they may all determine that the target document does not exist - and
then all decide to create such document. That will mean one will end up with
multiple instances of the target document afterwards.</p><p>To avoid such concurrency issues, a unique index can be created on the search
attribute(s). Such index will prevent concurrent <code>UPSERT</code> operations from
creating identical documents. Instead, only one of the concurrent <code>UPSERT</code>s will
succeed, whereas the others will fail with a &ldquo;unique constraint violated&rdquo; error.
In that case the client application can either retry the operation (which then
should go into the <code>UPDATE</code>/<code>REPLACE</code> branch), or ignore the error if the goal
was only to ensure the target document exists.</p><p>Using a unique index on the search attribute(s) will thus improve lookup
performance and avoid duplicates.</p><h4 id=using-shard-keys-for-lookups>Using Shard Key(s) for Lookups <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#using-shard-keys-for-lookups class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>In a cluster setup, the search expression should contain the shard key(s), as
this allows the lookup to be sent to a single shard only. This will be more
efficient than having to execute the lookup on all the shards of the collection.</p><p>Another benefit of using the shard key(s) in the search expression is that
unique indexes are only supported if they contain the shard key(s).</p><h2 id=insert-aql-operation-with-overwritemode><code>INSERT</code> AQL Operation with <code>overwriteMode</code> <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#insert-aql-operation-with-overwritemode class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>While the <code>UPSERT</code> AQL operation is very powerful and flexible, it is often not
the ideal choice for high-volume ingestion.</p><p>A much more efficient alternative to the <code>UPSERT</code> AQL operation is the
<a href=/3.10/aql/high-level-operations/insert/ class=link><code>INSERT</code> AQL operation</a> with the <code>overwriteMode</code>
attribute set. This operation is not a drop-in replacement for <code>UPSERT</code>, but
rather a fast alternative in case the document key (<code>_key</code> attribute) is known
when the operation is executed, and none of the old values need to be referenced.</p><p>The general syntax of the <code>INSERT</code> AQL operation is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=o>&lt;</span><span class=kr>insert</span><span class=o>-</span><span class=n>expression</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=o>&lt;</span><span class=n>collection</span><span class=o>&gt;</span> <span class=n>OPTIONS</span> <span class=o>&lt;</span><span class=n>options</span><span class=o>&gt;</span></span></span></code></pre></div><p>As we will deal with the <code>overwriteMode</code> option here, we are focussing on
<code>INSERT</code> operations with this option set, for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;created&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>overwriteMode</span><span class=o>:</span> <span class=s2>&#34;ignore&#34;</span> <span class=p>}</span></span></span></code></pre></div><p>Regardless of the selected <code>overwriteMode</code>, the <code>INSERT</code> operation will insert
the document if no document exists in the collection with the specified <code>_key</code>.
In this aspect it behaves as a regular <code>INSERT</code> operation.</p><p>However, if a document with the specified <code>_key</code> already exists in the
collection, the <code>INSERT</code> behavior will be as follows, depending on the selected
<code>overwriteMode</code>:</p><ul><li><code>conflict</code> (default): if a document with the specified <code>_key</code> exists, return
a &ldquo;unique constraint violation&rdquo;</li><li><code>ignore</code>: if a document with the specified <code>_key</code> exists, do nothing.
Especially do not report a &ldquo;unique constraint violation&rdquo; error.</li><li><code>update</code>: if a document with the specified <code>_key</code> exists, (partially) update
the document with the attributes specified.</li><li><code>replace</code>: if a document with the specified <code>_key</code> exists, fully replace the
document with the attributes specified.</li></ul><p>If no <code>overwriteMode</code> is specified, the behavior of an <code>INSERT</code> operation is as
if the <code>overwriteMode</code> was set to <code>conflict</code>.</p><p>The benefit of using <code>INSERT</code> with <code>overwriteMode</code> set to <code>ignore</code>, <code>update</code> or
<code>replace</code> is that the <code>INSERT</code> operation is going to be very fast, especially in
comparison with the <code>UPSERT</code> operation. In addition, <code>INSERT</code> will do a lookup
using the <code>_key</code> attribute, which is always indexed. So it will always use the
primary index and never do full collection scans. It also does not require
setting up additional indexes, because the primary index is automatically
present for all collections.</p><p>There are also a few caveats when working with <code>INSERT</code> AQL operations:</p><ul><li><p>They can only be used when the value of the <code>_key</code> attribute is known at the
time of insert. That means the client application must be able to provide the
document keys in a deterministic way.</p></li><li><p>The values that can be used for the <code>_key</code> attribute have some character and
length restrictions, but alphanumeric keys work well.</p></li><li><p>In a cluster setup, the underlying collection must be sharded by <code>_key</code>. This
is the default shard key, however.</p></li><li><p>There is no access to the data of an existing document for arbitrary
calculations when going into the <code>update</code> or <code>replace</code> mode.</p></li></ul><p>Please note that even though the <code>INSERT</code> AQL operation cannot refer to existing
documents to calculate values for updating/replacing, it can still return the
previous version of the document in case the document is already present.
This can be achieved by appending a <code>RETURN OLD</code> to the <code>INSERT</code> operation,
e.g.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;created&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>overwriteMode</span><span class=o>:</span> <span class=s2>&#34;replace&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=bp>OLD</span></span></span></code></pre></div><p>It is also possible to return the new version of the document (the inserted
document if no previous document existed, or the updated/replaced version in
case a document already existed) by using <code>RETURN NEW</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>:</span> <span class=s2>&#34;created&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>pages</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>overwriteMode</span><span class=o>:</span> <span class=s2>&#34;replace&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=bp>NEW</span></span></span></code></pre></div><h2 id=insert-operation-not-using-aql>Insert Operation not Using AQL <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#insert-operation-not-using-aql class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>There is the option to execute an insert operation with <code>overwriteMode</code> outside
of AQL. The <a href=/3.10/develop/http-api/documents/#create-multiple-documents class=link><code>POST /_api/document/{collection}</code></a>
endpoint is a dedicated REST API for insert operations, which can handle one
document, or multiple documents at once.</p><p>Conceptually this API behaves like the <code>INSERT</code> AQL operation, but it can be
called with a batch of documents at once. This is the most efficient solution,
and should be preferred if possible.</p><p>Most ArangoDB drivers also provide a means to insert multiple documents at once,
which will internally call this same REST API.</p><p>The REST API provides the <code>returnOld</code> and <code>returnNew</code> options to make it return
the previous versions of documents or the insert/updated/replaced documents, in
the same way as the <code>INSERT</code> AQL operation can do.</p><h2 id=summary>Summary <a href=/3.10/aql/examples-and-query-patterns/upsert-repsert-guide/#summary class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The <code>UPSERT</code> AQL operation is the most flexible way to conditionally insert or
update/replace documents in ArangoDB, but it is also the least efficient variant.</p><p>The <code>INSERT</code> AQL operation with the <code>overwriteMode</code> set will outperform
<code>UPSERT</code>, but it can only be used for some use cases.</p><p>Using the dedicated REST API for document inserts will be even more efficient,
and is thus the preferred option for bulk document inserts.</p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.10/aql/examples-and-query-patterns/diffing-two-documents/><i class="fas fa-chevron-left fa-fw"></i><p>Diffing Two Documents</p></a></span><span class=next><a class="nav nav-next link" href=/3.10/aql/user-defined-functions/><p>User-defined Functions</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.10/aql/examples-and-query-patterns/upsert-repsert-guide.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#upsert-aql-operation><code>UPSERT</code> AQL Operation</a></div><div class=level-3><a href=#tracking-modification-dates>Tracking Modification Dates</a></div><div class=level-3><a href=#old-variable><code>OLD</code> variable</a></div><div class=level-3><a href=#upsert-caveats><code>UPSERT</code> Caveats</a></div><div class=level-4><a href=#repeat-the-search-attributes>Repeat the Search Attributes</a></div><div class=level-4><a href=#use-indexes-for-search-attributes>Use Indexes for Search Attributes</a></div><div class=level-4><a href=#upsert-is-non-atomic><code>UPSERT</code> is Non-Atomic</a></div><div class=level-4><a href=#using-shard-keys-for-lookups>Using Shard Key(s) for Lookups</a></div><div class=level-2><a href=#insert-aql-operation-with-overwritemode><code>INSERT</code> AQL Operation with <code>overwriteMode</code></a></div><div class=level-2><a href=#insert-operation-not-using-aql>Insert Operation not Using AQL</a></div><div class=level-2><a href=#summary>Summary</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
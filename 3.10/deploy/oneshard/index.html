<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1747031427></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="The OneShard feature offers a practicable solution that enables significantly improved performance and transactional guarantees for cluster deployments"><meta property="og:url" content="http://localhost/3.10/deploy/oneshard/"><meta property="og:title" content="OneShard cluster deployments"><meta property="og:type" content="website"><meta property="og:description" content="The OneShard feature offers a practicable solution that enables significantly improved performance and transactional guarantees for cluster deployments"><meta name=docsearch:version content="3.10"><title>OneShard cluster deployments | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1747031427 defer></script>
<script src=/js/featherlight.min.js?1747031427 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1747031427 defer></script>
<script src=/js/theme.js?1747031427 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.10"><a itemprop=item class=link href=/3.10/><span itemprop=name class=breadcrumb-entry>3.10.14</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Deploy"><a itemprop=item class=link href=/3.10/deploy/><span itemprop=name class=breadcrumb-entry>Deploy</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="OneShard"><a itemprop=item class=link href=/3.10/deploy/oneshard/><span itemprop=name class=breadcrumb-entry>OneShard</span></a></li></ol></nav><article class=default><div class="box notices cstyle warning"><div class=box-content-container><div class=box-content><i class="fas fa-exclamation-triangle"></i><div class=box-text><p>ArangoDB v3.10 reached End of Life (EOL) and is no longer supported.</p><p>This documentation is outdated. Please see the most recent <a href=/3.12/deploy/oneshard/ class=link>stable version</a>.</p></div></div></div></div><hgroup><h1>OneShard cluster deployments</h1><p class=lead>The OneShard feature offers a practicable solution that enables significantly improved performance and transactional guarantees for cluster deployments</p></hgroup><p class=labels><span class=label>ArangoDB Enterprise Edition</span>
<span class=label>ArangoGraph</span></p><p>The OneShard option for ArangoDB clusters restricts all collections of a
database to a single shard so that every collection has <code>numberOfShards</code> set to <code>1</code>,
and all leader shards are placed on one DB-Server node. This way, whole queries
can be pushed to and executed on that server, massively reducing cluster-internal
communication. The Coordinator only gets back the final result.</p><p>Queries are always limited to a single database, and with the data of a whole
database on a single node, the OneShard option allows running transactions with
ACID guarantees on shard leaders.</p><p>Collections can have replicas by setting a <code>replicationFactor</code> greater than <code>1</code>
as usual. For each replica, the follower shards are all placed on one DB-Server
node when using the OneShard option. This allows for a quick failover in case
the DB-Server with the leader shards fails.</p><p>A OneShard setup is highly recommended for most graph use cases and join-heavy
queries.</p><div class="box notices cstyle info"><div class=box-content-container><div class=box-content><i class="fas fa-info-circle"></i><div class=box-text>For graphs larger than what fits on a single DB-Server node, you can use the
<a href=/3.10/graphs/smartgraphs/ class=link>SmartGraphs</a> feature to efficiently limit the
network hops between Coordinator and DB-Servers.</div></div></div></div><p>Without the OneShard feature query processing works as follows in a cluster:</p><ul><li>The Coordinator accepts and analyzes the query.</li><li>If collections are accessed then the Coordinator distributes the accesses
to collections to different DB-Servers that hold parts (shards) of the
collections in question.</li><li>This distributed access requires network-traffic from Coordinator to
DB-Servers and back from DB-Servers to Coordinators and is therefore
expensive.</li></ul><p>Another cost factor is the memory and CPU time required on the Coordinator
when it has to process several concurrent complex queries. In such
situations Coordinators may become a bottleneck in query processing,
because they need to send and receive data on several connections, build up
results for collection accesses from the received parts followed by further
processing.</p><p><figure class=image-caption><img alt="OneShard vs. Sharded Cluster Setup" src=/images/cluster-sharded-oneshard.png><figcaption></figcaption></figure></p><p>If the database involved in a query is a OneShard database,
then the OneShard optimization can be applied to run the query on the
responsible DB-Server node like on a single server. However, it still being
a cluster setup means collections can be replicated synchronously to ensure
resilience etc.</p><h3 id=how-to-use-the-oneshard-feature>How to use the OneShard feature <a href=/3.10/deploy/oneshard/#how-to-use-the-oneshard-feature class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The OneShard feature is enabled by default if you use the ArangoDB
Enterprise Edition and if the database is sharded as <code>"single"</code>. In this case the
optimizer rule <code>cluster-one-shard</code> is applied automatically.
There are two ways to achieve this:</p><ul><li><p>If you want your entire cluster to be a OneShard deployment, use the
<a href=/3.10/components/arangodb-server/options/#cluster class=link>startup option</a>
<code>--cluster.force-one-shard</code>. It sets the immutable <code>sharding</code> database
property to <code>"single"</code> for all newly created databases, which in turn
enforces the OneShard conditions for collections that are created in it.
The <code>_graphs</code> system collection is used for <code>distributeShardsLike</code>.</p></li><li><p>For individual OneShard databases, set the <code>sharding</code> database property to <code>"single"</code>
to enforce the OneShard condition. The <code>_graphs</code> system collection is used for
<code>distributeShardsLike</code>. It is not possible to change the <code>sharding</code> database
property afterwards or overwrite this setting for individual collections.
For non-OneShard databases the value of the <code>sharding</code> database property is
either <code>""</code> or <code>"flexible"</code>.</p></li></ul><div class="box notices cstyle info"><div class=box-content-container><div class=box-content><i class="fas fa-info-circle"></i><div class=box-text>The prototype collection does not only control the sharding, but also the
replication factor for all collections which follow its example. If the
<code>_graphs</code> system collection is used for <code>distributeShardsLike</code>, then the
replication factor can be adjusted by changing the <code>replicationFactor</code>
property of the <code>_graphs</code> collection (affecting this and all following
collections) or via the startup option <code>--cluster.system-replication-factor</code>
(affecting all system collections and all following collections).</div></div></div></div><p><strong>Example</strong></p><p>The easiest way to make use of the OneShard feature is to create a database
with the extra option <code>{ sharding: "single" }</code>. As done in the following
example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_createDatabase</span><span class=p>(</span><span class=s2>&#34;oneShardDB&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>sharding</span><span class=o>:</span> <span class=s2>&#34;single&#34;</span> <span class=p>}</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_useDatabase</span><span class=p>(</span><span class=s2>&#34;oneShardDB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>oneShardDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_properties</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;id&#34;</span> <span class=o>:</span> <span class=s2>&#34;6010005&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span> <span class=o>:</span> <span class=s2>&#34;oneShardDB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSystem&#34;</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;sharding&#34;</span> <span class=o>:</span> <span class=s2>&#34;single&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;replicationFactor&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;writeConcern&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;path&#34;</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now you can go ahead and create a collection as usual:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>oneShardDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;example1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>oneShardDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>example1</span><span class=p>.</span><span class=nx>properties</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSmart&#34;</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSystem&#34;</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;waitForSync&#34;</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;shardKeys&#34;</span> <span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;_key&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;numberOfShards&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;keyOptions&#34;</span> <span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;allowUserKeys&#34;</span> <span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span> <span class=o>:</span> <span class=s2>&#34;traditional&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;replicationFactor&#34;</span> <span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;minReplicationFactor&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;writeConcern&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;distributeShardsLike&#34;</span> <span class=o>:</span> <span class=s2>&#34;_graphs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;shardingStrategy&#34;</span> <span class=o>:</span> <span class=s2>&#34;hash&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;cacheEnabled&#34;</span> <span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>As you can see, the <code>numberOfShards</code> is set to <code>1</code> and <code>distributeShardsLike</code>
is set to <code>_graphs</code>. These attributes have automatically been set
because the <code>{ "sharding": "single" }</code> options object was
specified when creating the database.</p><p>To do this manually for individual collections, use <code>{ "sharding": "flexible" }</code>
on the database level and then create a collection in the following way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;example2&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=s2>&#34;numberOfShards&#34;</span><span class=o>:</span> <span class=mi>1</span> <span class=p>,</span> <span class=s2>&#34;distributeShardsLike&#34;</span><span class=o>:</span> <span class=s2>&#34;_graphs&#34;</span> <span class=p>})</span></span></span></code></pre></div><p>Here, the <code>_graphs</code> collection is used again, but any other existing
collection that has not been created with the <code>distributeShardsLike</code>
option itself can be used as well in a flexibly sharded database.</p><h3 id=running-queries>Running Queries <a href=/3.10/deploy/oneshard/#running-queries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>For this arangosh example, first insert a few documents into a collection,
then create a query and explain it to inspect the execution plan.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>oneShardDB</span><span class=o>&gt;</span> <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=nx>db</span><span class=p>.</span><span class=nx>example</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=s2>&#34;value&#34;</span> <span class=o>:</span> <span class=nx>i</span> <span class=p>});</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>oneShardDB</span><span class=o>&gt;</span> <span class=nx>q</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN @@collection FILTER doc.value % 2 == 0 SORT doc.value ASC LIMIT 10 RETURN doc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>oneShardDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=nx>q</span><span class=p>,</span> <span class=p>{</span> <span class=s2>&#34;@collection&#34;</span> <span class=o>:</span> <span class=s2>&#34;example&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span> <span class=p>(</span><span class=mi>88</span> <span class=nx>chars</span><span class=p>,</span> <span class=nx>cacheable</span><span class=o>:</span> <span class=kc>true</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=err>@@</span><span class=nx>collection</span> <span class=nx>FILTER</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=nx>SORT</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=nx>ASC</span> <span class=nx>LIMIT</span> <span class=mi>10</span> <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Site</span>   <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>SingletonNode</span>             <span class=nx>DBS</span>       <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>EnumerateCollectionNode</span>   <span class=nx>DBS</span>   <span class=mi>10000</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>example</span>   <span class=cm>/* full collection scan, 1 shard(s) */</span>   <span class=nx>FILTER</span> <span class=p>((</span><span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span> <span class=o>%</span> <span class=mi>2</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>   <span class=cm>/* early pruning */</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>CalculationNode</span>           <span class=nx>DBS</span>   <span class=mi>10000</span>       <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>3</span> <span class=o>=</span> <span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span>   <span class=cm>/* attribute expression */</span>   <span class=cm>/* collections used: doc : example */</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>SortNode</span>                  <span class=nx>DBS</span>   <span class=mi>10000</span>       <span class=o>-</span> <span class=nx>SORT</span> <span class=err>#</span><span class=mi>3</span> <span class=nx>ASC</span>   <span class=cm>/* sorting strategy: constrained heap */</span>
</span></span><span class=line><span class=cl>  <span class=mi>7</span>   <span class=nx>LimitNode</span>                 <span class=nx>DBS</span>      <span class=mi>10</span>       <span class=o>-</span> <span class=nx>LIMIT</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>  <span class=mi>9</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>     <span class=mi>10</span>       <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl> <span class=mi>10</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>     <span class=mi>10</span>       <span class=o>-</span> <span class=nx>GATHER</span>
</span></span><span class=line><span class=cl>  <span class=mi>8</span>   <span class=nx>ReturnNode</span>                <span class=nx>COOR</span>     <span class=mi>10</span>       <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Indexes</span> <span class=nx>used</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>none</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Optimization</span> <span class=nx>rules</span> <span class=nx>applied</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>RuleName</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>up</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>up</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>up</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>up</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>cluster</span><span class=o>-</span><span class=nx>one</span><span class=o>-</span><span class=nx>shard</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>sort</span><span class=o>-</span><span class=nx>limit</span>
</span></span><span class=line><span class=cl>  <span class=mi>7</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>into</span><span class=o>-</span><span class=nx>enumerate</span></span></span></code></pre></div><p>As it can be seen in the explain output, almost the complete query is
executed on the DB-Server (<code>DBS</code> for nodes 1-7) and only 10 documents are
transferred to the Coordinator. In case you do the same with a collection
that consists of several shards, you get a different result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_createDatabase</span><span class=p>(</span><span class=s2>&#34;shardedDB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_useDatabase</span><span class=p>(</span><span class=s2>&#34;shardedDB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>shardedDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_properties</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;id&#34;</span> <span class=o>:</span> <span class=s2>&#34;6010017&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span> <span class=o>:</span> <span class=s2>&#34;shardedDB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;isSystem&#34;</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;sharding&#34;</span> <span class=o>:</span> <span class=s2>&#34;flexible&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;replicationFactor&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;writeConcern&#34;</span> <span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;path&#34;</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>shardedDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_create</span><span class=p>(</span><span class=s2>&#34;example&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>numberOfShards</span> <span class=o>:</span> <span class=mi>5</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>shardedDB</span><span class=o>&gt;</span> <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=nx>db</span><span class=p>.</span><span class=nx>example</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span> <span class=s2>&#34;value&#34;</span> <span class=o>:</span> <span class=nx>i</span> <span class=p>});</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arangosh</span><span class=err>@</span><span class=nx>shardedDB</span><span class=o>&gt;</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_explain</span><span class=p>(</span><span class=nx>q</span><span class=p>,</span> <span class=p>{</span> <span class=s2>&#34;@collection&#34;</span> <span class=o>:</span> <span class=s2>&#34;example&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span> <span class=p>(</span><span class=mi>88</span> <span class=nx>chars</span><span class=p>,</span> <span class=nx>cacheable</span><span class=o>:</span> <span class=kc>true</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=err>@@</span><span class=nx>collection</span> <span class=nx>FILTER</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=nx>SORT</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=nx>ASC</span> <span class=nx>LIMIT</span> <span class=mi>10</span> <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Site</span>   <span class=nx>Est</span><span class=p>.</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>SingletonNode</span>             <span class=nx>DBS</span>       <span class=mi>1</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>EnumerateCollectionNode</span>   <span class=nx>DBS</span>   <span class=mi>10000</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>example</span>   <span class=cm>/* full collection scan, 5 shard(s) */</span>   <span class=nx>FILTER</span> <span class=p>((</span><span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span> <span class=o>%</span> <span class=mi>2</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>   <span class=cm>/* early pruning */</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>CalculationNode</span>           <span class=nx>DBS</span>   <span class=mi>10000</span>       <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>3</span> <span class=o>=</span> <span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span>   <span class=cm>/* attribute expression */</span>   <span class=cm>/* collections used: doc : example */</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>SortNode</span>                  <span class=nx>DBS</span>   <span class=mi>10000</span>       <span class=o>-</span> <span class=nx>SORT</span> <span class=err>#</span><span class=mi>3</span> <span class=nx>ASC</span>   <span class=cm>/* sorting strategy: constrained heap */</span>
</span></span><span class=line><span class=cl> <span class=mi>11</span>   <span class=nx>RemoteNode</span>                <span class=nx>COOR</span>  <span class=mi>10000</span>       <span class=o>-</span> <span class=nx>REMOTE</span>
</span></span><span class=line><span class=cl> <span class=mi>12</span>   <span class=nx>GatherNode</span>                <span class=nx>COOR</span>  <span class=mi>10000</span>       <span class=o>-</span> <span class=nx>GATHER</span> <span class=err>#</span><span class=mi>3</span> <span class=nx>ASC</span>  <span class=cm>/* parallel, sort mode: heap */</span>
</span></span><span class=line><span class=cl>  <span class=mi>7</span>   <span class=nx>LimitNode</span>                 <span class=nx>COOR</span>     <span class=mi>10</span>       <span class=o>-</span> <span class=nx>LIMIT</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>  <span class=mi>8</span>   <span class=nx>ReturnNode</span>                <span class=nx>COOR</span>     <span class=mi>10</span>       <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Indexes</span> <span class=nx>used</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>none</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Optimization</span> <span class=nx>rules</span> <span class=nx>applied</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>RuleName</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>up</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>up</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>up</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>up</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>scatter</span><span class=o>-</span><span class=k>in</span><span class=o>-</span><span class=nx>cluster</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>distribute</span><span class=o>-</span><span class=nx>filtercalc</span><span class=o>-</span><span class=nx>to</span><span class=o>-</span><span class=nx>cluster</span>
</span></span><span class=line><span class=cl>  <span class=mi>7</span>   <span class=nx>distribute</span><span class=o>-</span><span class=nx>sort</span><span class=o>-</span><span class=nx>to</span><span class=o>-</span><span class=nx>cluster</span>
</span></span><span class=line><span class=cl>  <span class=mi>8</span>   <span class=nx>remove</span><span class=o>-</span><span class=nx>unnecessary</span><span class=o>-</span><span class=nx>remote</span><span class=o>-</span><span class=nx>scatter</span>
</span></span><span class=line><span class=cl>  <span class=mi>9</span>   <span class=nx>sort</span><span class=o>-</span><span class=nx>limit</span>
</span></span><span class=line><span class=cl> <span class=mi>10</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>into</span><span class=o>-</span><span class=nx>enumerate</span>
</span></span><span class=line><span class=cl> <span class=mi>11</span>   <span class=nx>parallelize</span><span class=o>-</span><span class=nx>gather</span></span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-content-container><div class=box-content><i class="fas fa-check"></i><div class=box-text>It can be checked whether the OneShard feature is active or not by
inspecting the explain output. If the list of rules contains
<code>cluster-one-shard</code>, then the feature is active for the given query.</div></div></div></div><p>Without the OneShard feature all documents potentially have to be sent to
the Coordinator for further processing. With this simple query this is actually
not true, because some other optimizations are performed that reduce the number
of documents. But still, a considerable amount of documents has to be
transferred from DB-Server to Coordinator only to apply a <code>LIMIT</code> of 10
documents there. The estimate for the <em>RemoteNode</em> is 10,000 in this example,
whereas it is 10 in the OneShard case.</p><h3 id=acid-transactions-on-leader-shards>ACID Transactions on Leader Shards <a href=/3.10/deploy/oneshard/#acid-transactions-on-leader-shards class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>ArangoDB&rsquo;s transactional guarantees are tunable. For transactions to be ACID
on the leader shards in a cluster, a few things need to be considered:</p><ul><li>The AQL query or <a href=/3.10/develop/http-api/transactions/stream-transactions/ class=link>Stream Transaction</a>
must be eligible for the OneShard optimization, so that it is executed on a
single DB-Server node.</li><li>To ensure durability, enable <code>waitForSync</code> on query level to wait until data
modifications have been written to disk.</li><li>The collection option <code>writeConcern: 2</code> makes sure that a transaction is only
successful if at least one follower shard is in sync with the leader shard,
for a total of two shard replicas.</li><li>The RocksDB storage engine uses intermediate commits for larger document
operations carried out by standalone AQL queries
(outside of JavaScript Transactions and Stream Transactions).
This potentially breaks the atomicity of transactions. To prevent
this for individual queries you can increase <code>intermediateCommitSize</code>
(default 512 MB) and <code>intermediateCommitCount</code> accordingly as query option.
Also see <a href=/3.10/aql/fundamentals/limitations/#storage-engine-properties class=link>Known limitations for AQL queries</a>.</li></ul><h3 id=limitations>Limitations <a href=/3.10/deploy/oneshard/#limitations class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The OneShard optimization is used automatically for all eligible AQL queries
and Stream Transactions.</p><p>For AQL queries, any of the following factors currently makes a query
unsuitable for the OneShard optimization:</p><ul><li>The query accesses collections with more than a single shard, different leader
DB-Servers, or different <code>distributeShardsLike</code> prototype collections</li><li>The query writes into a SatelliteCollection</li><li>The query accesses an edge collection of a SmartGraph</li><li>Usage of AQL functions that can only execute on Coordinators.
These functions are:<ul><li><code>APPLY</code></li><li><code>CALL</code></li><li><code>COLLECTION_COUNT</code></li><li><code>COLLECTIONS</code></li><li><code>CURRENT_DATABASE</code></li><li><code>CURRENT_USER</code></li><li><code>FULLTEXT</code></li><li><code>NEAR</code></li><li><code>SCHEMA_GET</code></li><li><code>SCHEMA_VALIDATE</code></li><li><code>V8</code></li><li><code>VERSION</code></li><li><code>WITHIN</code></li><li><code>WITHIN_RECTANGLE</code></li><li>User-defined AQL functions (UDFs)</li></ul></li></ul><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.10/deploy/cluster/><i class="fas fa-chevron-left fa-fw"></i><p>Cluster</p></a></span><span class=next><a class="nav nav-next link" href=/3.10/deploy/arangosync/><p>Datacenter-to-Datacenter Replication</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.10/deploy/oneshard.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-3><a href=#how-to-use-the-oneshard-feature>How to use the OneShard feature</a></div><div class=level-3><a href=#running-queries>Running Queries</a></div><div class=level-3><a href=#acid-transactions-on-leader-shards>ACID Transactions on Leader Shards</a></div><div class=level-3><a href=#limitations>Limitations</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
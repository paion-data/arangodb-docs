<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743774193></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="For understanding the performance of specific queries, you can profile them to identify slow parts of query execution plans"><meta property="og:url" content="http://localhost/3.11/aql/execution-and-performance/query-profiling/"><meta property="og:title" content="Profiling and Hand-Optimizing AQL queries"><meta property="og:type" content="website"><meta property="og:description" content="For understanding the performance of specific queries, you can profile them to identify slow parts of query execution plans"><meta name=docsearch:version content="3.11"><title>Profiling and Hand-Optimizing AQL queries | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743774193 defer></script>
<script src=/js/featherlight.min.js?1743774193 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743774193 defer></script>
<script src=/js/theme.js?1743774193 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.11"><a itemprop=item class=link href=/3.11/><span itemprop=name class=breadcrumb-entry>3.11.13</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.11/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Execution and Performance"><a itemprop=item class=link href=/3.11/aql/execution-and-performance/><span itemprop=name class=breadcrumb-entry>Execution and Performance</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Query Profiling"><a itemprop=item class=link href=/3.11/aql/execution-and-performance/query-profiling/><span itemprop=name class=breadcrumb-entry>Query Profiling</span></a></li></ol></nav><article class=default><hgroup><h1>Profiling and Hand-Optimizing AQL queries</h1><p class=lead>For understanding the performance of specific queries, you can profile them to identify slow parts of query execution plans</p></hgroup><p>ArangoDB allows to execute your query with special instrumentation code enabled.
It provides you a query plan with detailed execution statistics.</p><p>To use this in an interactive fashion on the shell you can use
<code>db._profileQuery(..)</code> in <em>arangosh</em>. Alternatively, there is a button
<em>Profile</em> in the Query tab of the web interface.</p><p>The printed execution plan then contains three additional columns:</p><ul><li><strong>Call</strong>: The number of times this query stage was executed</li><li><strong>Items</strong>: The number of temporary result rows (outputs) at this stage</li><li><strong>Filtered</strong>: The number of rows filtered away by this stage</li><li><strong>Runtime</strong>: The total time spent in this stage</li></ul><p>Below the execution plan there are additional sections for the overall runtime
statistics and the query profile.</p><h2 id=example-simple-aql-query>Example: Simple AQL query <a href=/3.11/aql/execution-and-performance/query-profiling/#example-simple-aql-query class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Assuming we got a collection named <code>acollection</code> and insert 10000 documents
via <code>for (let i=0; i &lt; 10000;i++) db.acollection.insert({value:i})</code>.
Then a simple query filtering for <code>value &lt; 10</code> will return 10 results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_profileQuery</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR doc IN acollection
</span></span></span><span class=line><span class=cl><span class=sb>    FILTER doc.value &lt; 10
</span></span></span><span class=line><span class=cl><span class=sb>    RETURN doc`</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span><span class=nx>colors</span><span class=o>:</span> <span class=kc>false</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div><div class=expand><a class=expand-label onclick=toggleExpandShortcode(event)>Show output</a><div class=expand-content style=display:none><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span> <span class=p>(</span><span class=mi>66</span> <span class=nx>chars</span><span class=p>,</span> <span class=nx>cacheable</span><span class=o>:</span> <span class=kc>false</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>acollection</span>
</span></span><span class=line><span class=cl>     <span class=nx>FILTER</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=o>&lt;</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>     <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Calls</span>   <span class=nx>Items</span>   <span class=nx>Filtered</span>   <span class=nx>Runtime</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>SingletonNode</span>                 <span class=mi>1</span>       <span class=mi>1</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>EnumerateCollectionNode</span>       <span class=mi>1</span>      <span class=mi>10</span>       <span class=mi>9990</span>       <span class=mf>0.00222</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>acollection</span>   <span class=cm>/* full collection scan  */</span>   <span class=nx>FILTER</span> <span class=p>(</span><span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>)</span>   <span class=cm>/* early pruning */</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>ReturnNode</span>                    <span class=mi>1</span>      <span class=mi>10</span>          <span class=mi>0</span>       <span class=mf>0.00001</span>       <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Indexes</span> <span class=nx>used</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>none</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Optimization</span> <span class=nx>rules</span> <span class=nx>applied</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>RuleName</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>filters</span><span class=o>-</span><span class=nx>into</span><span class=o>-</span><span class=nx>enumerate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Statistics</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Writes</span> <span class=nx>Exec</span>   <span class=nx>Writes</span> <span class=nx>Ign</span>   <span class=nx>Scan</span> <span class=nx>Full</span>   <span class=nx>Scan</span> <span class=nx>Index</span>   <span class=nx>Cache</span> <span class=nx>Hits</span><span class=o>/</span><span class=nx>Misses</span>   <span class=nx>Filtered</span>   <span class=nx>Peak</span> <span class=nx>Mem</span> <span class=p>[</span><span class=nx>b</span><span class=p>]</span>   <span class=nx>Exec</span> <span class=nx>Time</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl>           <span class=mi>0</span>            <span class=mi>0</span>       <span class=mi>10000</span>            <span class=mi>0</span>               <span class=mi>0</span> <span class=o>/</span> <span class=mi>0</span>       <span class=mi>9990</span>              <span class=mi>0</span>         <span class=mf>0.00241</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Profile</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Query</span> <span class=nx>Stage</span>               <span class=nx>Duration</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nx>initializing</span>                   <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>parsing</span>                        <span class=mf>0.00003</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>ast</span>                 <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>loading</span> <span class=nx>collections</span>            <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>plan</span>             <span class=mf>0.00002</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>plan</span>                <span class=mf>0.00009</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>executors</span>        <span class=mf>0.00003</span>
</span></span><span class=line><span class=cl> <span class=nx>executing</span>                      <span class=mf>0.00223</span>
</span></span><span class=line><span class=cl> <span class=nx>finalizing</span>                     <span class=mf>0.00001</span></span></span></code></pre></div></div></div><br><p>An AQL query is essentially executed in a pipeline that chains together different
functional execution blocks. Each block gets the input rows from the parent above
it, does some processing and then outputs a certain number of output rows.</p><p>Without any detailed insight into the query execution it is impossible to tell
how many results each pipeline-block had to work on and how long this took.
By executing the query with the query profiler (<code>db._profileQuery()</code> or via
the <em>Profile</em> button in the web interface) you can check exactly how much work
each stage had to do.</p><p>Without any indexes this query should have to perform the following operations:</p><ol><li>Perform a full collection scan via a <em>EnumerateCollectionNode</em> and outputting
a row containing the document in <code>doc</code>.</li><li>Calculate the boolean expression <code>LET #1 = doc.value &lt; 10</code> from all inputs
via a <em>CalculationNode</em></li><li>Filter out all input rows where <code>#1</code> is false via the <em>FilterNode</em></li><li>Put the <code>doc</code> variable of the remaining rows into the result set via
the <em>ResultNode</em></li></ol><p>The <em>EnumerateCollectionNode</em> processed and returned all 10k rows (documents),
as did the <em>CalculationNode</em>. Because the AQL execution engine also uses an
internal batch size of 1000 these blocks were also called 100 times each.
The <em>FilterNode</em> as well as the <em>ReturnNode</em> however only ever returned 10 rows
and only had to be called once, because the result size fits within a single batch.</p><p>Let us add a persistent index on <code>value</code> to speed up the query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>acollection</span><span class=p>.</span><span class=nx>ensureIndex</span><span class=p>({</span><span class=nx>type</span><span class=o>:</span><span class=s2>&#34;persistent&#34;</span><span class=p>,</span> <span class=nx>fields</span><span class=o>:</span><span class=p>[</span><span class=s2>&#34;value&#34;</span><span class=p>]});</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_profileQuery</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR doc IN acollection
</span></span></span><span class=line><span class=cl><span class=sb>    FILTER doc.value &lt; 10
</span></span></span><span class=line><span class=cl><span class=sb>    RETURN doc`</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span><span class=nx>colors</span><span class=o>:</span> <span class=kc>false</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div><div class=expand><a class=expand-label onclick=toggleExpandShortcode(event)>Show output</a><div class=expand-content style=display:none><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span> <span class=p>(</span><span class=mi>66</span> <span class=nx>chars</span><span class=p>,</span> <span class=nx>cacheable</span><span class=o>:</span> <span class=kc>false</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>acollection</span>
</span></span><span class=line><span class=cl>     <span class=nx>FILTER</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=o>&lt;</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>     <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>NodeType</span>        <span class=nx>Calls</span>   <span class=nx>Items</span>   <span class=nx>Filtered</span>   <span class=nx>Runtime</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>SingletonNode</span>       <span class=mi>1</span>       <span class=mi>1</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>IndexNode</span>           <span class=mi>1</span>      <span class=mi>10</span>          <span class=mi>0</span>       <span class=mf>0.00006</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>acollection</span>   <span class=cm>/* persistent index scan, index scan + document lookup */</span>    
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>ReturnNode</span>          <span class=mi>1</span>      <span class=mi>10</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>       <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Indexes</span> <span class=nx>used</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>By</span>   <span class=nx>Name</span>                      <span class=nx>Type</span>         <span class=nx>Collection</span>    <span class=nx>Unique</span>   <span class=nx>Sparse</span>   <span class=nx>Cache</span>   <span class=nx>Selectivity</span>   <span class=nx>Fields</span>        <span class=nx>Stored</span> <span class=nx>values</span>   <span class=nx>Ranges</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>idx_1824128845758857217</span>   <span class=nx>persistent</span>   <span class=nx>acollection</span>   <span class=kc>false</span>    <span class=kc>false</span>    <span class=kc>false</span>      <span class=mf>100.00</span> <span class=o>%</span>   <span class=p>[</span> <span class=sb>`value`</span> <span class=p>]</span>   <span class=p>[</span>  <span class=p>]</span>            <span class=p>(</span><span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Optimization</span> <span class=nx>rules</span> <span class=nx>applied</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>RuleName</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>use</span><span class=o>-</span><span class=nx>indexes</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>remove</span><span class=o>-</span><span class=nx>filter</span><span class=o>-</span><span class=nx>covered</span><span class=o>-</span><span class=nx>by</span><span class=o>-</span><span class=nx>index</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=nx>remove</span><span class=o>-</span><span class=nx>unnecessary</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Statistics</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Writes</span> <span class=nx>Exec</span>   <span class=nx>Writes</span> <span class=nx>Ign</span>   <span class=nx>Scan</span> <span class=nx>Full</span>   <span class=nx>Scan</span> <span class=nx>Index</span>   <span class=nx>Cache</span> <span class=nx>Hits</span><span class=o>/</span><span class=nx>Misses</span>   <span class=nx>Filtered</span>   <span class=nx>Peak</span> <span class=nx>Mem</span> <span class=p>[</span><span class=nx>b</span><span class=p>]</span>   <span class=nx>Exec</span> <span class=nx>Time</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl>           <span class=mi>0</span>            <span class=mi>0</span>           <span class=mi>0</span>           <span class=mi>10</span>               <span class=mi>0</span> <span class=o>/</span> <span class=mi>0</span>          <span class=mi>0</span>              <span class=mi>0</span>         <span class=mf>0.00025</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Profile</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Query</span> <span class=nx>Stage</span>               <span class=nx>Duration</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nx>initializing</span>                   <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>parsing</span>                        <span class=mf>0.00003</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>ast</span>                 <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>loading</span> <span class=nx>collections</span>            <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>plan</span>             <span class=mf>0.00002</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>plan</span>                <span class=mf>0.00009</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>executors</span>        <span class=mf>0.00003</span>
</span></span><span class=line><span class=cl> <span class=nx>executing</span>                      <span class=mf>0.00007</span>
</span></span><span class=line><span class=cl> <span class=nx>finalizing</span>                     <span class=mf>0.00001</span></span></span></code></pre></div></div></div><br><p>This results in replacing the collection scan and filter block with an
<code>IndexNode</code>. The execution pipeline of the AQL query has become much shorter.
Also the number of rows processed by each pipeline block is only 10, because
we no longer need to look at all documents.</p><h2 id=example-aql-with-subquery>Example: AQL with Subquery <a href=/3.11/aql/execution-and-performance/query-profiling/#example-aql-with-subquery class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Let us consider a query containing a subquery:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_profileQuery</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  LET list = (FOR doc in acollection FILTER doc.value &gt; 90 RETURN doc)
</span></span></span><span class=line><span class=cl><span class=sb>  FOR a IN list 
</span></span></span><span class=line><span class=cl><span class=sb>    FILTER a.value &lt; 91 
</span></span></span><span class=line><span class=cl><span class=sb>    RETURN a`</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span><span class=nx>colors</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>optimizer</span><span class=o>:</span><span class=p>{</span><span class=nx>rules</span><span class=o>:</span><span class=p>[</span><span class=s2>&#34;-all&#34;</span><span class=p>]}}</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div><div class=expand><a class=expand-label onclick=toggleExpandShortcode(event)>Show output</a><div class=expand-content style=display:none><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span> <span class=p>(</span><span class=mi>126</span> <span class=nx>chars</span><span class=p>,</span> <span class=nx>cacheable</span><span class=o>:</span> <span class=kc>false</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=nx>LET</span> <span class=nx>list</span> <span class=o>=</span> <span class=p>(</span><span class=nx>FOR</span> <span class=nx>doc</span> <span class=k>in</span> <span class=nx>acollection</span> <span class=nx>FILTER</span> <span class=nx>doc</span><span class=p>.</span><span class=nx>value</span> <span class=o>&gt;</span> <span class=mi>90</span> <span class=nx>RETURN</span> <span class=nx>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>FOR</span> <span class=nx>a</span> <span class=nx>IN</span> <span class=nx>list</span> 
</span></span><span class=line><span class=cl>     <span class=nx>FILTER</span> <span class=nx>a</span><span class=p>.</span><span class=nx>value</span> <span class=o>&lt;</span> <span class=mi>91</span> 
</span></span><span class=line><span class=cl>     <span class=nx>RETURN</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Calls</span>   <span class=nx>Items</span>   <span class=nx>Filtered</span>   <span class=nx>Runtime</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>SingletonNode</span>                 <span class=mi>1</span>       <span class=mi>1</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl> <span class=mi>12</span>   <span class=nx>SubqueryStartNode</span>             <span class=mi>1</span>       <span class=mi>2</span>          <span class=mi>0</span>       <span class=mf>0.00001</span>     <span class=o>-</span> <span class=nx>LET</span> <span class=nx>list</span> <span class=o>=</span> <span class=p>(</span> <span class=cm>/* subquery begin */</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=nx>EnumerateCollectionNode</span>      <span class=mi>11</span>   <span class=mi>10001</span>          <span class=mi>0</span>       <span class=mf>0.00198</span>       <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>doc</span> <span class=nx>IN</span> <span class=nx>acollection</span>   <span class=cm>/* full collection scan  */</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=nx>CalculationNode</span>              <span class=mi>11</span>   <span class=mi>10001</span>          <span class=mi>0</span>       <span class=mf>0.00140</span>         <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>5</span> <span class=o>=</span> <span class=p>(</span><span class=nx>doc</span><span class=p>.</span><span class=sb>`value`</span> <span class=o>&gt;</span> <span class=mi>90</span><span class=p>)</span>   <span class=cm>/* simple expression */</span>   <span class=cm>/* collections used: doc : acollection */</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>FilterNode</span>                   <span class=mi>10</span>    <span class=mi>9910</span>         <span class=mi>91</span>       <span class=mf>0.00137</span>         <span class=o>-</span> <span class=nx>FILTER</span> <span class=err>#</span><span class=mi>5</span>
</span></span><span class=line><span class=cl> <span class=mi>13</span>   <span class=nx>SubqueryEndNode</span>               <span class=mi>1</span>       <span class=mi>1</span>          <span class=mi>0</span>       <span class=mf>0.00087</span>         <span class=o>-</span> <span class=nx>RETURN</span>  <span class=nx>doc</span> <span class=p>)</span> <span class=cm>/* subquery end */</span>
</span></span><span class=line><span class=cl>  <span class=mi>8</span>   <span class=nx>EnumerateListNode</span>            <span class=mi>10</span>    <span class=mi>9909</span>          <span class=mi>0</span>       <span class=mf>0.00098</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>a</span> <span class=nx>IN</span> <span class=nx>list</span>   <span class=cm>/* list iteration */</span>
</span></span><span class=line><span class=cl>  <span class=mi>9</span>   <span class=nx>CalculationNode</span>              <span class=mi>10</span>    <span class=mi>9909</span>          <span class=mi>0</span>       <span class=mf>0.00146</span>       <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>7</span> <span class=o>=</span> <span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=sb>`value`</span> <span class=o>&lt;</span> <span class=mi>91</span><span class=p>)</span>   <span class=cm>/* simple expression */</span>
</span></span><span class=line><span class=cl> <span class=mi>10</span>   <span class=nx>FilterNode</span>                    <span class=mi>1</span>       <span class=mi>0</span>       <span class=mi>9909</span>       <span class=mf>0.00034</span>       <span class=o>-</span> <span class=nx>FILTER</span> <span class=err>#</span><span class=mi>7</span>
</span></span><span class=line><span class=cl> <span class=mi>11</span>   <span class=nx>ReturnNode</span>                    <span class=mi>1</span>       <span class=mi>0</span>          <span class=mi>0</span>       <span class=mf>0.00001</span>       <span class=o>-</span> <span class=nx>RETURN</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Indexes</span> <span class=nx>used</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>none</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Optimization</span> <span class=nx>rules</span> <span class=nx>applied</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>RuleName</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>splice</span><span class=o>-</span><span class=nx>subqueries</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Statistics</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Writes</span> <span class=nx>Exec</span>   <span class=nx>Writes</span> <span class=nx>Ign</span>   <span class=nx>Scan</span> <span class=nx>Full</span>   <span class=nx>Scan</span> <span class=nx>Index</span>   <span class=nx>Cache</span> <span class=nx>Hits</span><span class=o>/</span><span class=nx>Misses</span>   <span class=nx>Filtered</span>   <span class=nx>Peak</span> <span class=nx>Mem</span> <span class=p>[</span><span class=nx>b</span><span class=p>]</span>   <span class=nx>Exec</span> <span class=nx>Time</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl>           <span class=mi>0</span>            <span class=mi>0</span>       <span class=mi>10000</span>            <span class=mi>0</span>               <span class=mi>0</span> <span class=o>/</span> <span class=mi>0</span>      <span class=mi>10000</span>         <span class=mi>720896</span>         <span class=mf>0.00861</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Profile</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Query</span> <span class=nx>Stage</span>               <span class=nx>Duration</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nx>initializing</span>                   <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>parsing</span>                        <span class=mf>0.00004</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>ast</span>                 <span class=mf>0.00001</span>
</span></span><span class=line><span class=cl> <span class=nx>loading</span> <span class=nx>collections</span>            <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>plan</span>             <span class=mf>0.00002</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>plan</span>                <span class=mf>0.00006</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>executors</span>        <span class=mf>0.00005</span>
</span></span><span class=line><span class=cl> <span class=nx>executing</span>                      <span class=mf>0.00842</span>
</span></span><span class=line><span class=cl> <span class=nx>finalizing</span>                     <span class=mf>0.00002</span></span></span></code></pre></div></div></div><br><p>The resulting query profile contains a <em>SubqueryNode</em> which has the runtime of
all its children combined.</p><p>Actually, we cheated a little. The optimizer would have completely removed the
subquery if it had not been deactivated (<code>rules:["-all"]</code>). The optimized
version would take longer in the &ldquo;optimizing plan&rdquo; stage, but should perform
better with a lot of results.</p><h2 id=example-aql-with-aggregation>Example: AQL with Aggregation <a href=/3.11/aql/execution-and-performance/query-profiling/#example-aql-with-aggregation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Let us try a more advanced query, using a <a href=/3.11/aql/high-level-operations/collect/ class=link>COLLECT</a>
statement. Assume we have a user collection with each document having a city,
a username and an age attribute.</p><p>The following query gets us all age groups in buckets (0-9, 10-19, 20-29, &mldr;):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_profileQuery</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>  FOR u IN myusers
</span></span></span><span class=line><span class=cl><span class=sb>    COLLECT ageGroup = FLOOR(u.age / 10) * 10
</span></span></span><span class=line><span class=cl><span class=sb>    AGGREGATE minAge = MIN(u.age), maxAge = MAX(u.age), len = LENGTH(u)
</span></span></span><span class=line><span class=cl><span class=sb>    RETURN {
</span></span></span><span class=line><span class=cl><span class=sb>      ageGroup, 
</span></span></span><span class=line><span class=cl><span class=sb>      minAge, 
</span></span></span><span class=line><span class=cl><span class=sb>      maxAge,
</span></span></span><span class=line><span class=cl><span class=sb>      len
</span></span></span><span class=line><span class=cl><span class=sb>    }`</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span><span class=nx>colors</span><span class=o>:</span> <span class=kc>false</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></div><div class=expand><a class=expand-label onclick=toggleExpandShortcode(event)>Show output</a><div class=expand-content style=display:none><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>Query</span> <span class=nb>String</span> <span class=p>(</span><span class=mi>212</span> <span class=nx>chars</span><span class=p>,</span> <span class=nx>cacheable</span><span class=o>:</span> <span class=kc>false</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=nx>FOR</span> <span class=nx>u</span> <span class=nx>IN</span> <span class=nx>myusers</span>
</span></span><span class=line><span class=cl>     <span class=nx>COLLECT</span> <span class=nx>ageGroup</span> <span class=o>=</span> <span class=nx>FLOOR</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>age</span> <span class=o>/</span> <span class=mi>10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>     <span class=nx>AGGREGATE</span> <span class=nx>minAge</span> <span class=o>=</span> <span class=nx>MIN</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>age</span><span class=p>),</span> <span class=nx>maxAge</span> <span class=o>=</span> <span class=nx>MAX</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>age</span><span class=p>),</span> <span class=nx>len</span> <span class=o>=</span> <span class=nx>LENGTH</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=nx>RETURN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>ageGroup</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>       <span class=nx>minAge</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>       <span class=nx>maxAge</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>len</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Execution</span> <span class=nx>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>NodeType</span>                  <span class=nx>Calls</span>   <span class=nx>Items</span>   <span class=nx>Filtered</span>   <span class=nx>Runtime</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>   <span class=nx>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>SingletonNode</span>                 <span class=mi>1</span>       <span class=mi>1</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>   <span class=o>*</span> <span class=nx>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>EnumerateCollectionNode</span>       <span class=mi>1</span>      <span class=mi>20</span>          <span class=mi>0</span>       <span class=mf>0.00004</span>     <span class=o>-</span> <span class=nx>FOR</span> <span class=nx>u</span> <span class=nx>IN</span> <span class=nx>myusers</span>   <span class=cm>/* full collection scan (projections: `age`)  */</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=nx>CalculationNode</span>               <span class=mi>1</span>      <span class=mi>20</span>          <span class=mi>0</span>       <span class=mf>0.00001</span>       <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>5</span> <span class=o>=</span> <span class=p>(</span><span class=nx>FLOOR</span><span class=p>((</span><span class=nx>u</span><span class=p>.</span><span class=sb>`age`</span> <span class=o>/</span> <span class=mi>10</span><span class=p>))</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span>   <span class=cm>/* simple expression */</span>   <span class=cm>/* collections used: u : myusers */</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=nx>CalculationNode</span>               <span class=mi>1</span>      <span class=mi>20</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>       <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>7</span> <span class=o>=</span> <span class=nx>u</span><span class=p>.</span><span class=sb>`age`</span>   <span class=cm>/* attribute expression */</span>   <span class=cm>/* collections used: u : myusers */</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>CollectNode</span>                   <span class=mi>1</span>       <span class=mi>7</span>          <span class=mi>0</span>       <span class=mf>0.00001</span>       <span class=o>-</span> <span class=nx>COLLECT</span> <span class=nx>ageGroup</span> <span class=o>=</span> <span class=err>#</span><span class=mi>5</span> <span class=nx>AGGREGATE</span> <span class=nx>minAge</span> <span class=o>=</span> <span class=nx>MIN</span><span class=p>(</span><span class=err>#</span><span class=mi>7</span><span class=p>),</span> <span class=nx>maxAge</span> <span class=o>=</span> <span class=nx>MAX</span><span class=p>(</span><span class=err>#</span><span class=mi>7</span><span class=p>),</span> <span class=nx>len</span> <span class=o>=</span> <span class=nx>LENGTH</span><span class=p>()</span>   <span class=cm>/* hash */</span>
</span></span><span class=line><span class=cl>  <span class=mi>9</span>   <span class=nx>SortNode</span>                      <span class=mi>1</span>       <span class=mi>7</span>          <span class=mi>0</span>       <span class=mf>0.00002</span>       <span class=o>-</span> <span class=nx>SORT</span> <span class=nx>ageGroup</span> <span class=nx>ASC</span>   <span class=cm>/* sorting strategy: standard */</span>
</span></span><span class=line><span class=cl>  <span class=mi>7</span>   <span class=nx>CalculationNode</span>               <span class=mi>1</span>       <span class=mi>7</span>          <span class=mi>0</span>       <span class=mf>0.00001</span>       <span class=o>-</span> <span class=nx>LET</span> <span class=err>#</span><span class=mi>11</span> <span class=o>=</span> <span class=p>{</span> <span class=s2>&#34;ageGroup&#34;</span> <span class=o>:</span> <span class=nx>ageGroup</span><span class=p>,</span> <span class=s2>&#34;minAge&#34;</span> <span class=o>:</span> <span class=nx>minAge</span><span class=p>,</span> <span class=s2>&#34;maxAge&#34;</span> <span class=o>:</span> <span class=nx>maxAge</span><span class=p>,</span> <span class=s2>&#34;len&#34;</span> <span class=o>:</span> <span class=nx>len</span> <span class=p>}</span>   <span class=cm>/* simple expression */</span>
</span></span><span class=line><span class=cl>  <span class=mi>8</span>   <span class=nx>ReturnNode</span>                    <span class=mi>1</span>       <span class=mi>7</span>          <span class=mi>0</span>       <span class=mf>0.00000</span>       <span class=o>-</span> <span class=nx>RETURN</span> <span class=err>#</span><span class=mi>11</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Indexes</span> <span class=nx>used</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>none</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Optimization</span> <span class=nx>rules</span> <span class=nx>applied</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Id</span>   <span class=nx>RuleName</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>up</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=nx>remove</span><span class=o>-</span><span class=nx>redundant</span><span class=o>-</span><span class=nx>calculations</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=nx>remove</span><span class=o>-</span><span class=nx>unnecessary</span><span class=o>-</span><span class=nx>calculations</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>up</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span>   <span class=nx>move</span><span class=o>-</span><span class=nx>calculations</span><span class=o>-</span><span class=nx>down</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span>   <span class=nx>reduce</span><span class=o>-</span><span class=nx>extraction</span><span class=o>-</span><span class=nx>to</span><span class=o>-</span><span class=nx>projection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Statistics</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Writes</span> <span class=nx>Exec</span>   <span class=nx>Writes</span> <span class=nx>Ign</span>   <span class=nx>Scan</span> <span class=nx>Full</span>   <span class=nx>Scan</span> <span class=nx>Index</span>   <span class=nx>Cache</span> <span class=nx>Hits</span><span class=o>/</span><span class=nx>Misses</span>   <span class=nx>Filtered</span>   <span class=nx>Peak</span> <span class=nx>Mem</span> <span class=p>[</span><span class=nx>b</span><span class=p>]</span>   <span class=nx>Exec</span> <span class=nx>Time</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl>           <span class=mi>0</span>            <span class=mi>0</span>          <span class=mi>20</span>            <span class=mi>0</span>               <span class=mi>0</span> <span class=o>/</span> <span class=mi>0</span>          <span class=mi>0</span>          <span class=mi>65536</span>         <span class=mf>0.00042</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Query</span> <span class=nx>Profile</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=nx>Query</span> <span class=nx>Stage</span>               <span class=nx>Duration</span> <span class=p>[</span><span class=nx>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=nx>initializing</span>                   <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>parsing</span>                        <span class=mf>0.00005</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>ast</span>                 <span class=mf>0.00001</span>
</span></span><span class=line><span class=cl> <span class=nx>loading</span> <span class=nx>collections</span>            <span class=mf>0.00000</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>plan</span>             <span class=mf>0.00002</span>
</span></span><span class=line><span class=cl> <span class=nx>optimizing</span> <span class=nx>plan</span>                <span class=mf>0.00018</span>
</span></span><span class=line><span class=cl> <span class=nx>instantiating</span> <span class=nx>executors</span>        <span class=mf>0.00005</span>
</span></span><span class=line><span class=cl> <span class=nx>executing</span>                      <span class=mf>0.00011</span>
</span></span><span class=line><span class=cl> <span class=nx>finalizing</span>                     <span class=mf>0.00001</span></span></span></code></pre></div></div></div><br><p>Without any indexes this query should have to perform the following operations:</p><ol><li>Perform a full collection scan via a <em>EnumerateCollectionNode</em> and outputting
a row containing the document in <code>doc</code>.</li><li>Compute the expression <code>LET #1 = FLOOR(u.age / 10) * 10</code> for all inputs via
a <em>CalculationNode</em></li><li>Perform the aggregations via the <em>CollectNode</em></li><li>Sort the resulting aggregated rows via a <em>SortNode</em></li><li>Build a result value via another <em>CalculationNode</em></li><li>Put the result variable into the result set via the <em>ResultNode</em></li></ol><p>Like within the example above, you can see that after the <em>CalculationNode</em>
stage, from the originally 20 rows only a handful remained.</p><h2 id=typical-aql-performance-mistakes>Typical AQL Performance Mistakes <a href=/3.11/aql/execution-and-performance/query-profiling/#typical-aql-performance-mistakes class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>With the new query profiler you should be able to spot typical performance
mistakes that we see quite often:</p><ul><li>Not employing indexes to speed up queries with common filter expressions</li><li>Not using shard keys in filter statements, when it is known
(only a cluster problem)</li><li>Using subqueries to calculate an intermediary result, but only using a
few results</li></ul><p>Bad example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>vertices</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>FOR</span> <span class=n>v</span> <span class=kr>IN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>2</span> <span class=kr>ANY</span> <span class=nv>@startVertex</span> <span class=kr>GRAPH</span> <span class=s1>&#39;my_graph&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// &lt;-- add a LIMIT 1 here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>RETURN</span> <span class=n>v</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>collection</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>value</span> <span class=o>==</span> <span class=n>vertices</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>value</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>Adding a <code>LIMIT 1</code> into the subquery should result in better performance,
because the traversal can be stopped after the first result instead of
computing all paths.</p><p>Another mistake is to start a graph traversal from the wrong side
(if both ends are known).</p><p>Assume we have two vertex collections <em>users</em> and <em>products</em> as well as an
edge collection <em>purchased</em>. The graph model looks like this:
<code>(users) &lt;--[purchased]--> (products)</code>, i.e. every user is connected with an
edge in <em>purchased</em> to zero or more <em>products</em>.</p><p>If we want to know all users that have purchased the product <em>playstation</em>
as well as products of <code>type</code> <em>legwarmer</em> we could use this query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>prod</span> <span class=kr>IN</span> <span class=n>products</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>prod</span><span class=p>.</span><span class=n>type</span> <span class=o>==</span> <span class=s1>&#39;legwarmer&#39;</span>
</span></span><span class=line><span class=cl>  <span class=kr>FOR</span> <span class=n>v</span><span class=p>,</span><span class=n>e</span><span class=p>,</span><span class=n>p</span> <span class=kr>IN</span> <span class=mf>2</span><span class=o>..</span><span class=mi>2</span> <span class=kr>OUTBOUND</span> <span class=n>prod</span> <span class=n>purchased</span>
</span></span><span class=line><span class=cl>    <span class=kr>FILTER</span> <span class=n>v</span><span class=p>.</span><span class=n>_key</span> <span class=o>==</span> <span class=s1>&#39;playstation&#39;</span> <span class=c1>// &lt;-- last vertex of the path
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>RETURN</span> <span class=n>p</span><span class=p>.</span><span class=n>vertices</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=c1>// &lt;-- the user
</span></span></span></code></pre></div><p>This query first finds all legwarmer products and then performs a traversal
for each of them. But we could also inverse the traversal by starting of with
the known <em>playstation</em> product. This way we only need a single traversal
to achieve the same result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>v</span><span class=p>,</span><span class=n>e</span><span class=p>,</span><span class=n>p</span> <span class=kr>IN</span> <span class=mf>2</span><span class=o>..</span><span class=mi>2</span> <span class=kr>OUTBOUND</span> <span class=s1>&#39;product/playstation&#39;</span> <span class=n>purchased</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>v</span><span class=p>.</span><span class=n>type</span> <span class=o>==</span> <span class=s1>&#39;legwarmer&#39;</span> <span class=c1>// &lt;-- last vertex of the path
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>RETURN</span> <span class=n>p</span><span class=p>.</span><span class=n>vertices</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=c1>// &lt;-- the user
</span></span></span></code></pre></div><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.11/aql/execution-and-performance/explaining-queries/><i class="fas fa-chevron-left fa-fw"></i><p>Explaining queries</p></a></span><span class=next><a class="nav nav-next link" href=/3.11/aql/execution-and-performance/query-optimization/><p>Query Optimization</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.11/aql/execution-and-performance/query-profiling.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#example-simple-aql-query>Example: Simple AQL query</a></div><div class=level-2><a href=#example-aql-with-subquery>Example: AQL with Subquery</a></div><div class=level-2><a href=#example-aql-with-aggregation>Example: AQL with Aggregation</a></div><div class=level-2><a href=#typical-aql-performance-mistakes>Typical AQL Performance Mistakes</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1747031427></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="Avoid injection vulnerabilities and avoid pitfalls like incorrect operator usage performance issues when using ArangoDB&amp;rsquo;s query language"><meta property="og:url" content="http://localhost/3.11/aql/common-errors/"><meta property="og:title" content="Common Errors in AQL"><meta property="og:type" content="website"><meta property="og:description" content="Avoid injection vulnerabilities and avoid pitfalls like incorrect operator usage performance issues when using ArangoDB&amp;rsquo;s query language"><meta name=docsearch:version content="3.11"><title>Common Errors in AQL | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1747031427 defer></script>
<script src=/js/featherlight.min.js?1747031427 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1747031427 defer></script>
<script src=/js/theme.js?1747031427 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.11"><a itemprop=item class=link href=/3.11/><span itemprop=name class=breadcrumb-entry>3.11.13</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.11/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Common Errors"><a itemprop=item class=link href=/3.11/aql/common-errors/><span itemprop=name class=breadcrumb-entry>Common Errors</span></a></li></ol></nav><article class=default><hgroup><h1>Common Errors in AQL</h1><p class=lead>Avoid injection vulnerabilities and avoid pitfalls like incorrect operator usage performance issues when using ArangoDB&rsquo;s query language</p></hgroup><h2 id=trailing-semicolons-in-query-strings>Trailing semicolons in query strings <a href=/3.11/aql/common-errors/#trailing-semicolons-in-query-strings class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Many SQL databases allow sending multiple queries at once. In this case, multiple
queries are separated using the semicolon character. Often it is also supported to
execute a single query that has a semicolon at its end.</p><p>AQL does not support this, and it is a parse error to use a semicolon at the end
of an AQL query string.</p><h2 id=string-concatenation>String concatenation <a href=/3.11/aql/common-errors/#string-concatenation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In AQL, strings must be concatenated using the <a href=/3.11/aql/functions/string/#concat class=link><code>CONCAT()</code></a>
function. Joining them together with the <code>+</code> operator is not supported. Especially
as JavaScript programmer it is easy to walk into this trap:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=s2>&#34;foo&#34;</span> <span class=o>+</span> <span class=s2>&#34;bar&#34;</span> <span class=c1>// [ 0 ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>RETURN</span> <span class=s2>&#34;foo&#34;</span> <span class=o>+</span> <span class=mi>123</span>   <span class=c1>// [ 123 ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>RETURN</span> <span class=s2>&#34;123&#34;</span> <span class=o>+</span> <span class=mi>200</span>   <span class=c1>// [ 323 ]
</span></span></span></code></pre></div><p>The arithmetic plus operator expects numbers as operands, and will try to implicitly
cast them to numbers if they are of different type. <code>"foo"</code> and <code>"bar"</code> are casted
to <code>0</code> and then added to together (still zero). If an actual number is added, that
number will be returned (adding zero doesn&rsquo;t change the result). If the string is a
valid string representation of a number, then it is casted to a number. Thus, adding
<code>"123"</code> and <code>200</code> results in two numbers being added up to <code>323</code>.</p><p>To concatenate elements (with implicit casting to string for non-string values), do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=nf>CONCAT</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>,</span> <span class=s2>&#34;bar&#34;</span><span class=p>)</span> <span class=c1>// [ &#34;foobar&#34; ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>RETURN</span> <span class=nf>CONCAT</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>,</span> <span class=mi>123</span><span class=p>)</span>   <span class=c1>// [ &#34;foo123&#34; ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>RETURN</span> <span class=nf>CONCAT</span><span class=p>(</span><span class=s2>&#34;123&#34;</span><span class=p>,</span> <span class=mi>200</span><span class=p>)</span>   <span class=c1>// [ &#34;123200&#34; ]
</span></span></span></code></pre></div><h2 id=parameter-injection-vulnerability>Parameter injection vulnerability <a href=/3.11/aql/common-errors/#parameter-injection-vulnerability class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Parameter injection means that potentially malicious content is inserted into a
query which may change its meaning. It is a security issue that may allow an
attacker to execute arbitrary queries on the database data.</p><p>It often occurs if applications trustfully insert user-provided inputs into a
query string, and do not fully or incorrectly filter them. It also occurs often
when applications build queries naively, without using security mechanisms often
provided by database software or querying mechanisms.</p><p>AQL is not vulnerable to parameter injection in itself, but queries might be
constructed on the client-side, on an application server or in a Foxx service.
Assembling query strings with simple <strong>string concatenation</strong> looks trivial,
but is potentially <strong>unsafe</strong>. You should use
<a href=/3.11/aql/fundamentals/bind-parameters/ class=link>bind parameters</a> instead whenever possible,
use query building functionality if provided by a driver (see
<a href=https://arangodb.github.io/arangojs/latest/functions/aql.aql.html target=_blank rel="noopener noreferrer" class=link>arangojs AQL Helpers</a>&nbsp;<i class="fas fa-external-link-alt"></i>
for example) or at least sanitize user input with great care.</p><h3 id=parameter-injection-examples>Parameter injection examples <a href=/3.11/aql/common-errors/#parameter-injection-examples class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>Below you find a simple query using the <a href=/3.11/develop/javascript-api/ class=link>JavaScript API</a>
that is fed with some dynamic input value, pretending it coming from a web form.
This could be the case in a Foxx service. The route happily picks up the input
value, and puts it into a query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// evil!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>what</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>(</span><span class=s2>&#34;searchValue&#34;</span><span class=p>);</span>  <span class=c1>// user input value from web form
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN collection FILTER doc.value == &#34;</span> <span class=o>+</span> <span class=nx>what</span> <span class=o>+</span> <span class=s2>&#34; RETURN doc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>params</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>The above will probably work fine for numeric input values.</p><p>What could an attacker do to this query? Here are a few suggestions to use for
the <code>searchValue</code> parameter:</p><ul><li>for returning all documents in the collection:<br><code>1 || true</code></li><li>for removing all documents:<br><code>1 || true REMOVE doc IN collection //</code></li><li>for inserting new documents:<br><code>1 || true INSERT { foo: "bar" } IN collection //</code></li></ul><p>It should have become obvious that this is extremely unsafe and should be
avoided. A pattern often seen to counteract this is trying to quote and escape
potentially unsafe input values before putting them into query strings.
This may work in some situations, but it is easy to overlook something or get
it subtly wrong:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// We are sanitizing now, but it is still evil!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>(</span><span class=s2>&#34;searchValue&#34;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&#39;/g</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN collection FILTER doc.value == &#39;&#34;</span> <span class=o>+</span> <span class=nx>value</span> <span class=o>+</span> <span class=s2>&#34;&#39; RETURN doc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>params</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>The above example uses single quotes for enclosing the potentially unsafe user
input, and also replaces all single quotes in the input value beforehand.
Not only may that change the user input (leading to subtle errors such as
<em>&ldquo;why does my search for <code>O'Brien</code> not return any results?&rdquo;</em>), but it is
also still unsafe. If the user input contains a backslash at the end
(e.g. <code>foo bar\</code>), that backslash will escape the closing single quote,
allowing the user input to break out of the string fence again.</p><p>It gets worse if user input is inserted into the query at multiple places.
Let us assume we have a query with two dynamic values:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>query</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN collection FILTER doc.value == &#39;&#34;</span> <span class=o>+</span> <span class=nx>value</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#39; &amp;&amp; doc.type == &#39;&#34;</span> <span class=o>+</span> <span class=nx>type</span> <span class=o>+</span> <span class=s2>&#34;&#39; RETURN doc&#34;</span><span class=p>;</span></span></span></code></pre></div><p>If an attacker inserted <code>\</code> for parameter <code>value</code> and
<code>|| true REMOVE doc IN collection //</code> for parameter <code>type</code>, then the effective
query would become:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>collection</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>value</span> <span class=o>==</span> <span class=s1>&#39;\&#39; &amp;&amp; doc.type == &#39;</span> <span class=o>||</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=kr>REMOVE</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>collection</span> <span class=c1>//&#39; RETURN doc
</span></span></span></code></pre></div><p>â€¦ which is highly undesirable. The backslash escapes the closing single quote,
turning the <code>doc.type</code> condition into a string, which gets compared to
<code>doc.value</code>. Further more, an always true or-condition as well as a remove
operation are injected, changing the query purpose entirely. The original
return operation gets commented out and the query will truncate the collection
instead of returning a few documents.</p><h3 id=avoiding-parameter-injection>Avoiding parameter injection <a href=/3.11/aql/common-errors/#avoiding-parameter-injection class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>Instead of mixing query string fragments with user inputs naively via string
concatenation, use either <strong>bind parameters</strong> or a <strong>query builder</strong>. Both can
help to avoid the problem of injection, because they allow separating the actual
query operations (like <code>FOR</code>, <code>INSERT</code>, <code>REMOVE</code>) from (user input) values.</p><p>Below, the focus is on bind parameters. This is not to say that query builders
shouldn&rsquo;t be used. They were simply omitted here for the sake of simplicity.</p><h4 id=what-bind-parameters-are>What bind parameters are <a href=/3.11/aql/common-errors/#what-bind-parameters-are class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>Bind parameters in AQL queries are special tokens that act as placeholders for
actual values. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>collection</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>value</span> <span class=o>==</span> <span class=nv>@what</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>In the above query, <code>@what</code> is a bind parameter. In order to execute this query,
a value for bind parameter <code>@what</code> must be specified. Otherwise query execution will
fail with error 1551 (<em>no value specified for declared bind parameter</em>). If a value
for <code>@what</code> gets specified, the query can be executed. However, the query string
and the bind parameter values (i.e. the contents of the <code>@what</code> bind parameter) will
be handled separately. What&rsquo;s in the bind parameter will always be treated as a value,
and it can&rsquo;t get out of its sandbox and change the semantic meaning of a query.</p><h4 id=how-bind-parameters-are-used>How bind parameters are used <a href=/3.11/aql/common-errors/#how-bind-parameters-are-used class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>To execute a query with bind parameters, the query string (containing the bind
parameters) and the bind parameter values are specified separately (note that when
the bind parameter value is assigned, the prefix <code>@</code> needs to be omitted):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// query string with bind parameter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN collection FILTER doc.value == @what RETURN doc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// actual value for bind parameter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>params</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>what</span><span class=o>:</span> <span class=mi>42</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// run query, specifying query string and bind parameter separately
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>params</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>If a malicious user would set <code>@what</code> to a value of <code>1 || true</code>, this wouldn&rsquo;t do
any harm. AQL would treat the contents of <code>@what</code> as a single string token, and
the meaning of the query would remain unchanged. The actually executed query would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>collection</span>
</span></span><span class=line><span class=cl>  <span class=kr>FILTER</span> <span class=n>doc</span><span class=p>.</span><span class=n>value</span> <span class=o>==</span> <span class=s2>&#34;1 || true&#34;</span>
</span></span><span class=line><span class=cl>  <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>Thanks to bind parameters it is also impossible to turn a selection (i.e. read-only)
query into a data deletion query.</p><h4 id=using-javascript-variables-as-bind-parameters>Using JavaScript variables as bind parameters <a href=/3.11/aql/common-errors/#using-javascript-variables-as-bind-parameters class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>There is also a template string generator function <code>aql</code> that can be used to safely
(and conveniently) built AQL queries using JavaScript variables and expressions. It
can be invoked as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>aql</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;@arangodb&#39;</span><span class=p>).</span><span class=nx>aql</span><span class=p>;</span> <span class=c1>// not needed in arangosh
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;some input value&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=nx>aql</span><span class=sb>`FOR doc IN collection
</span></span></span><span class=line><span class=cl><span class=sb>  FILTER doc.value == </span><span class=si>${</span><span class=nx>value</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  RETURN doc`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>Note that an ES6 template string is used for populating the <code>query</code> variable.
The string is assembled using the <code>aql</code> generator function which is bundled
with ArangoDB. The template string can contain references to JavaScript
variables or expressions via <code>${...}</code>. In the above example, the query
references a variable named <code>value</code>. The <code>aql</code> function generates an object
with two separate attributes: the query string, containing references to
bind parameters, and the actual bind parameter values.</p><p>Bind parameter names are automatically generated by the <code>aql</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;some input value&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>aql</span><span class=sb>`FOR doc IN collection FILTER doc.value == </span><span class=si>${</span><span class=nx>value</span><span class=si>}</span><span class=sb> RETURN doc`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span> <span class=o>:</span> <span class=s2>&#34;FOR doc IN collection FILTER doc.value == @value0 RETURN doc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bindVars&#34;</span> <span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value0&#34;</span> <span class=o>:</span> <span class=s2>&#34;some input value&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=using-bind-parameters-in-dynamic-queries>Using bind parameters in dynamic queries <a href=/3.11/aql/common-errors/#using-bind-parameters-in-dynamic-queries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>Bind parameters are helpful, so it makes sense to use them for handling the
dynamic values. You can even use them for queries that itself are highly
dynamic, for example with conditional <code>FILTER</code> and <code>LIMIT</code> parts.
Here&rsquo;s how to do this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Note: this example has a slight issue... hang on reading
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN collection&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>params</span> <span class=o>=</span> <span class=p>{</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>useFilter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>query</span> <span class=o>+=</span> <span class=s2>&#34; FILTER doc.value == @what&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span><span class=p>.</span><span class=nx>what</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>(</span><span class=s2>&#34;searchValue&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>useLimit</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// not quite right, see below
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>query</span> <span class=o>+=</span> <span class=s2>&#34; LIMIT @offset, @count&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span><span class=p>.</span><span class=nx>offset</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>(</span><span class=s2>&#34;offset&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span><span class=p>.</span><span class=nx>count</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>(</span><span class=s2>&#34;count&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>query</span> <span class=o>+=</span> <span class=s2>&#34; RETURN doc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>params</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>Note that in this example we&rsquo;re back to string concatenation, but without the
problem of the query being vulnerable to arbitrary modifications.</p><h4 id=input-value-validation-and-sanitation>Input value validation and sanitation <a href=/3.11/aql/common-errors/#input-value-validation-and-sanitation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>Still you should prefer to be paranoid, and try to detect invalid input values
as early as possible, at least before executing a query with them. This is
because some input parameters may affect the runtime behavior of queries
negatively or, when modified, may lead to queries throwing runtime errors
instead of returning valid results. This isn&rsquo;t something an attacker
should deserve.</p><p><code>LIMIT</code> is a good example for this: if used with a single argument, the
argument should be numeric. When <code>LIMIT</code> is given a string value, executing
the query will fail. You may want to detect this early and don&rsquo;t return an
HTTP 500 (as this would signal attackers that they were successful breaking
your application).</p><p>Another problem with <code>LIMIT</code> is that high <code>LIMIT</code> values are likely more
expensive than low ones, and you may want to disallow using <code>LIMIT</code> values
exceeding a certain threshold.</p><p>Here is what you could do in such cases:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=s2>&#34;FOR doc IN collection LIMIT @count RETURN doc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// some default value for limit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>params</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>count</span><span class=o>:</span> <span class=mi>100</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>useLimit</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>count</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>(</span><span class=s2>&#34;count&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// abort if value does not look like an integer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=nx>preg_match</span><span class=p>(</span><span class=sr>/^d+$/</span><span class=p>,</span> <span class=nx>count</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=s2>&#34;invalid count value!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// actually turn it into an integer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>params</span><span class=p>.</span><span class=nx>count</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>count</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span> <span class=c1>// turn into numeric value
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>params</span><span class=p>.</span><span class=nx>count</span> <span class=o>&lt;</span> <span class=mi>1</span> <span class=o>||</span> <span class=nx>params</span><span class=p>.</span><span class=nx>count</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// value is outside of accepted thresholds
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>throw</span> <span class=s2>&#34;invalid count value!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>_query</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>params</span><span class=p>).</span><span class=nx>toArray</span><span class=p>();</span></span></span></code></pre></div><p>This is a bit more complex, but that is a price you are likely willing to pay
for a bit of extra safety. In reality you may want to use a framework for
validation (such as <a href=https://www.npmjs.com/package/joi target=_blank rel="noopener noreferrer" class=link>joi</a>&nbsp;<i class="fas fa-external-link-alt"></i>
which comes bundled with ArangoDB) instead of writing your own checks all over
the place.</p><h4 id=bind-parameter-types>Bind parameter types <a href=/3.11/aql/common-errors/#bind-parameter-types class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h4><p>There are two types of bind parameters in AQL:</p><ul><li><p>Bind parameters for <strong>values</strong>:<br>Those are prefixed with a single <code>@</code> in AQL queries, and are specified
without the prefix when they get their value assigned. These bind parameters
can contain any valid JSON value.</p><p>Examples: <code>@what</code>, <code>@searchValue</code></p></li><li><p>Bind parameters for <strong>collections</strong>:<br>These are prefixed with <code>@@</code> in AQL queries, and are replaced with the name
of a collection. When the bind parameter value is assigned, the parameter
itself must be specified with a single <code>@</code> prefix. Only string values are
allowed for this type of bind parameters.</p><p>Examples: <code>@@collection</code>, <code>@@edgeColl</code></p></li></ul><p>The latter type of bind parameter is probably not used as often, and it should
not be used together with user input. Otherwise users may freely determine on
which collection your AQL queries will operate on (this might be a valid
use case, but normally it is extremely undesired).</p><h2 id=unexpected-long-running-queries>Unexpected long running queries <a href=/3.11/aql/common-errors/#unexpected-long-running-queries class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>Slow queries can have various reasons and be legitimate for queries with a high
computational complexity or if they touch a lot of data. Use the <em>Explain</em>
feature to inspect execution plans and verify that appropriate indexes are
utilized. Also check for mistakes such as references to the wrong variables.</p><p>A literal collection name, which is not part of constructs like <code>FOR</code>,
<code>UPDATE ... IN</code> etc., stands for an array of all documents of that collection
and can cause an entire collection to be materialized before further
processing. It should thus be avoided.</p><p>Check the execution plan for <code>/* all collection documents */</code> and verify that
it is intended. You should also see a warning if you execute such a query:</p><blockquote><p>collection &lsquo;coll&rsquo; used as expression operand</p></blockquote><p>For example, instead of:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>RETURN</span> <span class=n>coll</span><span class=p>[</span><span class=o>*</span> <span class=kr>LIMIT</span> <span class=mi>1</span><span class=p>]</span></span></span></code></pre></div><p>&mldr; with the execution plan &mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=n>Execution</span> <span class=n>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=n>Id</span>   <span class=n>NodeType</span>          <span class=n>Est</span><span class=p>.</span>   <span class=n>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=n>SingletonNode</span>        <span class=mi>1</span>   <span class=o>*</span> <span class=n>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=n>CalculationNode</span>      <span class=mi>1</span>     <span class=o>-</span> <span class=kd>LET</span> <span class=nl>#2</span> <span class=o>=</span> <span class=n>coll</span>   <span class=cm>/* all collection documents */</span><span class=p>[</span><span class=o>*</span> <span class=kr>LIMIT</span>  <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>   <span class=cm>/* v8 expression */</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=n>ReturnNode</span>           <span class=mi>1</span>     <span class=o>-</span> <span class=kr>RETURN</span> <span class=nl>#2</span></span></span></code></pre></div><p>&mldr; you can use the following equivalent query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>coll</span>
</span></span><span class=line><span class=cl>    <span class=kr>LIMIT</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>&mldr; with the (better) execution plan:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=n>Execution</span> <span class=n>plan</span><span class=o>:</span>
</span></span><span class=line><span class=cl> <span class=n>Id</span>   <span class=n>NodeType</span>                  <span class=n>Est</span><span class=p>.</span>   <span class=n>Comment</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span>   <span class=n>SingletonNode</span>                <span class=mi>1</span>   <span class=o>*</span> <span class=n>ROOT</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span>   <span class=n>EnumerateCollectionNode</span>     <span class=mi>44</span>     <span class=o>-</span> <span class=kr>FOR</span> <span class=n>doc</span> <span class=kr>IN</span> <span class=n>Characters</span>   <span class=cm>/* full collection scan */</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span>   <span class=n>LimitNode</span>                    <span class=mi>1</span>       <span class=o>-</span> <span class=kr>LIMIT</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span>   <span class=n>ReturnNode</span>                   <span class=mi>1</span>       <span class=o>-</span> <span class=kr>RETURN</span> <span class=n>doc</span></span></span></code></pre></div><p>Similarly, make sure you have not confused any variable names with collection
names by accident:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kd>LET</span> <span class=n>names</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;John&#34;</span><span class=p>,</span> <span class=s2>&#34;Mary&#34;</span><span class=p>,</span> <span class=o>..</span><span class=p>.]</span>
</span></span><span class=line><span class=cl><span class=c1>// supposed to refer to variable &#34;names&#34;, not collection &#34;Names&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>FOR</span> <span class=n>name</span> <span class=kr>IN</span> <span class=n>Names</span>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span></span></span></code></pre></div><p>You can set the startup option <code>--query.allow-collections-in-expressions</code> to
<em>false</em> to disallow collection names in arbitrary places in AQL expressions
to prevent such mistakes. Also see
<a href=/3.11/components/arangodb-server/options/#--queryallow-collections-in-expressions class=link>ArangoDB Server Query Options</a></p><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.11/aql/execution-and-performance/><i class="fas fa-chevron-left fa-fw"></i><p>Execution and Performance</p></a></span><span class=next><a class="nav nav-next link" href=/3.11/graphs/><p>Graphs</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.11/aql/common-errors.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#trailing-semicolons-in-query-strings>Trailing semicolons in query strings</a></div><div class=level-2><a href=#string-concatenation>String concatenation</a></div><div class=level-2><a href=#parameter-injection-vulnerability>Parameter injection vulnerability</a></div><div class=level-3><a href=#parameter-injection-examples>Parameter injection examples</a></div><div class=level-3><a href=#avoiding-parameter-injection>Avoiding parameter injection</a></div><div class=level-4><a href=#what-bind-parameters-are>What bind parameters are</a></div><div class=level-4><a href=#how-bind-parameters-are-used>How bind parameters are used</a></div><div class=level-4><a href=#using-javascript-variables-as-bind-parameters>Using JavaScript variables as bind parameters</a></div><div class=level-4><a href=#using-bind-parameters-in-dynamic-queries>Using bind parameters in dynamic queries</a></div><div class=level-4><a href=#input-value-validation-and-sanitation>Input value validation and sanitation</a></div><div class=level-4><a href=#bind-parameter-types>Bind parameter types</a></div><div class=level-2><a href=#unexpected-long-running-queries>Unexpected long running queries</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
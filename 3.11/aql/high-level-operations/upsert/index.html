<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743775370></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="An UPSERT operation either modifies an existing document, or creates a new document if it does not exist"><meta property="og:url" content="http://localhost/3.11/aql/high-level-operations/upsert/"><meta property="og:title" content="UPSERT operation in AQL"><meta property="og:type" content="website"><meta property="og:description" content="An UPSERT operation either modifies an existing document, or creates a new document if it does not exist"><meta name=docsearch:version content="3.11"><title>UPSERT operation in AQL | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743775370 defer></script>
<script src=/js/featherlight.min.js?1743775370 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743775370 defer></script>
<script src=/js/theme.js?1743775370 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.11"><a itemprop=item class=link href=/3.11/><span itemprop=name class=breadcrumb-entry>3.11.13</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="AQL"><a itemprop=item class=link href=/3.11/aql/><span itemprop=name class=breadcrumb-entry>AQL</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="High-level Operations"><a itemprop=item class=link href=/3.11/aql/high-level-operations/><span itemprop=name class=breadcrumb-entry>High-level Operations</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="UPSERT"><a itemprop=item class=link href=/3.11/aql/high-level-operations/upsert/><span itemprop=name class=breadcrumb-entry>UPSERT</span></a></li></ol></nav><article class=default><hgroup><h1><code>UPSERT</code> operation in AQL</h1><p class=lead>An <code>UPSERT</code> operation either modifies an existing document, or creates a new document if it does not exist</p></hgroup><p><code>UPSERT</code> looks up a single document that matches the provided example.
If there is no match, an insert operation is executed to create a
document. If a document is found, you can either update or replace the document.
These subtypes are called <strong>upsert</strong> (update or insert) and <strong>repsert</strong>
(replace or insert).</p><p>Each <code>UPSERT</code> operation is restricted to a single collection, and the
<a href=/3.11/concepts/data-structure/collections/#collection-names class=link>collection name</a> must not be dynamic.
Only a single <code>UPSERT</code> statement per collection is allowed per AQL query, and
it cannot be followed by read or write operations that access the same collection, by
traversal operations, or AQL functions that can read documents.</p><h2 id=syntax>Syntax <a href=/3.11/aql/high-level-operations/upsert/#syntax class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>The syntax for an upsert operation:</p><pre><code>UPSERT <em>searchExpression</em>
INSERT <em>insertExpression</em>
UPDATE <em>updateExpression</em>
IN <em>collection</em></code></pre><p>The syntax for a repsert operation:</p><pre><code>UPSERT <em>searchExpression</em>
INSERT <em>insertExpression</em>
REPLACE <em>updateExpression</em>
IN <em>collection</em></code></pre><p>Both variants can optionally end with an <code>OPTIONS { â€¦ }</code> clause.</p><p>When using the <code>UPDATE</code> variant of the <code>UPSERT</code> operation, the found document
is partially updated, meaning only the attributes specified in
<em>updateExpression</em> are updated or added. When using the <code>REPLACE</code> variant
of <code>UPSERT</code> (repsert), the found document is replaced with the content of
<em>updateExpression</em>.</p><p>Updating a document modifies the document&rsquo;s revision number with a server-generated value.
The system attributes <code>_id</code>, <code>_key</code>, and <code>_rev</code> cannot be updated, but <code>_from</code> and <code>_to</code>
can be modified.</p><p>The <em>searchExpression</em> contains the document to be looked for. It must be an
<strong>object literal</strong> (<code>UPSERT { &lt;key>: &lt;value>, ... } ...</code>) without dynamic
attribute names. In case no such document can be found in <em>collection</em>, a new
document is inserted into the collection as specified in the <em>insertExpression</em>.</p><p>In case at least one document in <em>collection</em> matches the <em>searchExpression</em>, it is
updated using the <em>updateExpression</em>. When more than one document in the collection
matches the <em>searchExpression</em>, it is undefined which of the matching documents is
updated. It is therefore often sensible to make sure by other means (such as unique
indexes, application logic etc.) that at most one document matches <em>searchExpression</em>.</p><p>The following query looks for a document in the <code>users</code> collection with a specific
<code>name</code> attribute value. If the document exists, its <em>logins</em> attribute is increased
by one. If it does not exist, a new document is inserted, consisting of the
attributes <code>name</code>, <code>logins</code>, and <code>dateCreated</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s1>&#39;superuser&#39;</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s1>&#39;superuser&#39;</span><span class=p>,</span> <span class=n>logins</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dateCreated</span><span class=o>:</span> <span class=nf>DATE_NOW</span><span class=p>()</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>logins</span><span class=o>:</span> <span class=bp>OLD</span><span class=p>.</span><span class=n>logins</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span></span></span></code></pre></div><p>Note that in the <code>UPDATE</code> case it is possible to refer to the previous version of the
document using the <code>OLD</code> pseudo-value.</p><h2 id=query-options>Query options <a href=/3.11/aql/high-level-operations/upsert/#query-options class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><h3 id=ignoreerrors><code>ignoreErrors</code> <a href=/3.11/aql/high-level-operations/upsert/#ignoreerrors class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The <code>ignoreErrors</code> option can be used to suppress query errors that may occur
when trying to violate unique key constraints.</p><h3 id=keepnull><code>keepNull</code> <a href=/3.11/aql/high-level-operations/upsert/#keepnull class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>When updating an attribute to the <code>null</code> value, ArangoDB does not remove the
attribute from the document but stores this <code>null</code> value. To remove attributes
in an update operation, set them to <code>null</code> and set the <code>keepNull</code> option to
<code>false</code>. This removes the attributes you specify but not any previously stored
attributes with the <code>null</code> value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;mary&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=s2>&#34;mary&#34;</span><span class=p>,</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;Mary&#34;</span><span class=p>,</span> <span class=n>notNeeded</span><span class=o>:</span> <span class=mi>123</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>foobar</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>notNeeded</span><span class=o>:</span> <span class=kc>null</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>IN</span> <span class=n>users</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>keepNull</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}</span></span></span></code></pre></div><p>If no document with the key <code>mary</code> exists, the above query creates such a user
document with a <code>notNeeded</code> attribute. If it exists already, it removes the
<code>notNeeded</code> attribute from the document and updates the <code>foobar</code> attribute
normally.</p><p>Only top-level attributes and sub-attributes can be removed this way
(e.g. <code>{ attr: { sub: null } }</code>) but not attributes of objects that are nested
inside of arrays (e.g. <code>{ attr: [ { nested: null } ] }</code>).</p><h3 id=mergeobjects><code>mergeObjects</code> <a href=/3.11/aql/high-level-operations/upsert/#mergeobjects class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The option <code>mergeObjects</code> controls whether object contents are
merged if an object attribute is present in both the <code>UPDATE</code> query and in the
to-be-updated document.</p><div class="box notices cstyle tip"><div class=box-content-container><div class=box-content><i class="fas fa-check"></i><div class=box-text>The default value for <code>mergeObjects</code> is <code>true</code>, so there is no need to specify it
explicitly.</div></div></div></div><h3 id=waitforsync><code>waitForSync</code> <a href=/3.11/aql/high-level-operations/upsert/#waitforsync class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>To make sure data are durable when an update query returns, there is the <code>waitForSync</code>
query option.</p><h3 id=ignorerevs><code>ignoreRevs</code> <a href=/3.11/aql/high-level-operations/upsert/#ignorerevs class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>In order to not accidentally update documents that have been written and updated since
you last fetched them you can use the option <code>ignoreRevs</code> to either let ArangoDB compare
the <code>_rev</code> value and only succeed if they still match, or let ArangoDB ignore them (default):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>i</span> <span class=kr>IN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>1000</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=nf>CONCAT</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=n>i</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>    <span class=kr>INSERT</span> <span class=p>{</span><span class=n>foobar</span><span class=o>:</span> <span class=kc>false</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>UPDATE</span> <span class=p>{</span><span class=n>_rev</span><span class=o>:</span> <span class=s2>&#34;1287623&#34;</span><span class=p>,</span> <span class=n>foobar</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>IN</span> <span class=n>users</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>ignoreRevs</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-content-container><div class=box-content><i class="fas fa-info-circle"></i><div class=box-text>You need to add the <code>_rev</code> value in the <em>updateExpression</em>. It is not used
within the <em>searchExpression</em>. Even worse, if you use an outdated <code>_rev</code> in the
<em>searchExpression</em>, <code>UPSERT</code> triggers the <code>INSERT</code> path instead of the
<code>UPDATE</code> path, because it has not found a document exactly matching the
<em>searchExpression</em>.</div></div></div></div><h3 id=exclusive><code>exclusive</code> <a href=/3.11/aql/high-level-operations/upsert/#exclusive class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The RocksDB engine does not require collection-level locks. Different write
operations on the same collection do not block each other, as
long as there are no <em>write-write conflicts</em> on the same documents. From an application
development perspective it can be desired to have exclusive write access on collections,
to simplify the development. Note that writes do not block reads in RocksDB.
Exclusive access can also speed up modification queries, because we avoid conflict checks.</p><p>Use the <code>exclusive</code> option to achieve this effect on a per query basis:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>FOR</span> <span class=n>i</span> <span class=kr>IN</span> <span class=mf>1</span><span class=o>..</span><span class=mi>1000</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>_key</span><span class=o>:</span> <span class=nf>CONCAT</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span> <span class=n>foobar</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>foobar</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>IN</span> <span class=n>users</span> <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>exclusive</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span></span></span></code></pre></div><h3 id=indexhint><code>indexHint</code> <a href=/3.11/aql/high-level-operations/upsert/#indexhint class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>The <code>indexHint</code> option is used as a hint for the document lookup
performed as part of the <code>UPSERT</code> operation, and can help in cases such as
<code>UPSERT</code> not picking the best index automatically.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>a</span><span class=o>:</span> <span class=mi>1234</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span> <span class=n>a</span><span class=o>:</span> <span class=mi>1234</span><span class=p>,</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;AB&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;ABC&#34;</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>myCollection</span>
</span></span><span class=line><span class=cl>  <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>indexHint</span><span class=o>:</span> <span class=s2>&#34;index_name&#34;</span> <span class=p>}</span></span></span></code></pre></div><p>The index hint is passed through to an internal <code>FOR</code> loop that is used for the
lookup. Also see <a href=/3.11/aql/high-level-operations/for/#indexhint class=link><code>indexHint</code> Option of the <code>FOR</code> Operation</a>.</p><p>Inverted indexes cannot be used for <code>UPSERT</code> lookups.</p><h3 id=forceindexhint><code>forceIndexHint</code> <a href=/3.11/aql/high-level-operations/upsert/#forceindexhint class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h3><p>Makes the index or indexes specified in <code>indexHint</code> mandatory if enabled. The
default is <code>false</code>. Also see
<a href=/3.11/aql/high-level-operations/for/#forceindexhint class=link><code>forceIndexHint</code> Option of the <code>FOR</code> Operation</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>a</span><span class=o>:</span> <span class=mi>1234</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>INSERT</span> <span class=p>{</span> <span class=n>a</span><span class=o>:</span> <span class=mi>1234</span><span class=p>,</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;AB&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s2>&#34;ABC&#34;</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>myCollection</span>
</span></span><span class=line><span class=cl>  <span class=kp>OPTIONS</span> <span class=p>{</span> <span class=n>indexHint</span><span class=o>:</span> <span class=err>â€¦</span> <span class=p>,</span> <span class=n>forceIndexHint</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}</span></span></span></code></pre></div><h2 id=returning-documents>Returning documents <a href=/3.11/aql/high-level-operations/upsert/#returning-documents class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p><code>UPSERT</code> statements can optionally return data. To do so, they need to be followed
by a <code>RETURN</code> statement (intermediate <code>LET</code> statements are allowed, too). These statements
can optionally perform calculations and refer to the pseudo-values <code>OLD</code> and <code>NEW</code>.
In case the upsert performed an insert operation, <code>OLD</code> has a value of <code>null</code>.
In case the upsert performed an update or replace operation, <code>OLD</code> contains the
previous version of the document, before update/replace.</p><p><code>NEW</code> is always populated. It contains the inserted document in case the
upsert performed an insert, or the updated/replaced document in case it performed an
update/replace.</p><p>This can also be used to check whether the upsert has performed an insert or an update
internally:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-aql data-lang=aql><span class=line><span class=cl><span class=kr>UPSERT</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s1>&#39;superuser&#39;</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=kr>INSERT</span> <span class=p>{</span> <span class=n>name</span><span class=o>:</span> <span class=s1>&#39;superuser&#39;</span><span class=p>,</span> <span class=n>logins</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=n>dateCreated</span><span class=o>:</span> <span class=nf>DATE_NOW</span><span class=p>()</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=kr>UPDATE</span> <span class=p>{</span> <span class=n>logins</span><span class=o>:</span> <span class=bp>OLD</span><span class=p>.</span><span class=n>logins</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}</span> <span class=kr>IN</span> <span class=n>users</span>
</span></span><span class=line><span class=cl><span class=kr>RETURN</span> <span class=p>{</span> <span class=n>doc</span><span class=o>:</span> <span class=bp>NEW</span><span class=p>,</span> <span class=n>type</span><span class=o>:</span> <span class=bp>OLD</span> <span class=o>?</span> <span class=s1>&#39;update&#39;</span> <span class=o>:</span> <span class=s1>&#39;insert&#39;</span> <span class=p>}</span></span></span></code></pre></div><h2 id=transactionality-and-limitations>Transactionality and Limitations <a href=/3.11/aql/high-level-operations/upsert/#transactionality-and-limitations class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><ul><li><p>On a single server, upserts are generally executed transactionally in an
all-or-nothing fashion.</p><p>For sharded collections in cluster deployments, the entire query and/or upsert
operation may not be transactional, especially if it involves different shards,
DB-Servers, or both.</p></li><li><p>Queries may execute intermediate transaction commits in case the running
transaction (AQL query) hits the specified size thresholds. This writes the
data that has been modified so far and it is not rolled back in case of a later
abort/rollback of the transaction.</p><p>Such <strong>intermediate commits</strong> can occur for <code>UPSERT</code> operations over all
documents of a large collection, for instance. This has the side-effect that
atomicity of this operation cannot be guaranteed anymore and ArangoDB cannot
guarantee that &ldquo;read your own writes&rdquo; in upserts work.</p><p>This is only an issue if you write a query where your search condition would
hit the same document multiple times, and only if you have large transactions.
You can adjust the behavior of the RocksDB storage engine by increasing the
<code>intermediateCommit</code> thresholds for data size and operation counts.</p></li><li><p>The lookup and the insert/update/replace parts are executed one after
another, so that other operations in other threads can happen in
between. This means if multiple <code>UPSERT</code> queries run concurrently, they
may all determine that the target document does not exist and then
create it multiple times!</p><p>Note that due to this gap between the lookup and insert/update/replace,
even with a unique index, duplicate key errors or conflicts can occur.
But if they occur, the application/client code can execute the same query
again.</p><p>To prevent this from happening, you should add a unique index to the lookup
attribute(s). Note that in the cluster a unique index can only be created if
it is equal to the shard key attribute of the collection or at least contains
it as a part.</p><p>An alternative to making an UPSERT statement work atomically is to use the
<code>exclusive</code> option to limit write concurrency for this collection to 1, which
helps avoiding conflicts but is bad for throughput!</p></li><li><p><code>UPSERT</code> operations do not observe their own writes correctly in cluster
deployments. They only do for OneShard databases with the <code>cluster-one-shard</code>
optimizer rule active.</p><p>If upserts in a query create new documents and would then semantically hit the
same documents again, the operation may incorrectly use the <code>INSERT</code> branch to
create more documents instead of the <code>UPDATE</code>/<code>REPLACE</code> branch to update the
previously created documents.</p><p>If upserts find existing documents for updating/replacing, you can access the
current document via the <code>OLD</code> pseudo-variable, but this may hold the initial
version of the document from before the query even if it has been modified
by <code>UPSERT</code> in the meantime.</p></li><li><p>The lookup attribute(s) from the search expression should be indexed in order
to improve the <code>UPSERT</code> performance. Ideally, the search expression contains the
shard key, as this allows the lookup to be restricted to a single shard.</p></li></ul><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.11/aql/high-level-operations/insert/><i class="fas fa-chevron-left fa-fw"></i><p>INSERT</p></a></span><span class=next><a class="nav nav-next link" href=/3.11/aql/high-level-operations/with/><p>WITH</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.11/aql/high-level-operations/upsert.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#syntax>Syntax</a></div><div class=level-2><a href=#query-options>Query options</a></div><div class=level-3><a href=#ignoreerrors><code>ignoreErrors</code></a></div><div class=level-3><a href=#keepnull><code>keepNull</code></a></div><div class=level-3><a href=#mergeobjects><code>mergeObjects</code></a></div><div class=level-3><a href=#waitforsync><code>waitForSync</code></a></div><div class=level-3><a href=#ignorerevs><code>ignoreRevs</code></a></div><div class=level-3><a href=#exclusive><code>exclusive</code></a></div><div class=level-3><a href=#indexhint><code>indexHint</code></a></div><div class=level-3><a href=#forceindexhint><code>forceIndexHint</code></a></div><div class=level-2><a href=#returning-documents>Returning documents</a></div><div class=level-2><a href=#transactionality-and-limitations>Transactionality and Limitations</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>
<!doctype html><html lang=en><head><link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css rel=stylesheet></noscript><link href=/css/featherlight.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css rel=stylesheet></noscript><link href=/css/nucleus.css rel=stylesheet><link href=/css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css rel=stylesheet></noscript><link href=/css/theme.css rel=stylesheet><link href=/css/theme-relearn-light.css rel=stylesheet id=variant-style><link href=/css/print.css rel=stylesheet media=print><script src=/js/variant.js?1743774193></script>
<script>var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="",window.T_Copied_to_clipboard="",window.T_Copy_link_to_clipboard="",window.T_Link_copied_to_clipboard="",baseUriFull="http://localhost/",window.variants&&variants.init(["relearn-light"])</script><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta itemprop=description property="description" content="ArangoDB is a scalable graph database system with native support for other data models and a built-in search engine, for the cloud and on-premises"><meta property="og:url" content="http://localhost/3.11/develop/foxx-microservices/guides/authentication-and-sessions/"><meta property="og:title" content="Authentication in Foxx services"><meta property="og:type" content="website"><meta property="og:description" content="ArangoDB is a scalable graph database system with native support for other data models and a built-in search engine, for the cloud and on-premises"><meta name=docsearch:version content="3.11"><title>Authentication in Foxx services | ArangoDB Documentation</title><link href=/images/favicon.png rel=icon type=image/png><script src=/js/jquery.min.js></script>
<script src=/js/clipboard.min.js?1743774193 defer></script>
<script src=/js/featherlight.min.js?1743774193 defer></script>
<script>var versions=[{alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"},{alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"},{alias:"3.11",deprecated:!1,name:"3.11",version:"3.11.13"},{alias:"3.10",deprecated:!0,name:"3.10",version:"3.10.14"}]</script><script>var develVersion={alias:"devel",deprecated:!1,name:"3.13",version:"3.13.0"}</script><script>var stableVersion={alias:"stable",deprecated:!1,name:"3.12",version:"3.12.4"}</script><script src=/js/codeblocks.js?1743774193 defer></script>
<script src=/js/theme.js?1743774193 defer></script></head><body><noscript>You need to enable JavaScript to use the ArangoDB documentation.</noscript><div id=page-wrapper class=page_content_splash style=height:auto;opacity:0><section id=page-main><section class=page-container id=page-container><header id=header style="transition:.5s padding ease-out,.15s" class="zn_header_white header-splash-new nav-down header-splash-wrap header1"><div class=header-block-left><div class=mobile-menu-toggle><button id=sidebar-toggle-navigation onclick=showSidebarHandler()><svg width="1.33em" height="1.33em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div><div class=version-logo-container><div class="logo-container hasinfocard_img arangodb-logo-large"><div class=logo><a href=https://www.arangodb.com/><img src=/images/logo_main.png alt=ArangoDB title></a></div></div><div class=arangodb-logo-small><a href=https://arangodb.com/><img alt="ArangoDB Logo" src=/images/ArangoDB_Logo_White_small.png></a></div></div></div><div class=container-right style=display:hidden></div><div class=search-and-version-container><a href=# class="home-link is-current" aria-label="Go to home page" onclick=goToHomepage(event)></a><div id=searchbox></div><script type=text/javascript>const SCRIPT_SRC="https://unpkg.com/@inkeep/widgets-embed@0.2.290/dist/embed.js";function loadAndInitializeInkeep(){if(document.querySelector(`script[src="${SCRIPT_SRC}]"`))return;const e=document.createElement("script");e.type="module",e.src=SCRIPT_SRC,e.onload=initializeInkeep,document.head.appendChild(e)}function initializeInkeep(){const e=Inkeep({integrationId:"clo4lx6jk0000s601cp21x2ok",apiKey:"13b4e56966a76e86c6ff359cd795ee6a0412f751d75d6383",organizationId:"org_HGBkkzGAa4KeGJGh",organizationDisplayName:"ArangoDB",primaryBrandColor:"#80a54d",stringReplacementRules:[{matchingRule:{ruleType:"Substring",string:"Arangograph"},replaceWith:"ArangoGraph"},{matchingRule:{ruleType:"Substring",string:"Aql"},replaceWith:"AQL"},{matchingRule:{ruleType:"Substring",string:"Arangodb"},replaceWith:"ArangoDB"}],customCardSettings:[{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arango.qubitpi.org"}},searchTabLabel:"Official Docs"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"developer.arangodb.com"}},searchTabLabel:"Developer Hub"},{filters:{UrlMatch:{ruleType:"PartialUrl",partialUrl:"arangodb.com"}},searchTabLabel:"Home"}]}),t=e.embed({componentType:"ChatButton",properties:{stylesheetUrls:["/css/fonts.css"],fixedPositionXOffset:"52px",baseSettings:{theme:{primaryColors:{textColorOnPrimary:"white"},tokens:{fonts:{body:"'Inter'",heading:"'Inter'"},zIndex:{overlay:1e4,modal:11e3,popover:12e3,skipLink:13e3,toast:14e3,tooltip:15e3}}}},aiChatSettings:{botAvatarSrcUrl:"/images/ArangoDB_Logo_White_small.png",quickQuestions:["What can you do with AQL that is not feasible with SQL?","How do I search for objects within arrays?","Where can I deploy my ArangoDB instance?"],getHelpCallToActions:[{icon:{builtIn:"FaSlack"},name:"Slack",url:"https://arangodb-community.slack.com/"}]},searchSettings:{tabSettings:{isAllTabEnabled:!1,alwaysDisplayedTabs:["Official Docs","Developer Hub","Home"]}}}})}loadAndInitializeInkeep()</script><div class=version-selector><select id=arangodb-version onchange=changeVersion()><option value=3.13>3.13</option><option value=3.12>3.12</option><option value=3.11>3.11</option><option value=3.10>3.10</option><option value=3.9>3.9</option><option value=3.8>3.8</option></select></div></div></header><iframe src=/nav.html title=description id=menu-iframe class="menu-iframe active" style=opacity:0></iframe><div class=container-main><div class=row-main><nav id=breadcrumbs><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3.11"><a itemprop=item class=link href=/3.11/><span itemprop=name class=breadcrumb-entry>3.11.13</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Develop"><a itemprop=item class=link href=/3.11/develop/><span itemprop=name class=breadcrumb-entry>Develop</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Foxx Microservices"><a itemprop=item class=link href=/3.11/develop/foxx-microservices/><span itemprop=name class=breadcrumb-entry>Foxx Microservices</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Guides"><a itemprop=item class=link href=/3.11/develop/foxx-microservices/guides/><span itemprop=name class=breadcrumb-entry>Guides</span></a>
<i class="fas fa-chevron-right fa-fw"></i></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="Authentication and sessions"><a itemprop=item class=link href=/3.11/develop/foxx-microservices/guides/authentication-and-sessions/><span itemprop=name class=breadcrumb-entry>Authentication and sessions</span></a></li></ol></nav><article class=default><hgroup><h1>Authentication in Foxx services</h1></hgroup><p>Foxx provides the <a href=/3.11/develop/foxx-microservices/reference/related-modules/authentication/ class=link>auth module</a> to implement
basic password verification and hashing but is not very secure unless using
the (very slow) PBKDF2 algorithm. Alternatively you can use the
<a href=/3.11/develop/foxx-microservices/reference/related-modules/oauth-1-0a/ class=link>OAuth 1.0a</a> or
<a href=/3.11/develop/foxx-microservices/reference/related-modules/oauth-2-0/ class=link>OAuth 2.0</a> modules to offload identity
management to a trusted provider (e.g. Facebook, GitHub, Google or Twitter).</p><p>The <a href=/3.11/develop/foxx-microservices/reference/sessions-middleware/ class=link>session middleware</a> provides a mechanism
for adding session logic to your service, using e.g. a collection or
JSON Web Tokens to store the sessions between requests.</p><p>With these building blocks you can implement your own session-based
authentication.</p><h2 id=implementing-session-authentication>Implementing session authentication <a href=/3.11/develop/foxx-microservices/guides/authentication-and-sessions/#implementing-session-authentication class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>In this example we&rsquo;ll use two collections: a <code>users</code> collection to store the
user objects with names and credentials, and a <code>sessions</code> collection to store
the session data. We&rsquo;ll also make sure usernames are unique
by adding a hash index:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;use strict&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>db</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collectionName</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>db</span><span class=p>.</span><span class=nx>_collection</span><span class=p>(</span><span class=nx>users</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>_createDocumentCollection</span><span class=p>(</span><span class=nx>users</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collectionName</span><span class=p>(</span><span class=s2>&#34;sessions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>db</span><span class=p>.</span><span class=nx>_collection</span><span class=p>(</span><span class=nx>sessions</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>db</span><span class=p>.</span><span class=nx>_createDocumentCollection</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>).</span><span class=nx>ensureIndex</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;hash&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>fields</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Next you should create a sessions middleware that uses the <code>sessions</code>
collection and the &ldquo;cookie&rdquo; transport in a separate file, and add it
to the service router:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// in util/sessions.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s2>&#34;use strict&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sessionsMiddleware</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/foxx/sessions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=nx>sessionsMiddleware</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>storage</span><span class=o>:</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;sessions&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>transport</span><span class=o>:</span> <span class=s2>&#34;cookie&#34;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>sessions</span><span class=p>;</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// in your main file
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./util/sessions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span></span></span></code></pre></div><p>You&rsquo;ll want to be able to use the authenticator throughout multiple parts
of your service so it&rsquo;s best to create it in a separate module and export it
so we can import it anywhere we need it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;use strict&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createAuth</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/foxx/auth&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>auth</span> <span class=o>=</span> <span class=nx>createAuth</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>auth</span><span class=p>;</span></span></span></code></pre></div><p>If you want, you can now use the authenticator to help create an initial user
in the setup script. Note we&rsquo;re hardcoding the password here but you could
make it configurable via a
<a href=/3.11/develop/foxx-microservices/reference/configuration/ class=link>service configuration option</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>auth</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./util/auth&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>users</span><span class=p>.</span><span class=nx>firstExample</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span> <span class=p>}))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>users</span><span class=p>.</span><span class=nx>save</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span><span class=o>:</span> <span class=nx>auth</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=s2>&#34;hunter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can now put the two together to create a login route:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>auth</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./util/auth&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>joi</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;joi&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createRouter</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@arangodb/foxx/router&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>router</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/login&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>users</span><span class=p>.</span><span class=nx>firstExample</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>valid</span> <span class=o>=</span> <span class=nx>auth</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Pretend to validate even if no user was found
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>user</span> <span class=o>?</span> <span class=nx>user</span><span class=p>.</span><span class=nx>password</span> <span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>      <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>password</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>valid</span><span class=p>)</span> <span class=nx>res</span><span class=p>.</span><span class=k>throw</span><span class=p>(</span><span class=s2>&#34;unauthorized&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Log the user in using the key
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// because usernames might change
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>uid</span> <span class=o>=</span> <span class=nx>user</span><span class=p>.</span><span class=nx>_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>sessionStorage</span><span class=p>.</span><span class=nx>save</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>body</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>joi</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=nx>joi</span><span class=p>.</span><span class=nx>string</span><span class=p>().</span><span class=nx>required</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>password</span><span class=o>:</span> <span class=nx>joi</span><span class=p>.</span><span class=nx>string</span><span class=p>().</span><span class=nx>required</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>required</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span></span></span></code></pre></div><p>To provide information about the authenticated user we can look up
the session user:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/me&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>users</span><span class=p>.</span><span class=nb>document</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=k>throw</span><span class=p>(</span><span class=s2>&#34;not found&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>To log a user out we can remove the user from the session:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/logout&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>uid</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>uid</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>sessionStorage</span><span class=p>.</span><span class=nx>save</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=s2>&#34;no content&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Finally when using the collection-based session storage, it&rsquo;s a good idea to
clean up expired sessions in a script which we can periodically call via an
external tool like <code>cron</code> or a <a href=/3.11/develop/foxx-microservices/reference/related-modules/queues/ class=link>Foxx queue</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;use strict&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./util/sessions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>prune</span><span class=p>();</span></span></span></code></pre></div><h2 id=using-arangodb-authentication>Using ArangoDB authentication <a href=/3.11/develop/foxx-microservices/guides/authentication-and-sessions/#using-arangodb-authentication class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>When using HTTP Basic authentication, ArangoDB will set the <code>arangoUser</code>
attribute of the <a href=/3.11/develop/foxx-microservices/reference/routers/request/ class=link>request object</a> if the
credentials match a valid ArangoDB user for the database.</p><p><strong>Note</strong>: Although the presence and value of this attribute can be used to
implement a low-level authentication mechanism this is only useful if your
service is only intended to be used by developers who already have access to
the HTTP API or the administrative web interface.</p><p>Example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/me&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>arangoUser</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>arangoUser</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=k>throw</span><span class=p>(</span><span class=s2>&#34;not found&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><h2 id=alternative-sessions-implementation>Alternative sessions implementation <a href=/3.11/develop/foxx-microservices/guides/authentication-and-sessions/#alternative-sessions-implementation class=header-link onclick=copyURI(event)><span></span><i class="fa fa-link"></i></a></h2><p>If you need more control than the sessions middleware provides,
you can also create a basic session system with a few lines of code yourself:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;use strict&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;sessions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// This is the secret string used to sign cookies
</span></span></span><span class=line><span class=cl><span class=c1>// you probably don&#39;t want to hardcode this.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>secret</span> <span class=o>=</span> <span class=s2>&#34;some secret string&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// First read the session cookie if present
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>sid</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s2>&#34;sid&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>secret</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>sid</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Try to find a matching session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>req</span><span class=p>.</span><span class=nx>session</span> <span class=o>=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nb>document</span><span class=p>(</span><span class=nx>sid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// No session found, cookie is invalid
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sid</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Clear the cookie so it will be discarded
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s2>&#34;sid&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>ttl</span><span class=o>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>secret</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Continue handling the request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Do this even if the request threw
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>sid</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sync the session&#39;s changes to the db
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>sessions</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>sid</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Create a new session with a new key
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>sid</span> <span class=o>=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nx>save</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>).</span><span class=nx>_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Set or update the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s2>&#34;sid&#34;</span><span class=p>,</span> <span class=nx>sid</span><span class=p>,</span> <span class=p>{</span> <span class=nx>ttl</span><span class=o>:</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span><span class=p>,</span> <span class=nx>secret</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sid</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// The request handler explicitly cleared
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// the session, so we need to delete it
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sessions</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=nx>sid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// And clear the cookie too
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s2>&#34;sid&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>ttl</span><span class=o>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>secret</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><nav class=pagination><span class=prev><a class="nav nav-prev link" href=/3.11/develop/foxx-microservices/guides/using-webpack-with-foxx/><i class="fas fa-chevron-left fa-fw"></i><p>Using Webpack with Foxx</p></a></span><span class=next><a class="nav nav-next link" href=/3.11/develop/foxx-microservices/guides/linking-services-together/><p>Linking services together</p><i class="fas fa-chevron-right fa-fw"></i></a></span></nav></article><div class=toc-container><a class=edit-page aria-label href=https://github.com/arangodb/docs-hugo/edit/main/site/content/3.11/develop/foxx-microservices/guides/authentication-and-sessions.md target=_blank><i class="fab fa-fw fa-github edit-page-icon"></i></a><div class=toc><div class=toc-content><div class=toc-header><p>On this page</p></div><nav id=TableOfContents><div class=level-2><a href=#implementing-session-authentication>Implementing session authentication</a></div><div class=level-2><a href=#using-arangodb-authentication>Using ArangoDB authentication</a></div><div class=level-2><a href=#alternative-sessions-implementation>Alternative sessions implementation</a></div></nav></div></div></div></div></div></section></section></div><button class="back-to-top hidden" onclick=goToTop(event) href=#><i class="fa fa-arrow-up"></i></button><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script type=text/javascript>window.setupDocSearch=function(e){if(!window.docsearch)return;docsearch({appId:"OK3ZBQ5982",apiKey:"500c85ccecb335d507fe4449aed12e1d",indexName:"arangodbdocs",insights:!0,container:"#searchbox",debug:!1,maxResultsPerGroup:10,searchParameters:{facetFilters:[`version:${e}`]}})}</script></body></html>